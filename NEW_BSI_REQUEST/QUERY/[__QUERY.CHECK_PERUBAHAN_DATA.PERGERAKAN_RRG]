DECLARE @PERIODE_DATA DATE = '2020-04-01'
INSERT INTO [CHECK.PERUBAHAN_DATA.PERGERAKAN_RRG]
SELECT
	[NEXT].[PERIODE_DATA] AS [PERIODE_PERUBAHAN]
	,[BASE].NOLOAN
	,[BASE].NOMORCIF
	,[BASE].[NAMANASABAH]
	,[BASE].[KODEOUTLET]
	,[NEXT].[KODEOUTLET] AS [KODEOUTLET_BARU]
	,[BASE].[DIVISI]
	,[NEXT].[DIVISI] AS [DIVISI_BARU]
	,[BASE].[PRODUK]
	,[NEXT].[PRODUK] AS [PRODUK_BARU]
	,[BASE].[PRODUK_DETAIL]
	,[NEXT].[PRODUK_DETAIL] AS [PRODUK_DETAIL_BARU]
	,CASE
		WHEN COALESCE([BASE].[DIVISI], 'X') != COALESCE([NEXT].[DIVISI], 'X') THEN 'DIVISI BERUBAH'
		WHEN COALESCE([BASE].[PRODUK], 'X') != COALESCE([NEXT].[PRODUK], 'X') THEN 'PRODUK BERUBAH'
		WHEN COALESCE([BASE].[PRODUK_DETAIL], 'X') != COALESCE([NEXT].[PRODUK_DETAIL], 'X') THEN 'PRODUK_DETAIL BERUBAH'
		WHEN COALESCE([BASE].[KODEOUTLET], 'X') != COALESCE([NEXT].[KODEOUTLET], 'X') THEN 'OUTLET BERUBAH'
	END AS [FLAG_PERUBAHAN]
FROM
(
	SELECT
		*
	FROM [dbo].[TABEL_MUTASI_LOAN_RRG_EDIT]
	WHERE PERIODE_DATA = EOMONTH(@PERIODE_DATA)
) [BASE]
LEFT JOIN 
(
	SELECT
		*
	FROM [dbo].[TABEL_MUTASI_LOAN_RRG_EDIT]
	WHERE PERIODE_DATA = EOMONTH(DATEADD(MONTH, 1, @PERIODE_DATA))
) [NEXT]
	ON [BASE].NOLOAN = [NEXT].NOLOAN
	AND [BASE].NOMORCIF = [NEXT].NOMORCIF
WHERE
	[NEXT].[NOLOAN] IS NOT NULL
	AND
	(
		COALESCE([BASE].DIVISI, 'X') != COALESCE([NEXT].DIVISI, 'X')
		OR COALESCE([BASE].PRODUK, 'X') != COALESCE([NEXT].PRODUK, 'X')
		OR COALESCE([BASE].PRODUK_DETAIL, 'X') != COALESCE([NEXT].PRODUK_DETAIL, 'X')
		OR COALESCE([BASE].KODEOUTLET, 'X') != COALESCE([NEXT].KODEOUTLET, 'X')
	)
