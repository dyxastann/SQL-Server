CREATE PROCEDURE [dbo].[sp_procc_dataget_rekap_noloan]
	@TGL_DATA AS VARCHAR(MAX) = 'CURRENT'
AS
BEGIN
	PRINT(CONCAT('GENERATE REKAP TANGGAL AKTIF PER ', @TGL_DATA));
	DECLARE @sql_query nvarchar(max), @T bit = 0;
	CREATE TABLE #TB_HC_CURRENT (
		LEGACY VARCHAR(255)
		,FICMISDATE DATE
		,NOLOAN VARCHAR(255)
		,NOMORCIF VARCHAR(255)
		,NAMANASABAH VARCHAR(255)
		,KODECABANGBARU VARCHAR(255)
		,DIVISI VARCHAR(255)
		,OSPOKOKCONVERSION FLOAT(53)
	);

	CREATE TABLE #TB_BNIS_CURRENT (
		LEGACY VARCHAR(255)
		,FICMISDATE DATE
		,NOLOAN VARCHAR(255)
		,NOMORCIF VARCHAR(255)
		,NAMANASABAH VARCHAR(255)
		,KODECABANGBARU VARCHAR(255)
		,DIVISI VARCHAR(255)
		,OSPOKOKCONVERSION FLOAT(53)
	);

	CREATE TABLE #TB_BRIS_CURRENT (
		LEGACY VARCHAR(255)
		,FICMISDATE DATE
		,NOLOAN VARCHAR(255)
		,NOMORCIF VARCHAR(255)
		,NAMANASABAH VARCHAR(255)
		,KODECABANGBARU VARCHAR(255)
		,DIVISI VARCHAR(255)
		,OSPOKOKCONVERSION FLOAT(53)
	);

	CREATE TABLE #TB_BSM_CURRENT (
		LEGACY VARCHAR(255)
		,FICMISDATE DATE
		,NOLOAN VARCHAR(255)
		,NOMORCIF VARCHAR(255)
		,NAMANASABAH VARCHAR(255)
		,KODECABANGBARU VARCHAR(255)
		,DIVISI VARCHAR(255)
		,OSPOKOKCONVERSION FLOAT(53)
	);

	IF(@TGL_DATA = 'CURRENT' OR @TGL_DATA NOT LIKE '[1-2][0-9][0-9][0-9]-[0-1][0-9]-[0-3][0-9]%')
	BEGIN
		set @TGL_DATA = (
		SELECT
			MAX(TGL_CURRENT) AS TGL_CURRENT
		FROM
		(
			SELECT
				MAX(TRY_CAST(FILE_DATE AS DATE)) AS TGL_CURRENT
			FROM
			[PORTOFOLIO_ONBS.SOURCE.BNIS.HASANAH_CARD]
			
			UNION

			SELECT
				MAX(TRY_CAST(TANGGAL_DATA AS DATE)) AS TGL_CURRENT
			FROM
			[PORTOFOLIO_ONBS.SOURCE.BNIS.LOAN_DAILY]
			
			UNION

			SELECT
				MAX(TRY_CAST(TANGGAL AS DATE)) AS TGL_CURRENT
			FROM
			[PORTOFOLIO_ONBS.SOURCE.BRIS.LOAN_DAILY]

			UNION

			SELECT
				MAX(TRY_CAST(FICMISDATE AS DATE)) AS TGL_CURRENT
			FROM
			[PORTOFOLIO_ONBS.SOURCE.BSM.LOAN_DAILY]
		) [TGL]
	)
		PRINT('EKSEKUSI DATA HASANAH CARD CURRENT!');
		INSERT INTO #TB_HC_CURRENT
		SELECT
			--[CURRENT].LEGACY
			'BNIS' AS LEGACY
			,COALESCE([CURRENT].FILE_DATE, @TGL_DATA) AS FICMISDATE
			,[CURRENT].CARDNO AS NOLOAN
			,[CURRENT].CUSTNO AS NOMORCIF
			,[CURRENT].SHORT_NAME AS NAMALENGKAP
			,'88400' AS KODECABANGBARU
			,'Hasanah Card' AS DIVISI
			,[CURRENT].POKOK AS OSPOKOKCONVERSION
		FROM [PORTOFOLIO_ONBS.SOURCE.BNIS.HASANAH_CARD] [CURRENT]
		WHERE TRY_CAST([CURRENT].CURRBAL AS FLOAT) > 0
		AND ([CURRENT].PB IN ('B', 'C', 'D', 'E', 'F', 'H', 'J', 'L', 'M', 'N', 'P', 'Q', 'T', 'U', 'W', 'Y') OR [CURRENT].PB IS NULL)
		AND [CURRENT].POSTFLG IN ('PP', 'SP')
		AND TRY_CAST([CURRENT].FILE_DATE AS DATE) IS NOT NULL;

		PRINT('EKSEKUSI DATA BNIS CURRENT!');
		INSERT INTO #TB_BNIS_CURRENT
		SELECT
			--a.LEGACY
			'BNIS' AS LEGACY
			,COALESCE([SOURCE].TANGGAL_DATA, @TGL_DATA) AS FICMISDATE
			,[SOURCE].NO_REKG
			,[SOURCE].CIF_NO
			,[SOURCE].NAMA_DEBITUR
			,CONCAT(dbo.fx_ndigit_code([SOURCE].KODE_CABANG, 3), dbo.fx_ndigit_code([SOURCE].SUB_KODE, 2)) AS KODECABANGBARU
			,COALESCE(
				CASE
				WHEN [SOURCE].SUB_NAME = 'DIVISI KOMERSIAL (CRD)' THEN 'CB2G'
				WHEN [SOURCE].SUB_NAME = 'MIDDLE ENTERPRISE DIVISION (MID)' THEN 'CMG'
				WHEN [SOURCE].SUB_NAME = 'HUMAN CAPITAL DIVISION (HCD)' THEN 'CFG'
				ELSE NULL
				END
				,[ADJUSTMENT.BNI_LOAN_PURPOSE_NAME].[Divisi BSI]
				,[ADJUSTMENT.SEGMEN_BY_LD].[Divisi BSI]
				,
				CASE
				WHEN [SOURCE].BNI_LOAN_PURPOSE_NAME = 'WUS' AND [SOURCE].MAKS_KREDIT_IDR >= 200000000 THEN 'BBG'
				WHEN [SOURCE].BNI_LOAN_PURPOSE_NAME = 'WUS' AND [SOURCE].MAKS_KREDIT_IDR < 200000000 THEN 'MBG'
				WHEN [SOURCE].BNI_LOAN_PURPOSE_NAME = 'BFM / FAP' AND [SOURCE].MAKS_KREDIT_IDR >= 25000000 THEN 'BBG'
				WHEN [SOURCE].BNI_LOAN_PURPOSE_NAME = 'BFM / FAP' AND [SOURCE].MAKS_KREDIT_IDR < 25000000 THEN 'BBG'
				WHEN [SOURCE].BNI_LOAN_PURPOSE_NAME = 'Kafalah' AND [SOURCE].KODE_CABANG = '800' THEN 'CB2G'
				WHEN [SOURCE].BNI_LOAN_PURPOSE_NAME = 'Kafalah' AND [SOURCE].KODE_CABANG != '800' THEN 'CFG'
				WHEN [SOURCE].BNI_LOAN_PURPOSE_NAME = 'KUR KECIL IB HASANAH' AND [SOURCE].MAKS_KREDIT_IDR >= 125000000 THEN 'BBG'
				WHEN [SOURCE].BNI_LOAN_PURPOSE_NAME = 'KUR KECIL IB HASANAH' AND [SOURCE].MAKS_KREDIT_IDR < 125000000 THEN 'MBG'
				ELSE [ASUMSI_PRODUK].ASUMSI_DIVISI
				END
				)
				 AS DIVISI
			,[SOURCE].BAKI_DEBET_IDR
		FROM [PORTOFOLIO_ONBS.SOURCE.BNIS.LOAN_DAILY] [SOURCE]
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.BNIS.SEGMEN_BY_LD] [ADJUSTMENT.SEGMEN_BY_LD] ON [ADJUSTMENT.SEGMEN_BY_LD].NOLOAN = [SOURCE].NO_REKG
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.BNIS.BNI_LOAN_PURPOSE_NAME] [ADJUSTMENT.BNI_LOAN_PURPOSE_NAME] ON [ADJUSTMENT.BNI_LOAN_PURPOSE_NAME].SOURCE = [SOURCE].BNI_LOAN_PURPOSE_NAME
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.BNIS.ASUMSI_PRODUK] [ASUMSI_PRODUK] ON dbo.fx_ndigit_code([SOURCE].ACCOUNT_TYPE, 4) = [ASUMSI_PRODUK].ACCOUNT_TYPE AND dbo.fx_ndigit_code([SOURCE].SUB_CATEGORY, 4) = [ASUMSI_PRODUK].SUB_CATEGORY AND dbo.fx_ndigit_code([SOURCE].BNI_LOAN_PURPOSE_CD, 3) = [ASUMSI_PRODUK].BNI_LOAN_PURPOSE_CD
		WHERE TRY_CAST([SOURCE].TANGGAL_DATA AS DATE) IS NOT NULL;

		PRINT('EKSEKUSI DATA BRIS CURRENT!');
		INSERT INTO #TB_BRIS_CURRENT
		SELECT
			--a.LEGACY
			'BRIS' AS LEGACY
			,COALESCE([SOURCE].TANGGAL, @TGL_DATA) AS FICMISDATE
			,[SOURCE].NO_LD AS NOLOAN
			,[SOURCE].CIF_NO AS NOMORCIF
			,[SOURCE].NAMA_NASABAH AS NAMALENGKAP
			,[SOURCE].KODE_UKER AS KODECABANGBARU
			,CASE
				WHEN [SOURCE].SEGMENTASI = 'KONSUMER' AND [SOURCE].KODE_PRODUCT = '700' THEN 'PWG'
				ELSE [MAPPING.SEGMENTASI].DIVISI
			END AS DIVISI
			,COALESCE([SOURCE].SISA_POKOK, 0)+COALESCE([SOURCE].TUNGGAKAN_POKOK, 0) AS OSPOKOKCONVERSION
		FROM [PORTOFOLIO_ONBS.SOURCE.BRIS.LOAN_DAILY] [SOURCE]
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.BRIS.SEGMENTASI] [MAPPING.SEGMENTASI] ON [MAPPING.SEGMENTASI].SOURCE = [SOURCE].SEGMENTASI
		WHERE TRY_CAST([SOURCE].TANGGAL AS DATE) IS NOT NULL;;

		PRINT('EKSEKUSI DATA BSM CURRENT!');
		INSERT INTO #TB_BSM_CURRENT
			SELECT
				--LEGACY
				'BSM' AS LEGACY
				,COALESCE(FICMISDATE, @TGL_DATA) AS FICMISDATE
				,NOLOAN
				,NOMORCIF
				,NAMALENGKAP
				,KODECABANGBARU
				,DIVISI
				,TRY_CAST(OSPOKOKCONVERSION AS FLOAT) AS OSPOKOKCONVERSION
			FROM [PORTOFOLIO_ONBS.SOURCE.BSM.LOAN_DAILY]
			WHERE TRY_CAST(FICMISDATE AS DATE) IS NOT NULL;

		PRINT('EKSEKUSI DATA JFAST CURRENT!');
		INSERT INTO #TB_BSM_CURRENT
			SELECT
				--LEGACY
				'BSM' AS LEGACY
				,COALESCE(FICMISDATE, @TGL_DATA) AS FICMISDATE
				,NOLOAN
				,NOMORCIF
				,NAMALENGKAP
				,KODECABANGBARU
				,DIVISI
				,TRY_CAST(OSPOKOKCONVERSION AS FLOAT) AS OSPOKOKCONVERSION
			FROM [PORTOFOLIO_ONBS.SOURCE.BSM.IFOS_JFAST]
			WHERE TRY_CAST(FICMISDATE AS DATE) IS NOT NULL;

		IF EXISTS
			(
				SELECT
					*
				FROM
				#TB_HC_CURRENT
				
				UNION

				SELECT
					*
				FROM #TB_BNIS_CURRENT
				
				UNION

				SELECT
					*
				FROM #TB_BRIS_CURRENT
				
				UNION

				SELECT
					*
				FROM #TB_BSM_CURRENT
			)
		BEGIN
			SET @T = 1;
		END
	END
	ELSE
	BEGIN

		IF EXISTS (SELECT name FROM [NEW_BSI_STORAGE].sys.objects WHERE type_desc = 'USER_TABLE' AND name = CONCAT('BNIS.HASANAH_CARD.', @TGL_DATA))
		BEGIN
			PRINT(CONCAT('EKSEKUSI DATA HASANAH CARD TANGGAL ', @TGL_DATA, '!'));
			SET @sql_query = CONCAT('INSERT INTO #TB_HC_CURRENT
		SELECT
			--[CURRENT].LEGACY
			''BNIS'' AS LEGACY
			,COALESCE([CURRENT].FILE_DATE, @TGL_DATA) AS FICMISDATE
			,[CURRENT].CARDNO AS NOLOAN
			,[CURRENT].CUSTNO AS NOMORCIF
			,[CURRENT].SHORT_NAME AS NAMALENGKAP
			,''88400'' AS KODECABANGBARU
			,''Hasanah Card'' AS DIVISI
			,[CURRENT].POKOK AS OSPOKOKCONVERSION
		FROM [NEW_BSI_STORAGE].dbo.[BNIS.HASANAH_CARD.', @TGL_DATA, '] [CURRENT]
		WHERE TRY_CAST([CURRENT].CURRBAL AS FLOAT) > 0
		AND ([CURRENT].PB IN (''B'', ''C'', ''D'', ''E'', ''F'', ''H'', ''J'', ''L'', ''M'', ''N'', ''P'', ''Q'', ''T'', ''U'', ''W'', ''Y'') OR [CURRENT].PB IS NULL)
		AND [CURRENT].POSTFLG IN (''PP'', ''SP'')');
			EXEC(@sql_query);
			SET @T = 1;
		END
		ELSE BEGIN
			PRINT(CONCAT('DATA HASANAH_CARD TANGGAL ', @TGL_DATA, ' TIDAK TERSEDIA!'));
		END

		IF EXISTS (SELECT name FROM [NEW_BSI_STORAGE].sys.objects WHERE type_desc = 'USER_TABLE' AND name = CONCAT('BNIS.LOAN_DAILY.', @TGL_DATA))
		BEGIN
			PRINT(CONCAT('EKSEKUSI DATA BNIS TANGGAL ', @TGL_DATA, '!'));
			SET @sql_query = CONCAT('INSERT INTO #TB_BNIS_CURRENT
		SELECT
			--a.LEGACY
			''BNIS'' AS LEGACY
			,COALESCE(a.TANGGAL_DATA, @TGL_DATA) AS FICMISDATE
			,a.NO_REKG
			,a.CIF_NO
			,a.NAMA_DEBITUR
			,CONCAT(dbo.fx_ndigit_code(a.KODE_CABANG, 3), dbo.fx_ndigit_code(a.SUB_KODE, 2)) AS KODECABANGBARU
			,COALESCE(
				CASE
				WHEN a.SUB_NAME = ''DIVISI KOMERSIAL (CRD)'' THEN ''CB2G''
				WHEN a.SUB_NAME = ''MIDDLE ENTERPRISE DIVISION (MID)'' THEN ''CMG''
				WHEN a.SUB_NAME = ''HUMAN CAPITAL DIVISION (HCD)'' THEN ''CFG''
				ELSE NULL
				END
				,[ADJUSTMENT.BNI_LOAN_PURPOSE_NAME].[Divisi BSI]
				,[ADJUSTMENT.SEGMEN_BY_LD].[Divisi BSI]
				,
				CASE
				WHEN a.BNI_LOAN_PURPOSE_NAME = ''WUS'' AND a.MAKS_KREDIT_IDR >= 200000000 THEN ''BBG''
				WHEN a.BNI_LOAN_PURPOSE_NAME = ''WUS'' AND a.MAKS_KREDIT_IDR < 200000000 THEN ''MBG''
				WHEN a.BNI_LOAN_PURPOSE_NAME = ''BFM / FAP'' AND a.MAKS_KREDIT_IDR >= 25000000 THEN ''BBG''
				WHEN a.BNI_LOAN_PURPOSE_NAME = ''BFM / FAP'' AND a.MAKS_KREDIT_IDR < 25000000 THEN ''BBG''
				WHEN a.BNI_LOAN_PURPOSE_NAME = ''Kafalah'' AND a.KODE_CABANG = ''800'' THEN ''CB2G''
				WHEN a.BNI_LOAN_PURPOSE_NAME = ''Kafalah'' AND a.KODE_CABANG != ''800'' THEN ''CFG''
				WHEN a.BNI_LOAN_PURPOSE_NAME = ''KUR KECIL IB HASANAH'' AND a.MAKS_KREDIT_IDR >= 125000000 THEN ''BBG''
				WHEN a.BNI_LOAN_PURPOSE_NAME = ''KUR KECIL IB HASANAH'' AND a.MAKS_KREDIT_IDR < 125000000 THEN ''MBG''
				ELSE [ASUMSI_PRODUK].ASUMSI_DIVISI
				END
				)
				 AS DIVISI
			,a.BAKI_DEBET_IDR
		FROM [NEW_BSI_STORAGE].dbo.[BNIS.LOAN_DAILY.', @TGL_DATA, '] a		
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.BNIS.SEGMEN_BY_LD] [ADJUSTMENT.SEGMEN_BY_LD] ON [ADJUSTMENT.SEGMEN_BY_LD].NOLOAN = a.NO_REKG
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.BNIS.BNI_LOAN_PURPOSE_NAME] [ADJUSTMENT.BNI_LOAN_PURPOSE_NAME] ON [ADJUSTMENT.BNI_LOAN_PURPOSE_NAME].SOURCE = a.BNI_LOAN_PURPOSE_NAME
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.BNIS.ASUMSI_PRODUK] [ASUMSI_PRODUK] ON dbo.fx_ndigit_code(a.ACCOUNT_TYPE, 4) = [ASUMSI_PRODUK].ACCOUNT_TYPE AND dbo.fx_ndigit_code(a.SUB_CATEGORY, 4) = [ASUMSI_PRODUK].SUB_CATEGORY AND dbo.fx_ndigit_code(a.BNI_LOAN_PURPOSE_CD, 3) = [ASUMSI_PRODUK].BNI_LOAN_PURPOSE_CD');
			EXEC(@sql_query);
			SET @T = 1;
		END
		ELSE BEGIN
			PRINT(CONCAT('DATA BNIS TANGGAL ', @TGL_DATA, ' TIDAK TERSEDIA!'));
		END

		IF EXISTS (SELECT name FROM [NEW_BSI_STORAGE].sys.objects WHERE type_desc = 'USER_TABLE' AND name = CONCAT('BRIS.LOAN_DAILY.', @TGL_DATA))
		BEGIN
			PRINT(CONCAT('EKSEKUSI DATA BRIS TANGGAL ', @TGL_DATA, '!'));
			SET @sql_query = CONCAT('INSERT INTO #TB_BRIS_CURRENT
		SELECT
			--a.LEGACY
			''BRIS'' AS LEGACY
			,COALESCE(a.TANGGAL, @TGL_DATA) AS FICMISDATE
			,a.NO_LD AS NOLOAN
			,a.CIF_NO AS NOMORCIF
			,a.NAMA_NASABAH AS NAMALENGKAP
			,a.KODE_UKER AS KODECABANGBARU
			,CASE
				WHEN a.SEGMENTASI = ''KONSUMER'' AND a.KODE_PRODUCT = ''700'' THEN ''PWG''
				ELSE [MAPPING.SEGMENTASI].DIVISI
			END AS DIVISI
			,COALESCE(a.SISA_POKOK, 0)+COALESCE(a.TUNGGAKAN_POKOK, 0) AS OSPOKOKCONVERSION
		FROM [NEW_BSI_STORAGE].dbo.[BRIS.LOAN_DAILY.', @TGL_DATA, '] a
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.BRIS.SEGMENTASI] [MAPPING.SEGMENTASI] ON [MAPPING.SEGMENTASI].SOURCE = a.SEGMENTASI');
			EXEC(@sql_query);
			SET @T = 1;
		END
		ELSE BEGIN
			PRINT(CONCAT('DATA BRIS TANGGAL ', @TGL_DATA, ' TIDAK TERSEDIA!'));
		END

		IF EXISTS (SELECT name FROM [NEW_BSI_STORAGE].sys.objects WHERE type_desc = 'USER_TABLE' AND name = CONCAT('BSM.LOAN_DAILY.', @TGL_DATA))
		BEGIN
			PRINT(CONCAT('EKSEKUSI DATA BSM TANGGAL ', @TGL_DATA, '!'));
			SET @sql_query = CONCAT('INSERT INTO #TB_BSM_CURRENT
			SELECT
				--LEGACY
				''BSM'' AS LEGACY
				,TRY_CAST(FICMISDATE AS DATE) AS FICMISDATE
				,NOLOAN
				,NOMORCIF
				,NAMALENGKAP
				,KODECABANGBARU
				,DIVISI
				,TRY_CAST(OSPOKOKCONVERSION AS FLOAT) AS OSPOKOKCONVERSION
			FROM [NEW_BSI_STORAGE].dbo.[BSM.LOAN_DAILY.', @TGL_DATA, ']
			WHERE FICMISDATE != ''000''');
			EXEC(@sql_query);
			SET @T = 1;
		END

		IF EXISTS (SELECT name FROM [NEW_BSI_STORAGE].sys.objects WHERE type_desc = 'USER_TABLE' AND name = CONCAT('BSM.IFOS_JFAST.', @TGL_DATA))
		BEGIN
			PRINT(CONCAT('EKSEKUSI DATA BSM TANGGAL ', @TGL_DATA, '!'));
			SET @sql_query = CONCAT('INSERT INTO #TB_BSM_CURRENT
			SELECT
				--LEGACY
				''BSM'' AS LEGACY
				,COALESCE(FICMISDATE, @TGL_DATA) AS FICMISDATE
				,NOLOAN
				,NOMORCIF
				,NAMALENGKAP
				,KODECABANGBARU
				,DIVISI
				,TRY_CAST(OSPOKOKCONVERSION AS FLOAT) AS OSPOKOKCONVERSION
			FROM [NEW_BSI_STORAGE].dbo.[BSM.IFOS_JFAST.', @TGL_DATA, ']
			WHERE TRY_CAST(FICMISDATE AS DATE) IS NOT NULL');
			EXEC(@sql_query);
			SET @T = 1;
		END
		ELSE BEGIN

			PRINT(CONCAT('DATA BSM TANGGAL ', @TGL_DATA, ' TIDAK TERSEDIA!'));
		END
	END


	IF (@T = 1)
	BEGIN
		PRINT('PROCCESSING!!');
		UPDATE #TB_HC_CURRENT
		SET
			KODECABANGBARU = COALESCE([CABANG].[Kode BSI], [HC].KODECABANGBARU)
		FROM #TB_HC_CURRENT [HC]
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.JOIN.CABANG_UPDATE] [CABANG] ON [CABANG].[NAMA BANK] = [HC].LEGACY AND [CABANG].[KODE OUTLET EKSISTING] = [HC].KODECABANGBARU;
		
		UPDATE #TB_BNIS_CURRENT
		SET
			KODECABANGBARU = COALESCE([CABANG].[Kode BSI], [BNIS].KODECABANGBARU)
		FROM #TB_BNIS_CURRENT [BNIS]
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.JOIN.CABANG_UPDATE] [CABANG] ON [CABANG].[NAMA BANK] = [BNIS].LEGACY AND [CABANG].[KODE OUTLET EKSISTING] = [BNIS].KODECABANGBARU;
		
		UPDATE #TB_BRIS_CURRENT
		SET
			KODECABANGBARU = COALESCE([CABANG].[Kode BSI], [CABANG_BRIS].[Kode BSI], [BRIS].KODECABANGBARU)
		FROM #TB_BRIS_CURRENT [BRIS]
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.JOIN.CABANG_UPDATE] [CABANG] ON [CABANG].[NAMA BANK] = [BRIS].LEGACY AND [CABANG].[KODE OUTLET EKSISTING] = [BRIS].KODECABANGBARU
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.BRIS.CABANG_UPDATE] [CABANG_BRIS] ON [BRIS].KODECABANGBARU = [CABANG_BRIS].[KODE bris];
		
		UPDATE #TB_BSM_CURRENT
		SET
			KODECABANGBARU = COALESCE([CABANG].[Kode BSI], [BSM].KODECABANGBARU)
			,DIVISI = COALESCE([DIVISI].[DIVISI], [BSM].DIVISI)
		FROM #TB_BSM_CURRENT [BSM]
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.JOIN.CABANG_UPDATE] [CABANG] ON [CABANG].[NAMA BANK] = [BSM].LEGACY AND [CABANG].[KODE OUTLET EKSISTING] = [BSM].KODECABANGBARU
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.BSM.DIVISI] [DIVISI] ON [DIVISI].SOURCE = [BSM].DIVISI;

		MERGE [PORTOFOLIO_ONBS.COMPILE.JOIN.REKAP_NOLOAN.TGL_AKTIF] AS [COMPILE]
		USING
			(
				SELECT
					LEGACY
					,FICMISDATE
					,NOLOAN
					,NOMORCIF
					,NAMANASABAH
					,KODECABANGBARU
					,DIVISI
					,OSPOKOKCONVERSION
				FROM
					(
						SELECT
							LEGACY
							,FICMISDATE
							,NOLOAN
							,NOMORCIF
							,NAMANASABAH
							,KODECABANGBARU
							,DIVISI
							,OSPOKOKCONVERSION
							,ROW_NUMBER() OVER (
								PARTITION BY
									NOLOAN
								ORDER BY
									OSPOKOKCONVERSION DESC
							) AS ACCT
						FROM
						#TB_HC_CURRENT
					) [HC]
				WHERE ACCT = 1
				
				UNION

				SELECT
					*
				FROM #TB_BNIS_CURRENT
				
				UNION

				SELECT
					*
				FROM #TB_BRIS_CURRENT
				
				UNION

				SELECT
					*
				FROM #TB_BSM_CURRENT
			)AS [CURRENT]
			ON [COMPILE].LEGACY = [CURRENT].LEGACY
			AND [COMPILE].NOLOAN = [CURRENT].NOLOAN
		WHEN MATCHED THEN UPDATE SET
			[TGL_AKTIF_AWAL] = CASE WHEN [CURRENT].FICMISDATE <= [COMPILE].TGL_AKTIF_AWAL THEN [CURRENT].FICMISDATE ELSE [COMPILE].TGL_AKTIF_AWAL END
			,[TGL_AKTIF_AKHIR] = CASE WHEN [CURRENT].FICMISDATE >= [COMPILE].TGL_AKTIF_AKHIR THEN [CURRENT].FICMISDATE ELSE [COMPILE].TGL_AKTIF_AKHIR END
			,[NOMORCIF] = COALESCE([CURRENT].NOMORCIF, [COMPILE].NOMORCIF)
			,[NAMANASABAH] = COALESCE([CURRENT].NAMANASABAH, [COMPILE].NAMANASABAH)
			,[KODE_OUTLET] = COALESCE([CURRENT].KODECABANGBARU, [COMPILE].[KODE_OUTLET])
			,[DIVISI] = COALESCE([CURRENT].DIVISI, [COMPILE].DIVISI)
			,[OS_POKOK_AWAL] = CASE WHEN [CURRENT].FICMISDATE <= [COMPILE].TGL_AKTIF_AWAL THEN [CURRENT].OSPOKOKCONVERSION ELSE [COMPILE].OS_POKOK_AWAL END
			,[OS_POKOK_AKHIR] = CASE WHEN [CURRENT].FICMISDATE >= [COMPILE].TGL_AKTIF_AKHIR THEN [CURRENT].OSPOKOKCONVERSION ELSE [COMPILE].OS_POKOK_AKHIR END

		WHEN NOT MATCHED BY Target THEN
		INSERT
			(
				[TGL_AKTIF_AWAL]
				,[TGL_AKTIF_AKHIR]
				,[LEGACY]
				,[NOLOAN]
				,[NOMORCIF]
				,[NAMANASABAH]
				,[KODE_OUTLET]
				,[DIVISI]
				,[OS_POKOK_AWAL]
				,[OS_POKOK_AKHIR]
			)
		VALUES
			(
				[CURRENT].FICMISDATE
				,[CURRENT].FICMISDATE
				,[CURRENT].LEGACY
				,[CURRENT].NOLOAN
				,[CURRENT].NOMORCIF
				,[CURRENT].NAMANASABAH
				,[CURRENT].KODECABANGBARU
				,[CURRENT].DIVISI
				,[CURRENT].OSPOKOKCONVERSION
				,[CURRENT].OSPOKOKCONVERSION
			);

		
/*		
		UPDATE [PORTOFOLIO_ONBS.COMPILE.JOIN.REKAP_NOLOAN.TGL_AKTIF]
		SET
			[TGL_AKTIF_AWAL] = CASE WHEN [HC].FICMISDATE <= [TGL_AKTIF].TGL_AKTIF_AWAL THEN [HC].FICMISDATE ELSE [TGL_AKTIF].TGL_AKTIF_AWAL END
			,[TGL_AKTIF_AKHIR] = CASE WHEN [HC].FICMISDATE >= [TGL_AKTIF].TGL_AKTIF_AKHIR THEN [HC].FICMISDATE ELSE [TGL_AKTIF].TGL_AKTIF_AKHIR END
			,[NOMORCIF] = COALESCE([HC].NOMORCIF, TGL_AKTIF.NOMORCIF)
			,[NAMANASABAH] = COALESCE([HC].NAMANASABAH, TGL_AKTIF.NAMANASABAH)
			,[KODE_OUTLET] = COALESCE([CABANG].[Kode BSI], [HC].KODECABANGBARU, [TGL_AKTIF].[KODE_OUTLET])
			,[DIVISI] = COALESCE([HC].DIVISI, [TGL_AKTIF].DIVISI)
			,[OS_POKOK_AWAL] = CASE WHEN [HC].FICMISDATE <= [TGL_AKTIF].TGL_AKTIF_AWAL THEN [HC].OSPOKOKCONVERSION ELSE [TGL_AKTIF].OS_POKOK_AWAL END
			,[OS_POKOK_AKHIR] = CASE WHEN [HC].FICMISDATE >= [TGL_AKTIF].TGL_AKTIF_AKHIR THEN [HC].OSPOKOKCONVERSION ELSE [TGL_AKTIF].OS_POKOK_AKHIR END
		FROM
		[PORTOFOLIO_ONBS.COMPILE.JOIN.REKAP_NOLOAN.TGL_AKTIF] [TGL_AKTIF]
		LEFT JOIN #TB_HC_CURRENT [HC]
			ON [HC].LEGACY = [TGL_AKTIF].LEGACY
			AND [HC].NOLOAN = [TGL_AKTIF].NOLOAN
	--		AND [HC].NOMORCIF = [TGL_AKTIF].NOMORCIF
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.JOIN.CABANG_UPDATE] [CABANG] ON [CABANG].[NAMA BANK] = [HC].LEGACY AND [CABANG].[KODE OUTLET EKSISTING] = [HC].KODECABANGBARU
		WHERE [HC].NOLOAN IS NOT NULL;

		UPDATE [PORTOFOLIO_ONBS.COMPILE.JOIN.REKAP_NOLOAN.TGL_AKTIF]
		SET
			[TGL_AKTIF_AWAL] = CASE WHEN [BNIS].FICMISDATE <= [TGL_AKTIF].TGL_AKTIF_AWAL THEN [BNIS].FICMISDATE ELSE [TGL_AKTIF].TGL_AKTIF_AWAL END
			,[TGL_AKTIF_AKHIR] = CASE WHEN [BNIS].FICMISDATE >= [TGL_AKTIF].TGL_AKTIF_AKHIR THEN [BNIS].FICMISDATE ELSE [TGL_AKTIF].TGL_AKTIF_AKHIR END
			,[NAMANASABAH] = COALESCE([BNIS].NAMANASABAH, TGL_AKTIF.NAMANASABAH)
			,[KODE_OUTLET] = COALESCE([CABANG].[Kode BSI], [BNIS].KODECABANGBARU, [TGL_AKTIF].[KODE_OUTLET])
			,[DIVISI] = COALESCE([BNIS].DIVISI, [TGL_AKTIF].DIVISI)
			,[OS_POKOK_AWAL] = CASE WHEN [BNIS].FICMISDATE <= [TGL_AKTIF].TGL_AKTIF_AWAL THEN [BNIS].OSPOKOKCONVERSION ELSE [TGL_AKTIF].OS_POKOK_AWAL END
			,[OS_POKOK_AKHIR] = CASE WHEN [BNIS].FICMISDATE >= [TGL_AKTIF].TGL_AKTIF_AKHIR THEN [BNIS].OSPOKOKCONVERSION ELSE [TGL_AKTIF].OS_POKOK_AKHIR END
		FROM
		[PORTOFOLIO_ONBS.COMPILE.JOIN.REKAP_NOLOAN.TGL_AKTIF] [TGL_AKTIF]
		LEFT JOIN #TB_BNIS_CURRENT [BNIS]
			ON [BNIS].LEGACY = [TGL_AKTIF].LEGACY
			AND [BNIS].NOLOAN = [TGL_AKTIF].NOLOAN
			AND [BNIS].NOMORCIF = [TGL_AKTIF].NOMORCIF
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.JOIN.CABANG_UPDATE] [CABANG] ON [CABANG].[NAMA BANK] = [BNIS].LEGACY AND [CABANG].[KODE OUTLET EKSISTING] = [BNIS].KODECABANGBARU
		WHERE [BNIS].NOLOAN IS NOT NULL;

		UPDATE [PORTOFOLIO_ONBS.COMPILE.JOIN.REKAP_NOLOAN.TGL_AKTIF]
		SET
			[TGL_AKTIF_AWAL] = CASE WHEN [BRIS].FICMISDATE <= [TGL_AKTIF].TGL_AKTIF_AWAL THEN [BRIS].FICMISDATE ELSE [TGL_AKTIF].TGL_AKTIF_AWAL END
			,[TGL_AKTIF_AKHIR] = CASE WHEN [BRIS].FICMISDATE >= [TGL_AKTIF].TGL_AKTIF_AKHIR THEN [BRIS].FICMISDATE ELSE [TGL_AKTIF].TGL_AKTIF_AKHIR END
			,[NAMANASABAH] = COALESCE([BRIS].NAMANASABAH, TGL_AKTIF.NAMANASABAH)
			,[KODE_OUTLET] = COALESCE([CABANG].[Kode BSI], [CABANG_BRIS].[Kode BSI], [BRIS].KODECABANGBARU, [TGL_AKTIF].[KODE_OUTLET])
			,[DIVISI] = COALESCE([BRIS].DIVISI, [TGL_AKTIF].DIVISI)
			,[OS_POKOK_AWAL] = CASE WHEN [BRIS].FICMISDATE <= [TGL_AKTIF].TGL_AKTIF_AWAL THEN [BRIS].OSPOKOKCONVERSION ELSE [TGL_AKTIF].OS_POKOK_AWAL END
			,[OS_POKOK_AKHIR] = CASE WHEN [BRIS].FICMISDATE >= [TGL_AKTIF].TGL_AKTIF_AKHIR THEN [BRIS].OSPOKOKCONVERSION ELSE [TGL_AKTIF].OS_POKOK_AKHIR END
		FROM
		[PORTOFOLIO_ONBS.COMPILE.JOIN.REKAP_NOLOAN.TGL_AKTIF] [TGL_AKTIF]
		LEFT JOIN #TB_BRIS_CURRENT [BRIS]
			ON [BRIS].LEGACY = [TGL_AKTIF].LEGACY
			AND [BRIS].NOLOAN = [TGL_AKTIF].NOLOAN
			AND [BRIS].NOMORCIF = [TGL_AKTIF].NOMORCIF
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.JOIN.CABANG_UPDATE] [CABANG] ON [CABANG].[NAMA BANK] = [BRIS].LEGACY AND [CABANG].[KODE OUTLET EKSISTING] = [BRIS].KODECABANGBARU
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.BRIS.CABANG_UPDATE] [CABANG_BRIS] ON [CABANG_BRIS].[KODE bris] = [BRIS].KODECABANGBARU
		WHERE [BRIS].NOLOAN IS NOT NULL;

		UPDATE [PORTOFOLIO_ONBS.COMPILE.JOIN.REKAP_NOLOAN.TGL_AKTIF]
		SET
			[TGL_AKTIF_AWAL] = CASE WHEN [BSM].FICMISDATE <= [TGL_AKTIF].TGL_AKTIF_AWAL THEN [BSM].FICMISDATE ELSE [TGL_AKTIF].TGL_AKTIF_AWAL END
			,[TGL_AKTIF_AKHIR] = CASE WHEN [BSM].FICMISDATE >= [TGL_AKTIF].TGL_AKTIF_AKHIR THEN [BSM].FICMISDATE ELSE [TGL_AKTIF].TGL_AKTIF_AKHIR END
			,[NAMANASABAH] = COALESCE([BSM].NAMANASABAH, TGL_AKTIF.NAMANASABAH)
			,[KODE_OUTLET] = COALESCE([CABANG].[Kode BSI], [BSM].KODECABANGBARU, [TGL_AKTIF].[KODE_OUTLET])
			,[DIVISI] = COALESCE([DIVISI].[DIVISI], [BSM].DIVISI, [TGL_AKTIF].DIVISI)
			,[OS_POKOK_AWAL] = CASE WHEN [BSM].FICMISDATE <= [TGL_AKTIF].TGL_AKTIF_AWAL THEN [BSM].OSPOKOKCONVERSION ELSE [TGL_AKTIF].OS_POKOK_AWAL END
			,[OS_POKOK_AKHIR] = CASE WHEN [BSM].FICMISDATE >= [TGL_AKTIF].TGL_AKTIF_AKHIR THEN [BSM].OSPOKOKCONVERSION ELSE [TGL_AKTIF].OS_POKOK_AKHIR END
		FROM
		[PORTOFOLIO_ONBS.COMPILE.JOIN.REKAP_NOLOAN.TGL_AKTIF] [TGL_AKTIF]
		LEFT JOIN #TB_BSM_CURRENT [BSM]
			ON [BSM].LEGACY = [TGL_AKTIF].LEGACY
			AND [BSM].NOLOAN = [TGL_AKTIF].NOLOAN
			AND [BSM].NOMORCIF = [TGL_AKTIF].NOMORCIF
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.JOIN.CABANG_UPDATE] [CABANG] ON [CABANG].[NAMA BANK] = [BSM].LEGACY AND [CABANG].[KODE OUTLET EKSISTING] = [BSM].KODECABANGBARU
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.BSM.DIVISI] [DIVISI] ON [DIVISI].SOURCE = [BSM].DIVISI
		WHERE [BSM].NOLOAN IS NOT NULL;



		INSERT INTO [PORTOFOLIO_ONBS.COMPILE.JOIN.REKAP_NOLOAN.TGL_AKTIF]
		SELECT
			[HC].FICMISDATE
			,[HC].FICMISDATE
			,[HC].LEGACY
			,[HC].NOLOAN
			,[HC].NOMORCIF
			,[HC].NAMANASABAH
			,COALESCE([CABANG].[Kode BSI], [HC].KODECABANGBARU) AS KODECABANGBARU
			,[HC].DIVISI
			,[HC].OSPOKOKCONVERSION
			,[HC].OSPOKOKCONVERSION
		FROM
		#TB_HC_CURRENT [HC]
		LEFT JOIN [PORTOFOLIO_ONBS.COMPILE.JOIN.REKAP_NOLOAN.TGL_AKTIF] [TGL_AKTIF]
			ON [HC].LEGACY = [TGL_AKTIF].LEGACY
			AND [HC].NOLOAN = [TGL_AKTIF].NOLOAN
	--		AND [HC].NOMORCIF = [TGL_AKTIF].NOMORCIF
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.JOIN.CABANG_UPDATE] [CABANG] ON [CABANG].[NAMA BANK] = [HC].LEGACY AND [CABANG].[KODE OUTLET EKSISTING] = [HC].KODECABANGBARU
		WHERE [TGL_AKTIF].NOLOAN IS NULL;

		INSERT INTO [PORTOFOLIO_ONBS.COMPILE.JOIN.REKAP_NOLOAN.TGL_AKTIF]
		SELECT
			[BNIS].FICMISDATE
			,[BNIS].FICMISDATE
			,[BNIS].LEGACY
			,[BNIS].NOLOAN
			,[BNIS].NOMORCIF
			,[BNIS].NAMANASABAH
			,COALESCE([CABANG].[Kode BSI], [BNIS].KODECABANGBARU) AS KODECABANGBARU
			,[BNIS].DIVISI
			,[BNIS].OSPOKOKCONVERSION
			,[BNIS].OSPOKOKCONVERSION
		FROM
		#TB_BNIS_CURRENT [BNIS]
		LEFT JOIN [PORTOFOLIO_ONBS.COMPILE.JOIN.REKAP_NOLOAN.TGL_AKTIF] [TGL_AKTIF]
			ON [BNIS].LEGACY = [TGL_AKTIF].LEGACY
			AND [BNIS].NOLOAN = [TGL_AKTIF].NOLOAN
			AND [BNIS].NOMORCIF = [TGL_AKTIF].NOMORCIF
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.JOIN.CABANG_UPDATE] [CABANG] ON [CABANG].[NAMA BANK] = [BNIS].LEGACY AND [CABANG].[KODE OUTLET EKSISTING] = [BNIS].KODECABANGBARU
		WHERE [TGL_AKTIF].NOLOAN IS NULL;

		INSERT INTO [PORTOFOLIO_ONBS.COMPILE.JOIN.REKAP_NOLOAN.TGL_AKTIF]
		SELECT
			[BRIS].FICMISDATE
			,[BRIS].FICMISDATE
			,[BRIS].LEGACY
			,[BRIS].NOLOAN
			,[BRIS].NOMORCIF
			,[BRIS].NAMANASABAH
			,COALESCE([CABANG].[Kode BSI], [CABANG_BRIS].[Kode BSI], [BRIS].KODECABANGBARU) AS KODECABANGBARU
			,[BRIS].DIVISI
			,[BRIS].OSPOKOKCONVERSION
			,[BRIS].OSPOKOKCONVERSION
		FROM
		#TB_BRIS_CURRENT [BRIS]
		LEFT JOIN [PORTOFOLIO_ONBS.COMPILE.JOIN.REKAP_NOLOAN.TGL_AKTIF] [TGL_AKTIF]
			ON [BRIS].LEGACY = [TGL_AKTIF].LEGACY
			AND [BRIS].NOLOAN = [TGL_AKTIF].NOLOAN
			AND [BRIS].NOMORCIF = [TGL_AKTIF].NOMORCIF
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.JOIN.CABANG_UPDATE] [CABANG] ON [CABANG].[NAMA BANK] = [BRIS].LEGACY AND [CABANG].[KODE OUTLET EKSISTING] = [BRIS].KODECABANGBARU
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.BRIS.CABANG_UPDATE] [CABANG_BRIS] ON [BRIS].KODECABANGBARU = [CABANG_BRIS].[KODE bris]
		WHERE [TGL_AKTIF].NOLOAN IS NULL;

		INSERT INTO [PORTOFOLIO_ONBS.COMPILE.JOIN.REKAP_NOLOAN.TGL_AKTIF]
		SELECT
			[BSM].FICMISDATE
			,[BSM].FICMISDATE
			,[BSM].LEGACY
			,[BSM].NOLOAN
			,[BSM].NOMORCIF
			,[BSM].NAMANASABAH
			,COALESCE([CABANG].[Kode BSI], [BSM].KODECABANGBARU) AS KODECABANGBARU
			,COALESCE([DIVISI].[DIVISI], [BSM].DIVISI) AS DIVISI
			,[BSM].OSPOKOKCONVERSION
			,[BSM].OSPOKOKCONVERSION
		FROM
		#TB_BSM_CURRENT [BSM]
		LEFT JOIN [PORTOFOLIO_ONBS.COMPILE.JOIN.REKAP_NOLOAN.TGL_AKTIF] [TGL_AKTIF]
			ON [BSM].LEGACY = [TGL_AKTIF].LEGACY
			AND [BSM].NOLOAN = [TGL_AKTIF].NOLOAN
			AND [BSM].NOMORCIF = [TGL_AKTIF].NOMORCIF
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.JOIN.CABANG_UPDATE] [CABANG] ON [CABANG].[NAMA BANK] = [BSM].LEGACY AND [CABANG].[KODE OUTLET EKSISTING] = [BSM].KODECABANGBARU
		LEFT JOIN [PORTOFOLIO_JOIN.MAPPING.BSM.DIVISI] [DIVISI] ON [DIVISI].SOURCE = [BSM].DIVISI
		WHERE [TGL_AKTIF].NOLOAN IS NULL;
*/
	END

	
  -- routine body goes here, e.g.
  -- SELECT 'Navicat for SQL Server'
END



