CREATE PROCEDURE [dbo].[sp_generate_bris_mutasi_lunas]
AS
BEGIN
	PRINT('GENERATE MUTASI LUNAS BRIS');
	UPDATE [PORTOFOLIO_ONBS.GENERATED.JOIN.PORTOFOLIO_CURRENT]
	SET
		[(RCG) KOL_LOAN_PECAH] = 
			CASE
				WHEN [MUTASI].NOLOAN_AFTER IS NOT NULL THEN 'Suspect'
				WHEN [EKSEKUSI_WO].NOLOAN_WO IS NOT NULL THEN 'WO'
				ELSE 'Lunas'
			END
		,[(RCG) KOL_CIF_STD] = 
			CASE
				WHEN [MUTASI].NOLOAN_AFTER IS NOT NULL THEN 'Suspect'
				WHEN [EKSEKUSI_WO].NOLOAN_WO IS NOT NULL THEN 'WO'
				ELSE 'Lunas'
			END
		,[(RCG) KOL_CIF_PECAH] = 
			CASE
				WHEN [MUTASI].NOLOAN_AFTER IS NOT NULL THEN 'Suspect'
				WHEN [EKSEKUSI_WO].NOLOAN_WO IS NOT NULL THEN 'WO'
				ELSE 'Lunas'
			END
		,[(RCG) KOL_SUPERCIF_PECAH] = 
			CASE
				WHEN [MUTASI].NOLOAN_AFTER IS NOT NULL THEN 'Suspect'
				WHEN [EKSEKUSI_WO].NOLOAN_WO IS NOT NULL THEN 'WO'
				ELSE 'Lunas'
			END
		,[(RCG) OS_POKOK_PSAK_CURRENT] = COALESCE([EKSEKUSI_WO].BAKI_DEBET_IDR, [SOURCE].[(RCG) OS_POKOK_PSAK_CURRENT])
		,[(SOURCE) OS_POKOK_CURRENT] = COALESCE([EKSEKUSI_WO].BAKI_DEBET_IDR, [SOURCE].[(SOURCE) OS_POKOK_CURRENT])
		,[(SOURCE) OS_MARGIN_CURRENT] = COALESCE([EKSEKUSI_WO].MARGIN_AWAL_IDR, [SOURCE].[(SOURCE) OS_MARGIN_CURRENT])
	FROM
	[PORTOFOLIO_ONBS.GENERATED.JOIN.PORTOFOLIO_CURRENT] [SOURCE]
	LEFT JOIN
	(
		SELECT
			NO_LD AS NOLOAN
		FROM
		[PORTOFOLIO_ONBS.SOURCE.BRIS.LOAN_DAILY]
		GROUP BY NO_LD
	) [CURRENT]
	ON [SOURCE].[(SOURCE) NOLOAN_CURRENT] = [CURRENT].NOLOAN
	LEFT JOIN [PORTOFOLIO_ONBS.MAPPING.JOIN.REKAP_NOLOAN.MUTASI_NOLOAN_CURRENT] [MUTASI]
		ON [SOURCE].[(SOURCE) NOLOAN_CURRENT] = [MUTASI].NOLOAN_CURRENT
		AND [SOURCE].[(RCG) SOURCE_CURRENT] = [MUTASI].LEGACY_CURRENT
--		AND [MUTASI].TGL_EFEKTIF <= @tgl_bris_current
	LEFT JOIN [PORTOFOLIO_ONBS.DATABASE.JOIN.EKSEKUSI_WO] [EKSEKUSI_WO]
		ON [SOURCE].[(SOURCE) NOLOAN_CURRENT] = [EKSEKUSI_WO].NOLOAN
		AND [SOURCE].[(RCG) SOURCE_CURRENT]= [EKSEKUSI_WO].LEGACY

	WHERE [CURRENT].NOLOAN IS NULL
	AND [SOURCE].[(RCG) SOURCE_CURRENT] = 'BRIS'
	AND [SOURCE].[(RCG) DIVISI_PECAH] != 'Hasanah Card'
  -- routine body goes here, e.g.
  -- SELECT 'Navicat for SQL Server'
END
GO
