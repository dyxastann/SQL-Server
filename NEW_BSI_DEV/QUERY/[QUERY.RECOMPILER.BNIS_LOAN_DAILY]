DECLARE @sql_query varchar(max) = '', @NAME varchar(max) = '', @COLUMN_NAME varchar(max) = '', @COLUMNS varchar(max) = ''
DECLARE load_cursor CURSOR FOR 
	SELECT name FROM [NEW_BSI_STORAGE].sys.objects WHERE type_desc = 'USER_TABLE' AND name LIKE ('BNIS.LOAN_DAILY.____-__-__') ORDER BY name ASC

OPEN load_cursor
FETCH NEXT FROM load_cursor INTO @NAME

WHILE @@FETCH_STATUS = 0 
BEGIN

	SET @sql_query = CONCAT('SELECT
			''BNIS'' AS LEGACY
			,NULLIF(NO_REKG, '''') AS NOLOAN
			,NULLIF(CIF_NO, '''') AS NOMORCIF
			,COALESCE([MAPPING].[Kode BSI], CONCAT([NEW_BSI_COLLECTION].dbo.fx_ndigit_code([SOURCE].KODE_CABANG, 3), [NEW_BSI_COLLECTION].dbo.fx_ndigit_code([SOURCE].SUB_KODE, 2))) AS KODEOUTLET
			,[NEW_BSI_COLLECTION].dbo.fx_adjustment_divisi_bsi(COALESCE(
				CASE
					WHEN [SOURCE].SUB_NAME = ''DIVISI KOMERSIAL (CRD)'' THEN ''CB2G''
					WHEN [SOURCE].SUB_NAME = ''MIDDLE ENTERPRISE DIVISION (MID)'' THEN ''CMG''
					WHEN [SOURCE].SUB_NAME = ''HUMAN CAPITAL DIVISION (HCD)'' THEN ''CFG''
				END
				,[ADJUSTMENT.BNI_LOAN_PURPOSE_NAME].[Divisi BSI]
				,[ADJUSTMENT.SEGMEN_BY_LD].[Divisi BSI]
				,
				CASE
					WHEN [SOURCE].BNI_LOAN_PURPOSE_NAME = ''WUS'' AND [SOURCE].MAKS_KREDIT_IDR >= 200000000.00 THEN ''BBG''
					WHEN [SOURCE].BNI_LOAN_PURPOSE_NAME = ''WUS'' AND [SOURCE].MAKS_KREDIT_IDR < 200000000.00 THEN ''MBG''
					WHEN [SOURCE].BNI_LOAN_PURPOSE_NAME = ''BFM / FAP'' THEN ''BBG''
					WHEN [SOURCE].BNI_LOAN_PURPOSE_NAME = ''Kafalah'' AND [SOURCE].KODE_CABANG = ''800'' THEN ''CB2G''
					WHEN [SOURCE].BNI_LOAN_PURPOSE_NAME = ''Kafalah'' AND [SOURCE].KODE_CABANG != ''800'' THEN ''CFG''
					WHEN [SOURCE].BNI_LOAN_PURPOSE_NAME = ''KUR KECIL IB HASANAH'' AND [SOURCE].MAKS_KREDIT_IDR >= 125000000.00 THEN ''BBG''
					WHEN [SOURCE].BNI_LOAN_PURPOSE_NAME = ''KUR KECIL IB HASANAH'' AND [SOURCE].MAKS_KREDIT_IDR < 125000000.00 THEN ''MBG''
					ELSE [ASUMSI_PRODUK].ASUMSI_DIVISI
				END
			)) AS DIVISI
			,NULLIF([SOURCE].CURRENCY, '''') AS CURRENCY
			,CONCAT([NEW_BSI_COLLECTION].dbo.fx_ndigit_code([SOURCE].ACCOUNT_TYPE, 4), ''-'', [NEW_BSI_COLLECTION].dbo.fx_ndigit_code([SOURCE].SUB_CATEGORY, 4), ''-'', [NEW_BSI_COLLECTION].dbo.fx_ndigit_code([SOURCE].BNI_LOAN_PURPOSE_CD, 3)) AS LOANTYPE
			,NULLIF(LEFT([SOURCE].PRD_NAME, PATINDEX(''%[ ]%'',[SOURCE].PRD_NAME)), '''') AS JENISPIUTANGPEMBIAYAAN
			,NULLIF([SOURCE].SEKTOR_EKONOMI, '''') AS KODESEKTOREKONOMI
			,NULLIF([SOURCE].MAKS_KREDIT_IDR, '''') AS PENCAIRANPOKOKCONVERSION
			,NULLIF([SOURCE].MARGIN_AWAL, '''') AS PENCAIRANMARGINCONVERSION
			,NULLIF(TRY_CAST([SOURCE].TGL_BUKA_REKENING AS DATE), '''') AS TANGGAL_CAIR
			,NULLIF(TRY_CAST([SOURCE].OVERDUE_DAYS AS DATE), '''') AS TANGGAL_JATUH_TEMPO
		INTO [TEMPORARY_TABLE]
		FROM [NEW_BSI_STORAGE].[dbo].[', @NAME, '] [SOURCE]
		LEFT JOIN [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_JOIN.MAPPING.BNIS.PRD_NAME] [MAPPING.PRD_NAME] ON [MAPPING.PRD_NAME].SOURCE = [SOURCE].PRD_NAME
		LEFT JOIN [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_JOIN.MAPPING.BNIS.SEGMEN_BY_LD] [ADJUSTMENT.SEGMEN_BY_LD] ON [ADJUSTMENT.SEGMEN_BY_LD].NOLOAN = [SOURCE].NO_REKG
		LEFT JOIN [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_JOIN.MAPPING.BNIS.BNI_LOAN_PURPOSE_NAME] [ADJUSTMENT.BNI_LOAN_PURPOSE_NAME] ON [ADJUSTMENT.BNI_LOAN_PURPOSE_NAME].SOURCE = [SOURCE].BNI_LOAN_PURPOSE_NAME
		LEFT JOIN [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_JOIN.MAPPING.BNIS.ASUMSI_PRODUK] [ASUMSI_PRODUK]
			ON [NEW_BSI_COLLECTION].dbo.fx_ndigit_code([SOURCE].ACCOUNT_TYPE, 4) = [ASUMSI_PRODUK].ACCOUNT_TYPE
			AND [NEW_BSI_COLLECTION].dbo.fx_ndigit_code([SOURCE].SUB_CATEGORY, 4) = [ASUMSI_PRODUK].SUB_CATEGORY
			AND [NEW_BSI_COLLECTION].dbo.fx_ndigit_code([SOURCE].BNI_LOAN_PURPOSE_CD, 3) = [ASUMSI_PRODUK].BNI_LOAN_PURPOSE_CD
		LEFT JOIN [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_JOIN.MAPPING.JOIN.MAPPING_OUTLET_EDA] [MAPPING]
			ON CONCAT([NEW_BSI_COLLECTION].dbo.fx_ndigit_code([SOURCE].KODE_CABANG, 3), [NEW_BSI_COLLECTION].dbo.fx_ndigit_code([SOURCE].SUB_KODE, 2)) = [MAPPING].[cabangLegacy]
			AND ''BNIS'' = [MAPPING].[bankLegacy]
		WHERE NULLIF(NO_REKG, '''') IS NOT NULL')
	BEGIN TRY
		EXEC(@sql_query)
	END TRY
	BEGIN CATCH
	END CATCH

	SET @sql_query = 'MERGE [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.LOAN_DETAIL] [TARGET]
USING [TEMPORARY_TABLE] [SOURCE]
	ON [SOURCE].[NOLOAN] = [TARGET].[NOLOAN]
	AND [SOURCE].[NOMORCIF] = [TARGET].[NOMORCIF]
WHEN MATCHED THEN UPDATE SET
	LEGACY = COALESCE([SOURCE].LEGACY, [TARGET].LEGACY)
	,KODEOUTLET = COALESCE([SOURCE].KODEOUTLET, [TARGET].KODEOUTLET)
	,DIVISI = COALESCE([TARGET].DIVISI, [SOURCE].DIVISI)
	,CURRENCY = COALESCE([SOURCE].CURRENCY, [TARGET].CURRENCY)
	,LOANTYPE = COALESCE([SOURCE].LOANTYPE, [TARGET].LOANTYPE)
	,JENISPIUTANGPEMBIAYAAN = COALESCE([SOURCE].JENISPIUTANGPEMBIAYAAN, [TARGET].JENISPIUTANGPEMBIAYAAN)
	,KODESEKTOREKONOMI = COALESCE([SOURCE].KODESEKTOREKONOMI, [TARGET].KODESEKTOREKONOMI)
	,PENCAIRANPOKOKCONVERSION = COALESCE([SOURCE].PENCAIRANPOKOKCONVERSION, [TARGET].PENCAIRANPOKOKCONVERSION)
	,PENCAIRANMARGINCONVERSION = COALESCE([SOURCE].PENCAIRANMARGINCONVERSION, [TARGET].PENCAIRANMARGINCONVERSION)
	,TANGGAL_CAIR = COALESCE([SOURCE].TANGGAL_CAIR, [TARGET].TANGGAL_CAIR)
	,TANGGAL_JATUH_TEMPO = COALESCE([SOURCE].TANGGAL_JATUH_TEMPO, [TARGET].TANGGAL_JATUH_TEMPO)
WHEN NOT MATCHED BY TARGET THEN INSERT
(
	LEGACY
	,NOLOAN
	,NOMORCIF
	,KODEOUTLET
	,DIVISI
	,CURRENCY
	,LOANTYPE
	,JENISPIUTANGPEMBIAYAAN
	,KODESEKTOREKONOMI
	,PENCAIRANPOKOKCONVERSION
	,PENCAIRANMARGINCONVERSION
	,TANGGAL_CAIR
	,TANGGAL_JATUH_TEMPO
)
VALUES
(
	[SOURCE].LEGACY
	,[SOURCE].NOLOAN
	,[SOURCE].NOMORCIF
	,[SOURCE].KODEOUTLET
	,[SOURCE].DIVISI
	,[SOURCE].CURRENCY
	,[SOURCE].LOANTYPE
	,[SOURCE].JENISPIUTANGPEMBIAYAAN
	,[SOURCE].KODESEKTOREKONOMI
	,[SOURCE].PENCAIRANPOKOKCONVERSION
	,[SOURCE].PENCAIRANMARGINCONVERSION
	,[SOURCE].TANGGAL_CAIR
	,[SOURCE].TANGGAL_JATUH_TEMPO
);'
	BEGIN TRY
		EXEC(@sql_query)
		PRINT CONCAT(@NAME, ' LOAN: OK!')
	END TRY
	BEGIN CATCH
		PRINT CONCAT(@NAME, ' LOAN: ', ERROR_MESSAGE())
	END CATCH

	SET @sql_query = 'DROP TABLE [TEMPORARY_TABLE]'
	BEGIN TRY
		EXEC(@sql_query)
		PRINT CONCAT(@NAME, ' LOAN: OK!')
	END TRY
	BEGIN CATCH
		PRINT CONCAT(@NAME, ' LOAN: ', ERROR_MESSAGE())
	END CATCH


	SET @sql_query = CONCAT('MERGE [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CIF_DETAIL] [TARGET]
USING
(
	SELECT
		''BNIS'' AS [LEGACY]
		,CIF_NO AS [NOMORCIF]
		,NULLIF([NAMA_DEBITUR], '''') AS NAMANASABAH
		,NULLIF([NAMA_PEKERJAAN], '''') AS [PEKERJAAN]
		,NULLIF(CONCAT([ALAMAT1], '','', [ALAMAT2]), '','') AS ALAMAT
		,NULLIF([NO_TELP_HP], '''') AS NO_HP
		,NULLIF([NO_TELP_RUMAH], '''') AS NO_TELP
		,NULLIF([NO_TELP_KANTOR], '''') AS NO_KANTOR
		,NULLIF(TRY_CAST([TANGGAL_LAHIR] AS DATE), '''') AS [TANGGAL_LAHIR]
		,NULLIF([NOMOR_IDENTITAS], '''') AS KTP
		,NULLIF([NPWP], '''') AS NPWP
		,NULLIF(NULLIF(REPLACE(REPLACE([JENIS_KELAMIN], ''1. '', ''''), ''2. '', ''''), ''NONE''), '''') AS [GENDER]
		,ROW_NUMBER() OVER (
			PARTITION BY
				CIF_NO
			ORDER BY
				[NAMA_DEBITUR] DESC
				,[NAMA_PEKERJAAN] DESC
				,NULLIF(CONCAT([ALAMAT1], '','', [ALAMAT2]), '','') DESC
				,[NO_TELP_HP] DESC
				,[NO_TELP_RUMAH] DESC
				,[NO_TELP_KANTOR] DESC
				,[TANGGAL_LAHIR] DESC
				,[NOMOR_IDENTITAS] DESC
				,[NPWP] DESC
				,NULLIF(NULLIF(REPLACE(REPLACE([JENIS_KELAMIN], ''1. '', ''''), ''2. '', ''''), ''NONE''), '''') DESC
		) AS ACCT
	FROM [NEW_BSI_STORAGE].[dbo].[', @NAME, ']
	WHERE NULLIF([CIF_NO], '''') IS NOT NULL
	GROUP BY
		[CIF_NO]
		,[NAMA_DEBITUR]
		,[NAMA_PEKERJAAN]
		,NULLIF(CONCAT([ALAMAT1], '','', [ALAMAT2]), '','')
		,[NO_TELP_HP]
		,[NO_TELP_RUMAH]
		,[NO_TELP_KANTOR]
		,[TANGGAL_LAHIR]
		,[NOMOR_IDENTITAS]
		,[NPWP]
		,NULLIF(NULLIF(REPLACE(REPLACE([JENIS_KELAMIN], ''1. '', ''''), ''2. '', ''''), ''NONE''), '''')
) [SOURCE]
	ON [TARGET].[LEGACY] = [SOURCE].[LEGACY]
	AND [TARGET].[NOMORCIF] = [SOURCE].[NOMORCIF]
	AND [SOURCE].ACCT = 1
WHEN MATCHED THEN UPDATE SET
	NAMANASABAH = COALESCE([TARGET].NAMANASABAH, [SOURCE].NAMANASABAH)
	,[PEKERJAAN] = COALESCE([TARGET].PEKERJAAN, [SOURCE].PEKERJAAN)
	,[ALAMAT] = COALESCE([TARGET].ALAMAT, [SOURCE].ALAMAT)
	,[NO_HP] = COALESCE([TARGET].NO_HP, [SOURCE].NO_HP)
	,[NO_TELP] = COALESCE([TARGET].NO_HP, [SOURCE].NO_HP)
	,[NO_KANTOR] = COALESCE([TARGET].NO_HP, [SOURCE].NO_HP)
	,[TANGGAL_LAHIR] = COALESCE([TARGET].TANGGAL_LAHIR, [SOURCE].TANGGAL_LAHIR)
	,[NPWP] = COALESCE([TARGET].NPWP, [SOURCE].NPWP)
	,[KTP] = COALESCE([TARGET].KTP, [SOURCE].KTP)
	,[GENDER] = COALESCE([TARGET].GENDER, [SOURCE].GENDER)
WHEN NOT MATCHED BY TARGET THEN INSERT
(
	[LEGACY]
	,[NOMORCIF]
	,[NAMANASABAH]
	,[PEKERJAAN]
	,[ALAMAT]
	,[NO_HP]
	,[NO_TELP]
	,[NO_KANTOR]
	,[TANGGAL_LAHIR]
	,[NPWP]
	,[KTP]
	,[GENDER]
)
VALUES
(
	[SOURCE].[LEGACY]
	,[SOURCE].[NOMORCIF]
	,[SOURCE].[NAMANASABAH]
	,[SOURCE].[PEKERJAAN]
	,[SOURCE].[ALAMAT]
	,[SOURCE].[NO_HP]
	,[SOURCE].[NO_TELP]
	,[SOURCE].[NO_KANTOR]
	,[SOURCE].[TANGGAL_LAHIR]
	,[SOURCE].[NPWP]
	,[SOURCE].[KTP]
	,[SOURCE].[GENDER]
);')
	BEGIN TRY
		EXEC(@sql_query)
		PRINT CONCAT(@NAME, ' CIF: OK!')
	END TRY
	BEGIN CATCH
		PRINT CONCAT(@NAME, ' CIF: ', ERROR_MESSAGE())
	END CATCH
	
	FETCH NEXT FROM load_cursor INTO @NAME
END

CLOSE load_cursor
DEALLOCATE load_cursor; 
