BEGIN TRY
	CREATE TABLE [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08] (
		PERIODE_PELAPORAN VARCHAR(255),
		[ARO ID] VARCHAR(255),
		NOLOAN VARCHAR(255),
		NOMORCIF VARCHAR(255),
		NAMANASABAH VARCHAR(255),
		KODEOUTLET_BSI VARCHAR(255),
		NAMAOUTLET_BSI VARCHAR(255),
		AREA_BSI VARCHAR(255),
		REGION_BSI VARCHAR(255),
		DIVISI_BSI VARCHAR(255),
		PRODUK_BSI VARCHAR(255),
		KOL_LAST VARCHAR(255),
		KOL_FINAL VARCHAR(255),
		KOL_TERBURUK VARCHAR(255),
		KOL_PELAPORAN VARCHAR(255),
		COUNT_INVENTORY INTEGER,
		FLAG_PTP VARCHAR(255),
		INTENSITAS_PTP INTEGER,
		TGL_AWAL_PTP DATE,
		TGL_AKHIR_PTP DATE,
		NOMINAL_POKOK DECIMAL(20, 2),
		NOMINAL_MARGIN DECIMAL(20, 2),
		NOMINAL_BASIL DECIMAL(20, 2),
		NOMINAL_BAYAR DECIMAL(20, 2),
		FLAG_PEMBAYARAN VARCHAR(255),
		INTENSITAS_INPUT INTEGER,
		OS_POKOK_PELAPORAN_BULAN_SEBELUM DECIMAL(32, 2),
		OS_POKOK_PELAPORAN_CURRENT DECIMAL(32, 2),
		SELISIH_OS_POKOK DECIMAL(32, 2)
	)
END TRY
BEGIN CATCH
END CATCH


TRUNCATE TABLE [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08];

----------------------------------------------------------------------------------------

INSERT INTO [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08] (
	PERIODE_PELAPORAN,
	[ARO ID],
	NOLOAN,
	NOMORCIF,
	COUNT_INVENTORY,
	FLAG_PTP,
	INTENSITAS_PTP,
	TGL_AWAL_PTP,
	TGL_AKHIR_PTP,
	INTENSITAS_INPUT
)
SELECT
	EOMONTH ([MCS].[Assignment Date]) AS PERIODE_PELAPORAN,
	[MCS].[ARO ID],
	[MAPPING].[NOLOAN_FINAL],
	[MAPPING].[NOMORCIF],
	COUNT (1) AS ACCT,
	MAX(CASE WHEN COALESCE ([MCS].[Collection Result], [MCS].[Collection Result_2])
		IN (
			'AUS | AMBIL UANG SETORAN'
			,'AUS1 | AMBIL UANG SETORAN'
			,'JB | JANJI BAYAR'
			,'JB | JANJI BAYAR;JB | JANJI BAYAR'
		) THEN 1 ELSE 0 END
	) AS FLAG_PTP,
	SUM(CASE WHEN COALESCE ([MCS].[Collection Result], [MCS].[Collection Result_2])
		IN (
			'AUS | AMBIL UANG SETORAN'
			,'AUS1 | AMBIL UANG SETORAN'
			,'JB | JANJI BAYAR'
			,'JB | JANJI BAYAR;JB | JANJI BAYAR'
		) THEN 1 ELSE 0 END
	) AS INTENSITAS_PTP,
	MIN(CASE WHEN COALESCE ([MCS].[Collection Result], [MCS].[Collection Result_2])
		IN (
			'AUS | AMBIL UANG SETORAN'
			,'AUS1 | AMBIL UANG SETORAN'
			,'JB | JANJI BAYAR'
			,'JB | JANJI BAYAR;JB | JANJI BAYAR'
		) THEN TRY_CAST([MCS].[Submitted Date] AS DATE) END
	) AS TGL_AWAL_PTP,
	MAX(CASE WHEN COALESCE ([MCS].[Collection Result], [MCS].[Collection Result_2])
		IN (
			'AUS | AMBIL UANG SETORAN'
			,'AUS1 | AMBIL UANG SETORAN'
			,'JB | JANJI BAYAR'
			,'JB | JANJI BAYAR;JB | JANJI BAYAR'
		) THEN TRY_CAST(DATEADD(DAY, 7, [MCS].[Submitted Date]) AS DATE) END
	) AS TGL_AKHIR_PTP,
	SUM(CASE WHEN COALESCE ([MCS].[Collection Result], [MCS].[Collection Result_2])
		IS NOT NULL
		THEN 1 ELSE 0 END
	) AS INTENSITAS_INPUT
FROM
	[NEW_BSI_COLLECTION].[dbo].[COLLSYS.REPORT.MCS.COMPILE] [MCS]
LEFT JOIN [NEW_BSI_DEV].[dbo].[COLLSYS.MAPPING.LOAN] [MAPPING] ON [MAPPING].[SOURCE] = 'MCS'
AND [MAPPING].[NOLOAN] = [MCS].[Agreement No]
WHERE
	EOMONTH ([MCS].[Assignment Date]) = EOMONTH ('2022-06-30')
/*
AND COALESCE (
	[MCS].[Collection Result],
	[MCS].[Collection Result_2]
) IS NOT NULL
*/
GROUP BY
	EOMONTH ([MCS].[Assignment Date]),
	[MCS].[ARO ID],
	[MAPPING].[NOLOAN_FINAL],
	[MAPPING].[NOMORCIF]
ORDER BY
	EOMONTH ([MCS].[Assignment Date]),
	[MCS].[ARO ID],
	[MAPPING].[NOLOAN_FINAL],
	[MAPPING].[NOMORCIF];

----------------------------------------------------------------------------------------

UPDATE [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08]
SET
	[KODEOUTLET_BSI] = [SOURCE].[KODEOUTLET]
	,[DIVISI_BSI] = [SOURCE].[DIVISI]
	,[PRODUK_BSI] = [SOURCE].[PRODUK]
FROM [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08] [TARGET]
LEFT JOIN [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.LOAN_DETAIL] [SOURCE]
	ON [TARGET].[NOLOAN] = [SOURCE].[NOLOAN]
	AND [TARGET].[NOMORCIF] = [SOURCE].[NOMORCIF]
WHERE [SOURCE].[NOLOAN] IS NOT NULL;

----------------------------------------------------------------------------------------

UPDATE [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08]
SET
	[NAMANASABAH] = [SOURCE].[NAMANASABAH]
FROM [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08] [TARGET]
LEFT JOIN [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CIF_DETAIL] [SOURCE]
	ON [TARGET].[NOMORCIF] = [SOURCE].[NOMORCIF]
WHERE [SOURCE].[NOMORCIF] IS NOT NULL;

----------------------------------------------------------------------------------------

UPDATE [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08]
SET
	[NAMANASABAH] = [SOURCE].[NAMA]
	,[KODEOUTLET_BSI] = [SOURCE].[KODE OUTLET BSI]
	,[DIVISI_BSI] = [SOURCE].[DIVISI]
	,[PRODUK_BSI] = [SOURCE].[PRODUK BSI]
	,[KOL_LAST] = 'WO'
	,[KOL_FINAL] = 'WO'
	,[KOL_TERBURUK] = 'WO'
	,[KOL_PELAPORAN] = 'WO'
	,[OS_POKOK_PELAPORAN_BULAN_SEBELUM] = [SOURCE].[OS Pokok Last Month Conversion]
	,[OS_POKOK_PELAPORAN_CURRENT] = [SOURCE].[OS Pokok Current Conversion]
FROM [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08] [TARGET]
LEFT JOIN [NEW_BSI_STORAGE].[dbo].[WO.PORTOFOLIO_DAILY.2022-06-30] [SOURCE]
	ON [TARGET].[NOLOAN] = [SOURCE].[NOLOAN]
	AND [TARGET].[NOMORCIF] = [SOURCE].[CIF]
WHERE [SOURCE].[NOLOAN] IS NOT NULL;

----------------------------------------------------------------------------------------

UPDATE [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08]
SET
	[NAMANASABAH] = COALESCE([SOURCE].[(SOURCE) NAMANASABAH], [TARGET].[NAMANASABAH])
	,[KODEOUTLET_BSI] = COALESCE([SOURCE].[(RCG) KODECABANG_BSI], [TARGET].[KODEOUTLET_BSI])
	,[DIVISI_BSI] = COALESCE([SOURCE].[(RCG) DIVISI_BSI], [TARGET].[DIVISI_BSI])
	,[PRODUK_BSI] = COALESCE([SOURCE].[(EDA) PRODUK], [TARGET].[PRODUK_BSI])
	,[KOL_LAST] = COALESCE([SOURCE].[(RCG) KOL_CIF_LAST_MONTH], [TARGET].[KOL_LAST])
	,[KOL_FINAL] = COALESCE([SOURCE].[(RCG) KOL_CIF_PECAH], [TARGET].[KOL_FINAL])
	,[OS_POKOK_PELAPORAN_BULAN_SEBELUM] = COALESCE([SOURCE].[(RCG) OS_POKOK_PSAK_LAST_MONTH], [TARGET].[OS_POKOK_PELAPORAN_BULAN_SEBELUM])
	,[OS_POKOK_PELAPORAN_CURRENT] = COALESCE([SOURCE].[(RCG) OS_POKOK_PSAK_CURRENT], [TARGET].[OS_POKOK_PELAPORAN_CURRENT])
FROM [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08] [TARGET]
LEFT JOIN
		(
			SELECT
				COALESCE([MUTASI].[NOLOAN_AKHIR], [PORTO].[(SOURCE) NOLOAN_CURRENT]) AS [(SOURCE) NOLOAN_CURRENT]
				,COALESCE([MUTASI].[NOCIF_AKHIR], [PORTO].[(SOURCE) NOMORCIF_CURRENT]) AS [(SOURCE) NOMORCIF_CURRENT]
				,[PORTO].[(SOURCE) NAMANASABAH]
				,[PORTO].[(RCG) KODECABANG_BSI]
				,[PORTO].[(RCG) DIVISI_BSI]
				,[PORTO].[(EDA) PRODUK]
				,[PORTO].[(RCG) KOL_CIF_LAST_MONTH]
				,[PORTO].[(RCG) KOL_CIF_PECAH]
				,[PORTO].[(RCG) OS_POKOK_PSAK_LAST_MONTH]
				,[PORTO].[(RCG) OS_POKOK_PSAK_CURRENT]
			FROM [NEW_BSI_STORAGE].[dbo].[BSI.PORTOFOLIO_DAILY.2022-06-30 (EDA)] [PORTO]
			LEFT JOIN [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.MAPPING.JOIN.REKAP_NOLOAN.MUTASI_NOLOAN_CURRENT] [MUTASI]
				ON [PORTO].[(SOURCE) NOLOAN_CURRENT] = [MUTASI].[NOLOAN_CURRENT]
				AND [PORTO].[(SOURCE) NOMORCIF_CURRENT] = [MUTASI].[NOCIF_CURRENT]
		)[SOURCE]
	ON [TARGET].[NOLOAN] = [SOURCE].[(SOURCE) NOLOAN_CURRENT]
	AND [TARGET].[NOMORCIF] = [SOURCE].[(SOURCE) NOMORCIF_CURRENT]
WHERE [SOURCE].[(SOURCE) NOLOAN_CURRENT] IS NOT NULL;

----------------------------------------------------------------------------------------

UPDATE [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08]
SET
	[SELISIH_OS_POKOK] = COALESCE([OS_POKOK_PELAPORAN_BULAN_SEBELUM], 0.00) - COALESCE([OS_POKOK_PELAPORAN_CURRENT], 0.00);

----------------------------------------------------------------------------------------

UPDATE [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08]
SET
	NamaOutlet_BSI = COALESCE([SOURCE].[Nama Outlet], [TARGET].NamaOutlet_BSI)
	,Area_BSI = COALESCE([SOURCE].[Nama Area], [TARGET].Area_BSI)
	,Region_BSI = COALESCE([SOURCE].[Nama RO], [TARGET].Region_BSI)
FROM [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08] [TARGET]
LEFT JOIN [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_JOIN.MAPPING.JOIN.CABANG_BSI_UPDATE] [SOURCE]
	ON [TARGET].KodeOutlet_BSI = [SOURCE].[Kode Outlet]
WHERE [SOURCE].[Kode Outlet] IS NOT NULL;

----------------------------------------------------------------------------------------

UPDATE [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08]
SET
	KOL_LAST = COALESCE([SOURCE].[KOL_LAST], [TARGET].KOL_LAST)
	,KOL_FINAL = COALESCE([SOURCE].[KOL_CURRENT], [TARGET].KOL_FINAL)
	,KOL_TERBURUK = COALESCE([SOURCE].[KOL_TERBURUK_HARIAN], [TARGET].KOL_TERBURUK)
FROM [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08] [TARGET]
LEFT JOIN
		(
			SELECT
				COALESCE([MAPPING].NOLOAN_AKHIR, [SOURCE].[NOLOAN_AKHIR]) AS [NOLOAN_AKHIR]
				,COALESCE([MAPPING].NOCIF_AKHIR, [SOURCE].[NOMORCIF_CURRENT]) AS [NOMORCIF_AKHIR]
				,[SOURCE].[KOL_LAST]
				,[SOURCE].[KOL_CURRENT]
				,[SOURCE].[KOL_TERBURUK_HARIAN]
			FROM [NEW_BSI_STORAGE].[dbo].[BSI.KOL_DAILY.2022-06-30 (EDA)] [SOURCE]
			LEFT JOIN [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.MAPPING.JOIN.REKAP_NOLOAN.MUTASI_NOLOAN_CURRENT] [MAPPING]
				ON [SOURCE].[NOLOAN_CURRENT] = [MAPPING].[NOLOAN_CURRENT]
				AND [SOURCE].[NOMORCIF_CURRENT] = [MAPPING].[NOCIF_CURRENT]
		)[SOURCE]
	ON [TARGET].NOLOAN = [SOURCE].[NOLOAN_AKHIR]
	AND [TARGET].NOMORCIF = [SOURCE].[NOMORCIF_AKHIR]
WHERE [SOURCE].[NOLOAN_AKHIR] IS NOT NULL;

----------------------------------------------------------------------------------------

UPDATE [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08]
SET
	KOL_PELAPORAN = COALESCE((
		SELECT MAX(KOL) AS KOL
		FROM (
			VALUES
			([SOURCE].[KOL_LAST])
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '01' THEN KOL_01 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '02' THEN KOL_02 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '03' THEN KOL_03 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '04' THEN KOL_04 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '05' THEN KOL_05 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '06' THEN KOL_06 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '07' THEN KOL_07 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '08' THEN KOL_08 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '09' THEN KOL_09 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '10' THEN KOL_10 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '11' THEN KOL_11 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '12' THEN KOL_12 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '13' THEN KOL_13 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '14' THEN KOL_14 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '15' THEN KOL_15 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '16' THEN KOL_16 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '17' THEN KOL_17 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '18' THEN KOL_18 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '19' THEN KOL_19 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '20' THEN KOL_20 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '21' THEN KOL_21 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '22' THEN KOL_22 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '23' THEN KOL_23 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '24' THEN KOL_24 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '25' THEN KOL_25 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '26' THEN KOL_26 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '27' THEN KOL_27 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '28' THEN KOL_28 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '29' THEN KOL_29 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '30' THEN KOL_30 END)
			,(CASE WHEN RIGHT(DATEADD(DAY, -7, TGL_AKHIR_PTP), 2) >= '31' THEN KOL_31 END)
		) AS TB_TEMP(KOL)
	), [TARGET].KOL_PELAPORAN)
FROM [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08] [TARGET]
LEFT JOIN
		(
			SELECT
				COALESCE([MAPPING].NOLOAN_AKHIR, [SOURCE].[NOLOAN_AKHIR]) AS [NOLOAN_AKHIR]
				,COALESCE([MAPPING].NOCIF_AKHIR, [SOURCE].[NOMORCIF_CURRENT]) AS [NOMORCIF_AKHIR]
				,[SOURCE].[KOL_LAST]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_01], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_01]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_02], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_02]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_03], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_03]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_04], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_04]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_05], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_05]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_06], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_06]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_07], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_07]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_08], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_08]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_09], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_09]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_10], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_10]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_11], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_11]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_12], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_12]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_13], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_13]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_14], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_14]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_15], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_15]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_16], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_16]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_17], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_17]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_18], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_18]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_19], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_19]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_20], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_20]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_21], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_21]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_22], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_22]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_23], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_23]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_24], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_24]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_25], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_25]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_26], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_26]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_27], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_27]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_28], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_28]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_29], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_29]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_30], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_30]
				,(NULLIF(NULLIF(NULLIF([SOURCE].[KOL_31], 'Lunas'), 'Suspect'), 'WO')) AS [KOL_31]
			FROM [NEW_BSI_STORAGE].[dbo].[BSI.KOL_DAILY.2022-06-30 (EDA)] [SOURCE]
			LEFT JOIN [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.MAPPING.JOIN.REKAP_NOLOAN.MUTASI_NOLOAN_CURRENT] [MAPPING]
				ON [SOURCE].[NOLOAN_CURRENT] = [MAPPING].[NOLOAN_CURRENT]
				AND [SOURCE].[NOMORCIF_CURRENT] = [MAPPING].[NOCIF_CURRENT]
		)[SOURCE]
	ON [TARGET].NOLOAN = [SOURCE].[NOLOAN_AKHIR]
	AND [TARGET].NOMORCIF = [SOURCE].[NOMORCIF_AKHIR]
WHERE [SOURCE].[NOLOAN_AKHIR] IS NOT NULL
AND [TARGET].TGL_AWAL_PTP IS NOT NULL
AND [TARGET].TGL_AKHIR_PTP IS NOT NULL;

----------------------------------------------------------------------------------------
/*
UPDATE [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08]
SET
	NOMINAL_POKOK =
		(
			SELECT SUM([Pembayaran Pokok]) AS [Pembayaran Pokok]
			FROM (VALUES ([SOURCE].[Pembayaran Pokok])) AS TEMP_TB([Pembayaran Pokok])
		)
	,NOMINAL_MARGIN =
		(
			SELECT SUM([Pembayaran Margin]) AS [Pembayaran Margin]
			FROM (VALUES ([SOURCE].[Pembayaran Margin])) AS TEMP_TB([Pembayaran Margin])
		)
	,NOMINAL_BASIL =
		(
			SELECT SUM([Pembayaran Basil]) AS [Pembayaran Basil]
			FROM (VALUES ([SOURCE].[Pembayaran Basil])) AS TEMP_TB([Pembayaran Basil])
		)
	,NOMINAL_BAYAR =
		(
			SELECT SUM([Total Pembayaran]) AS [Total Pembayaran]
			FROM (VALUES ([SOURCE].[Total Pembayaran])) AS TEMP_TB([Total Pembayaran])
		)
FROM [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08] [TARGET]
LEFT JOIN
		(
			SELECT
				COALESCE([MAPPING].NOLOAN_AKHIR, [SOURCE].[NOLOAN]) AS [NOLOAN_AKHIR]
				,COALESCE([MAPPING].NOCIF_AKHIR, [SOURCE].[NOMORCIF]) AS [NOMORCIF_AKHIR]
				,[Tgl Data]
				,[Pembayaran Pokok]
				,[Pembayaran Margin]
				,[Pembayaran Basil]
				,[Total Pembayaran]
			FROM [NEW_BSI_COLLECTION].[dbo].[COLLSYS.GENERATED.JOIN.DAILY_PAYMENT] [SOURCE]
			LEFT JOIN [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.MAPPING.JOIN.REKAP_NOLOAN.MUTASI_NOLOAN_CURRENT] [MAPPING]
				ON [SOURCE].[NOLOAN] = [MAPPING].[NOLOAN_CURRENT]
				AND [SOURCE].[NOMORCIF] = [MAPPING].[NOCIF_CURRENT]
		) [SOURCE]
	ON [TARGET].NOLOAN = [SOURCE].[NOLOAN_AKHIR]
	AND [TARGET].NOMORCIF = [SOURCE].[NOMORCIF_AKHIR]
	AND [SOURCE].[Tgl Data] BETWEEN COALESCE([TARGET].[TGL_AWAL_PTP], '1900-01-01') AND COALESCE([TARGET].[TGL_AKHIR_PTP], '1900-01-01')
WHERE [SOURCE].[NOLOAN_AKHIR] IS NOT NULL
AND [TARGET].TGL_AWAL_PTP IS NOT NULL
AND [TARGET].TGL_AKHIR_PTP IS NOT NULL;
*/
----------------------------------------------------------------------------------------

UPDATE [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08]
SET
	NOMINAL_POKOK = [SOURCE].[Pembayaran Pokok]
	,NOMINAL_MARGIN = [SOURCE].[Pembayaran Margin]
	,NOMINAL_BASIL = [SOURCE].[Pembayaran Basil]
	,NOMINAL_BAYAR = [SOURCE].[Total Pembayaran]
FROM [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08] [TARGET]
OUTER APPLY
		(
			SELECT
				SUM([Pembayaran Pokok]) AS [Pembayaran Pokok]
				,SUM([Pembayaran Margin]) AS [Pembayaran Margin]
				,SUM([Pembayaran Basil]) AS [Pembayaran Basil]
				,SUM([Total Pembayaran]) AS [Total Pembayaran]
			FROM [NEW_BSI_COLLECTION].[dbo].[COLLSYS.GENERATED.JOIN.DAILY_PAYMENT] [SOURCE]
			LEFT JOIN [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.MAPPING.JOIN.REKAP_NOLOAN.MUTASI_NOLOAN_CURRENT] [MAPPING]
				ON [SOURCE].[NOLOAN] = [MAPPING].[NOLOAN_CURRENT]
				AND [SOURCE].[NOMORCIF] = [MAPPING].[NOCIF_CURRENT]
			WHERE
				COALESCE([MAPPING].NOLOAN_AKHIR, [SOURCE].[NOLOAN]) = [TARGET].[NOLOAN]
				AND COALESCE([MAPPING].NOCIF_AKHIR, [SOURCE].[NOMORCIF]) = [TARGET].[NOMORCIF]
				AND [SOURCE].[Tgl Data] BETWEEN COALESCE([TARGET].[TGL_AWAL_PTP], '1900-01-01') AND COALESCE([TARGET].[TGL_AKHIR_PTP], '1900-01-01')
		) [SOURCE]
WHERE [TARGET].TGL_AWAL_PTP IS NOT NULL
AND [TARGET].TGL_AKHIR_PTP IS NOT NULL;

----------------------------------------------------------------------------------------

UPDATE [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08]
SET
	KOL_PELAPORAN = KOL_LAST
WHERE KOL_PELAPORAN IS NULL;

----------------------------------------------------------------------------------------

UPDATE [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08]
SET
	FLAG_PEMBAYARAN =
		CASE
			WHEN TGL_AWAL_PTP IS NULL THEN 'BUKAN PTP'
			WHEN TGL_AWAL_PTP IS NOT NULL AND KOL_PELAPORAN = 'WO' AND NOMINAL_BAYAR >= 100000 THEN 'PROMISE KEEP'
			WHEN TGL_AWAL_PTP IS NOT NULL AND KOL_PELAPORAN != 'WO' AND NOMINAL_BAYAR >= 50000 THEN 'PROMISE KEEP'
			ELSE 'BROKEN PROMISE'
		END;
	
----------------------------------------------------------------------------------------

SELECT * FROM [NEW_BSI_REQUEST].[dbo].[REQUEST.FAIZ.2022-08-08];
