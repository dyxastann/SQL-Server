
SELECT
	[TARGET].[LEGACY]
	,[TARGET].[NOLOAN]
	,[TARGET].[DIVISI] AS [DIVISI_SOURCE]
	,[TARGET].[PRODUK] AS [PRODUK_SOURCE]
	,[TARGET].[PRODUK_DETAIL] AS [PRODUK_DETAIL_SOURCE]
	,[CLEANER].[DIVISI] AS [DIVISI_CLEANER]
	,[CLEANER].[PRODUK] AS [PRODUK_CLEANER]
	,[CLEANER].[PRODUK_DETAIL] AS [PRODUK_DETAIL_CLEANER]
	,[SOURCE].[ACCT]

/*
UPDATE [PORTOFOLIO.ONBS.LOAN_DETAIL]
SET
	[PRODUK] = COALESCE([CLEANER].[PRODUK], [TARGET].[PRODUK])
	,[PRODUK_DETAIL] = COALESCE([CLEANER].[PRODUK_DETAIL], [TARGET].[PRODUK_DETAIL])
*/
FROM
	(
		SELECT
			LEGACY
			,NOLOAN
			,COUNT(NOLOAN) AS ACCT
		FROM [PORTOFOLIO.ONBS.LOAN_DETAIL]
		GROUP BY
			LEGACY
			,NOLOAN
		HAVING COUNT(NOLOAN) > 1
	) [SOURCE]
LEFT JOIN [PORTOFOLIO.ONBS.LOAN_DETAIL] [TARGET]
	ON [TARGET].[LEGACY] = [SOURCE].[LEGACY]
	AND [TARGET].[NOLOAN] = [SOURCE].[NOLOAN]
LEFT JOIN
	(
		SELECT
			LEGACY
			,NOLOAN
			,DIVISI
			,PRODUK
			,PRODUK_DETAIL
			,ROW_NUMBER() OVER (
				PARTITION BY
					LEGACY
					,NOLOAN
				ORDER BY
					PRODUK_DETAIL DESC
					,PRODUK DESC
					,DIVISI DESC
			) AS ACCT
		FROM [PORTOFOLIO.ONBS.LOAN_DETAIL]
	) [CLEANER]
	ON [SOURCE].[LEGACY] = [CLEANER].[LEGACY]
	AND [SOURCE].[NOLOAN] = [CLEANER].[NOLOAN]
	AND [CLEANER].[ACCT] = 1
WHERE
	(
	COALESCE([TARGET].[DIVISI], 'X') != COALESCE([CLEANER].[DIVISI], 'X')
	OR COALESCE([TARGET].[PRODUK], 'X') != COALESCE([CLEANER].[PRODUK], 'X')
	OR COALESCE([TARGET].[PRODUK_DETAIL], 'X') != COALESCE([CLEANER].[PRODUK_DETAIL], 'X')
	)
/*
	AND [TARGET].[DIVISI] = 'Hasanah Card'
	AND [SOURCE].[ACCT] > 1
*/
ORDER BY
	[SOURCE].[ACCT] DESC
	,[TARGET].[DIVISI] DESC
	,[TARGET].[PRODUK] DESC
	,[TARGET].[PRODUK_DETAIL] DESC
