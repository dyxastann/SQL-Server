SELECT
	[SOURCE].*
	,[NOMORCIF].[ACCT] AS [ACCT_NOMORCIF]
	,[SUPERCIF].[ACCT] AS [ACCT_SUPERCIF]
	,[KOL_NOMORCIF].[KOL] AS [KOL_NOMORCIF]
	,[KOL_SUPERCIF].[KOL] AS [KOL_SUPERCIF]
FROM [PORTOFOLIO.ONBS.SUSPECT_SUPERCIF] [SOURCE]
OUTER APPLY
	(
		SELECT
			COUNT(1) AS [ACCT]
		FROM [PORTOFOLIO.ONBS.SUSPECT_SUPERCIF]
		WHERE NOMORCIF = [SOURCE].[NOMORCIF]
		GROUP BY NOMORCIF
	) [NOMORCIF]
OUTER APPLY
	(
		SELECT
			COUNT(1) AS [ACCT]
		FROM [PORTOFOLIO.ONBS.SUSPECT_SUPERCIF]
		WHERE SUPERCIF = [SOURCE].[SUPERCIF]
		GROUP BY SUPERCIF
	) [SUPERCIF]
OUTER APPLY
	(
		SELECT
			MAX(KOL) AS [KOL]
		FROM
			(
				SELECT
					[(RCG) KOL_CIF_PECAH] AS KOL
				--FROM [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.GENERATED.JOIN.PORTOFOLIO_CURRENT] [TARGET]
				FROM [NEW_BSI_STORAGE].[dbo].[BSI.PORTOFOLIO_DAILY.2022-09-30 (QC)] [TARGET]
				WHERE [SOURCE].[NOMORCIF] = [TARGET].[(SOURCE) NOMORCIF_CURRENT]
				AND [TARGET].[(RCG) KOL_CIF_PECAH] NOT IN ('Lunas', 'Suspect', 'WO')

				UNION

				SELECT
					'WO' AS KOL
				FROM [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_WO.GENERATED.JOIN.WO_CURRENT] [TARGET]
				WHERE [SOURCE].[NOMORCIF] = [TARGET].[CIF]
			) [KOL]
	) [KOL_NOMORCIF]
OUTER APPLY
	(
		SELECT
			MAX(KOL) AS [KOL]
		FROM
			(
				SELECT
					[(RCG) KOL_CIF_PECAH] AS KOL
				--FROM [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.GENERATED.JOIN.PORTOFOLIO_CURRENT] [TARGET]
				FROM [NEW_BSI_STORAGE].[dbo].[BSI.PORTOFOLIO_DAILY.2022-09-30 (QC)] [TARGET]
				WHERE [SOURCE].[SUPERCIF] = [TARGET].[(SOURCE) NOMORCIF_CURRENT]
				AND [TARGET].[(RCG) KOL_CIF_PECAH] NOT IN ('Lunas', 'Suspect', 'WO')

				UNION

				SELECT
					'WO' AS KOL
				FROM [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_WO.GENERATED.JOIN.WO_CURRENT] [TARGET]
				WHERE [SOURCE].[SUPERCIF] = [TARGET].[CIF]
			) [KOL]
	) [KOL_SUPERCIF]
WHERE
	([NOMORCIF].[ACCT] = 1 OR [SUPERCIF].[ACCT] = 1)
	AND
		(
			(
				--LEFT([KOL_SUPERCIF].[KOL], 1) IN ('2', '3', '4', '5', 'W')
				--AND [KOL_NOMORCIF].[KOL] IS NOT NULL
				[KOL_NOMORCIF].[KOL] IS NOT NULL
			)
			AND
			(
				--LEFT([KOL_NOMORCIF].[KOL], 1) IN ('2', '3', '4', '5', 'W')
				--AND [KOL_SUPERCIF].[KOL] IS NOT NULL
				[KOL_SUPERCIF].[KOL] IS NOT NULL
			)
		)
	AND [SOURCE].[POIN] >= 6
ORDER BY
	[SOURCE].[POIN] DESC
	,[NOMORCIF].[ACCT] ASC
	,[SUPERCIF].[ACCT] ASC
	,[SOURCE].[NAMANASABAH] ASC
	,[SOURCE].[NOMORCIF] ASC
	,[SOURCE].[SUPERCIF] ASC
