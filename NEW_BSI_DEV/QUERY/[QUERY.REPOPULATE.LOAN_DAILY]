TRUNCATE TABLE [PORTOFOLIO.ONBS.LIST_LOAN];

------------------------------------------HASANAH CARD------------------------------------------
MERGE [PORTOFOLIO.ONBS.LIST_LOAN] [TARGET]
USING 
	(
		SELECT
			*
		FROM [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.SOURCE.BNIS.HASANAH_CARD]
		WHERE TRY_CAST(CURRBAL AS DECIMAL(32, 2)) > 0.00
		AND (PB IN ('B', 'C', 'D', 'E', 'F', 'H', 'J', 'L', 'M', 'N', 'P', 'Q', 'T', 'U', 'W', 'Y') OR PB IS NULL)
		AND POSTFLG IN ('PP', 'SP')
	) [SOURCE]
	ON [TARGET].NOLOAN = [SOURCE].[CARDNO]
	AND [TARGET].CARD_NO = [SOURCE].[CARDNO_REAL]
	AND [TARGET].NOMORCIF = [SOURCE].[CUSTNO]
	AND [TARGET].[LEGACY] = 'BNIS'
WHEN MATCHED THEN UPDATE
SET
	[TGL_DATA] = [SOURCE].FILE_DATE
	,[LEGACY] = 'BNIS'
	,[KODEOUTLET] = 'ID0010001'
	,[CURRENCY] = 'IDR'
	,[JENISPIUTANGPEMBIAYAAN] = 'Qard, Kafalah, Ijarah'
	,[DAYPASTDUE] = CASE
			WHEN [SOURCE].DPD = '0' THEN 0
			ELSE (CASE WHEN RIGHT([SOURCE].FILE_DATE, 2) < [SOURCE].CYCLE THEN RIGHT([SOURCE].FILE_DATE, 2) + DATEPART(day, EOMONTH(DATEADD(MONTH, -1, [SOURCE].FILE_DATE))) ELSE RIGHT([SOURCE].FILE_DATE, 2) END) - [SOURCE].CYCLE + COALESCE(NULLIF([SOURCE].DPD, 'XDY'), 0)
		END
	,[TGL_CAIR] = [SOURCE].OPDT
	,[DIVISI] = 'Hasanah Card'
	,[KOL_LOAN] = CASE
			WHEN [SOURCE].GOL = 'GOL_01' THEN '1'
			WHEN [SOURCE].GOL = 'GOL_02' AND [SOURCE].BUCKET = '02_XDY' THEN '2A'
			WHEN [SOURCE].GOL = 'GOL_02' AND [SOURCE].BUCKET = '03_D30' THEN '2B'
			WHEN [SOURCE].GOL = 'GOL_02' AND [SOURCE].BUCKET = '04_D60' THEN '2C'
			WHEN [SOURCE].GOL = 'GOL_03' AND
				(CASE WHEN RIGHT([SOURCE].FILE_DATE, 2) < [SOURCE].CYCLE THEN RIGHT([SOURCE].FILE_DATE, 2) + DATEPART(day, EOMONTH(DATEADD(MONTH, -1, [SOURCE].FILE_DATE))) ELSE RIGHT([SOURCE].FILE_DATE, 2) END) - [SOURCE].CYCLE <= 10 THEN '3A'
			WHEN [SOURCE].GOL = 'GOL_03' AND
				(CASE WHEN RIGHT([SOURCE].FILE_DATE, 2) < [SOURCE].CYCLE THEN RIGHT([SOURCE].FILE_DATE, 2) + DATEPART(day, EOMONTH(DATEADD(MONTH, -1, [SOURCE].FILE_DATE))) ELSE RIGHT([SOURCE].FILE_DATE, 2) END) - [SOURCE].CYCLE <= 20 THEN '3B'
			WHEN [SOURCE].GOL = 'GOL_03' AND
				(CASE WHEN RIGHT([SOURCE].FILE_DATE, 2) < [SOURCE].CYCLE THEN RIGHT([SOURCE].FILE_DATE, 2) + DATEPART(day, EOMONTH(DATEADD(MONTH, -1, [SOURCE].FILE_DATE))) ELSE RIGHT([SOURCE].FILE_DATE, 2) END) - [SOURCE].CYCLE > 20 THEN '3C'
			WHEN [SOURCE].GOL = 'GOL_04' AND [SOURCE].BUCKET = '06_120' THEN '4A'
			WHEN [SOURCE].GOL = 'GOL_04' AND
				(CASE WHEN RIGHT([SOURCE].FILE_DATE, 2) < [SOURCE].CYCLE THEN RIGHT([SOURCE].FILE_DATE, 2) + DATEPART(day, EOMONTH(DATEADD(MONTH, -1, [SOURCE].FILE_DATE))) ELSE RIGHT([SOURCE].FILE_DATE, 2) END) - [SOURCE].CYCLE <= 15 THEN '4B'
			WHEN [SOURCE].GOL = 'GOL_04' AND
				(CASE WHEN RIGHT([SOURCE].FILE_DATE, 2) < [SOURCE].CYCLE THEN RIGHT([SOURCE].FILE_DATE, 2) + DATEPART(day, EOMONTH(DATEADD(MONTH, -1, [SOURCE].FILE_DATE))) ELSE RIGHT([SOURCE].FILE_DATE, 2) END) - [SOURCE].CYCLE > 15 THEN '4C'
			WHEN [SOURCE].GOL = 'GOL_05' THEN '5'
			ELSE CONCAT(RIGHT([SOURCE].GOL, 1), 'A')
		END
	,[SISA_POKOK] = NEW_BSI_COLLECTION.dbo.fx_common_zerofy([SOURCE].MLAP)
	,[SISA_MARGIN] = NEW_BSI_COLLECTION.dbo.fx_common_zerofy(NEW_BSI_COLLECTION.dbo.fx_common_zerofy([SOURCE].[CURRBAL])- NEW_BSI_COLLECTION.dbo.fx_common_zerofy([SOURCE].[MLAP]))
WHEN NOT MATCHED BY TARGET THEN
INSERT
	(
		[TGL_DATA] ,
		[LEGACY] ,
		[NOLOAN] ,
		[CARD_NO] ,
		[NOMORCIF] ,
		[KODEOUTLET] ,
		[CURRENCY] ,
		[JENISPIUTANGPEMBIAYAAN] ,
		[DAYPASTDUE] ,
		[TGL_CAIR] ,
		[DIVISI] ,
		[KOL_LOAN] ,
		[SISA_POKOK] ,
		[SISA_MARGIN]
	)
VALUES
	(
		[SOURCE].FILE_DATE
		,'BNIS'
		,[SOURCE].CARDNO
		,[SOURCE].CARDNO_REAL
		,[SOURCE].CUSTNO
		,'ID0010001'
		,'IDR'
		,'Qard, Kafalah, Ijarah'
		,CASE
			WHEN [SOURCE].DPD = '0' THEN 0
			ELSE (CASE WHEN RIGHT([SOURCE].FILE_DATE, 2) < [SOURCE].CYCLE THEN RIGHT([SOURCE].FILE_DATE, 2) + DATEPART(day, EOMONTH(DATEADD(MONTH, -1, [SOURCE].FILE_DATE))) ELSE RIGHT([SOURCE].FILE_DATE, 2) END) - [SOURCE].CYCLE + COALESCE(NULLIF([SOURCE].DPD, 'XDY'), 0)
		END
		,[SOURCE].OPDT
		,'Hasanah Card'
		,CASE
			WHEN [SOURCE].GOL = 'GOL_01' THEN '1'
			WHEN [SOURCE].GOL = 'GOL_02' AND [SOURCE].BUCKET = '02_XDY' THEN '2A'
			WHEN [SOURCE].GOL = 'GOL_02' AND [SOURCE].BUCKET = '03_D30' THEN '2B'
			WHEN [SOURCE].GOL = 'GOL_02' AND [SOURCE].BUCKET = '04_D60' THEN '2C'
			WHEN [SOURCE].GOL = 'GOL_03' AND
				(CASE WHEN RIGHT([SOURCE].FILE_DATE, 2) < [SOURCE].CYCLE THEN RIGHT([SOURCE].FILE_DATE, 2) + DATEPART(day, EOMONTH(DATEADD(MONTH, -1, [SOURCE].FILE_DATE))) ELSE RIGHT([SOURCE].FILE_DATE, 2) END) - [SOURCE].CYCLE <= 10 THEN '3A'
			WHEN [SOURCE].GOL = 'GOL_03' AND
				(CASE WHEN RIGHT([SOURCE].FILE_DATE, 2) < [SOURCE].CYCLE THEN RIGHT([SOURCE].FILE_DATE, 2) + DATEPART(day, EOMONTH(DATEADD(MONTH, -1, [SOURCE].FILE_DATE))) ELSE RIGHT([SOURCE].FILE_DATE, 2) END) - [SOURCE].CYCLE <= 20 THEN '3B'
			WHEN [SOURCE].GOL = 'GOL_03' AND
				(CASE WHEN RIGHT([SOURCE].FILE_DATE, 2) < [SOURCE].CYCLE THEN RIGHT([SOURCE].FILE_DATE, 2) + DATEPART(day, EOMONTH(DATEADD(MONTH, -1, [SOURCE].FILE_DATE))) ELSE RIGHT([SOURCE].FILE_DATE, 2) END) - [SOURCE].CYCLE > 20 THEN '3C'
			WHEN [SOURCE].GOL = 'GOL_04' AND [SOURCE].BUCKET = '06_120' THEN '4A'
			WHEN [SOURCE].GOL = 'GOL_04' AND
				(CASE WHEN RIGHT([SOURCE].FILE_DATE, 2) < [SOURCE].CYCLE THEN RIGHT([SOURCE].FILE_DATE, 2) + DATEPART(day, EOMONTH(DATEADD(MONTH, -1, [SOURCE].FILE_DATE))) ELSE RIGHT([SOURCE].FILE_DATE, 2) END) - [SOURCE].CYCLE <= 15 THEN '4B'
			WHEN [SOURCE].GOL = 'GOL_04' AND
				(CASE WHEN RIGHT([SOURCE].FILE_DATE, 2) < [SOURCE].CYCLE THEN RIGHT([SOURCE].FILE_DATE, 2) + DATEPART(day, EOMONTH(DATEADD(MONTH, -1, [SOURCE].FILE_DATE))) ELSE RIGHT([SOURCE].FILE_DATE, 2) END) - [SOURCE].CYCLE > 15 THEN '4C'
			WHEN [SOURCE].GOL = 'GOL_05' THEN '5'
			ELSE CONCAT(RIGHT([SOURCE].GOL, 1), 'A')
		END
		,NEW_BSI_COLLECTION.dbo.fx_common_zerofy([SOURCE].MLAP)
		,NEW_BSI_COLLECTION.dbo.fx_common_zerofy(NEW_BSI_COLLECTION.dbo.fx_common_zerofy([SOURCE].[CURRBAL])- NEW_BSI_COLLECTION.dbo.fx_common_zerofy([SOURCE].[MLAP]))
	);

------------------------------------------BSM LOAN DAILY------------------------------------------

MERGE [PORTOFOLIO.ONBS.LIST_LOAN] [TARGET]
USING
	(
		SELECT
			*
		FROM [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.SOURCE.BSM.LOAN_DAILY]
		WHERE NOLOAN IS NOT NULL
		AND TRY_CAST(FICMISDATE AS DATE) IS NOT NULL
	) [SOURCE]
	ON [TARGET].[NOLOAN] = [SOURCE].[NOLOAN]
	AND [TARGET].[NOMORCIF] = [SOURCE].[NOMORCIF]
	AND [TARGET].[LEGACY] = 'BSM'
WHEN MATCHED THEN UPDATE
SET
	[TGL_DATA] = COALESCE([SOURCE].FICMISDATE, [TARGET].[TGL_DATA])
	,[LEGACY] = 'BSM'
	,[KODEOUTLET] = COALESCE([SOURCE].KODECABANGBARU, [TARGET].[KODEOUTLET])
	,[CURRENCY] = COALESCE([SOURCE].[CURRENCY], [TARGET].[CURRENCY])
	,[JENISPIUTANGPEMBIAYAAN] = COALESCE([SOURCE].[JENISPIUTANGPEMBIAYAAN], [TARGET].[JENISPIUTANGPEMBIAYAAN])
	,[DAYPASTDUE] = COALESCE([SOURCE].[DAYPASTDUE], [TARGET].[DAYPASTDUE])
	,[TGL_CAIR] = COALESCE([SOURCE].TGLPENCAIRAN, [TARGET].[TGL_CAIR])
	,[TGL_JT_TEMPO] = COALESCE([SOURCE].TGLJTTEMPO, [TARGET].[TGL_JT_TEMPO])
	,[DIVISI] = COALESCE([SOURCE].[DIVISI], [TARGET].[DIVISI])
	,[KOL_LOAN] = COALESCE([SOURCE].KOLBSM, [TARGET].[KOL_LOAN])
	,[KOL_CIF] = COALESCE([SOURCE].KOLCIF, [TARGET].[KOL_CIF])
	,[CAIR_POKOK] = COALESCE([SOURCE].PENCAIRANPOKOKCONVERSION, [TARGET].[CAIR_POKOK])
	,[CAIR_MARGIN] = COALESCE([SOURCE].PENCAIRANMARGINCONVERSION, [TARGET].[CAIR_MARGIN])
	,[SISA_POKOK] = COALESCE([SOURCE].OSPOKOKCONVERSION, [TARGET].[SISA_POKOK])
	,[SISA_MARGIN] = COALESCE([SOURCE].OSMARGINCONVERSION, [TARGET].[SISA_MARGIN])
	,[REALISASI_BASIL] = COALESCE([SOURCE].REALISASI_BAGIHASIL, [TARGET].[REALISASI_BASIL])
	,[PROYEKSI_BASIL] = COALESCE([SOURCE].PROYEKSI_BAGIHASIL, [TARGET].[PROYEKSI_BASIL])
WHEN NOT MATCHED BY TARGET THEN
INSERT
	(
		[TGL_DATA] ,
		[LEGACY] ,
		[NOLOAN] ,
		--[CARD_NO] ,
		[NOMORCIF] ,
		[KODEOUTLET] ,
		[CURRENCY] ,
		[JENISPIUTANGPEMBIAYAAN] ,
		[DAYPASTDUE] ,
		[TGL_CAIR] ,
		[TGL_JT_TEMPO] ,
		[DIVISI] ,
		[KOL_LOAN] ,
		[KOL_CIF] ,
		[CAIR_POKOK] ,
		[CAIR_MARGIN] ,
		[SISA_POKOK] ,
		[SISA_MARGIN] ,
		[REALISASI_BASIL] ,
		[PROYEKSI_BASIL]
	)
VALUES
	(
		[SOURCE].FICMISDATE
		,'BSM'
		,[SOURCE].NOLOAN
		,[SOURCE].NOMORCIF
		,[SOURCE].KODECABANGBARU
		,[SOURCE].CURRENCY
		,[SOURCE].JENISPIUTANGPEMBIAYAAN
		,[SOURCE].DAYPASTDUE
		,[SOURCE].TGLPENCAIRAN
		,[SOURCE].TGLJTTEMPO
		,[SOURCE].DIVISI
		,[SOURCE].KOLBSM
		,[SOURCE].KOLCIF
		,[SOURCE].PENCAIRANPOKOKCONVERSION
		,[SOURCE].PENCAIRANMARGINCONVERSION
		,[SOURCE].OSPOKOKCONVERSION
		,[SOURCE].OSMARGINCONVERSION
		,[SOURCE].REALISASI_BAGIHASIL
		,[SOURCE].PROYEKSI_BAGIHASIL
	);

------------------------------------------BSM JFAST------------------------------------------

MERGE [PORTOFOLIO.ONBS.LIST_LOAN] [TARGET]
USING
	(
		SELECT
			*
		FROM [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.SOURCE.BSM.IFOS_JFAST]
		WHERE NOLOAN IS NOT NULL
		AND TRY_CAST(FICMISDATE AS DATE) IS NOT NULL
	) [SOURCE]
	ON [TARGET].[NOLOAN] = [SOURCE].[NOLOAN]
	AND [TARGET].[NOMORCIF] = [SOURCE].[NOMORCIF]
	AND [TARGET].[LEGACY] = 'BSM'
WHEN MATCHED THEN UPDATE
SET
	[TGL_DATA] = COALESCE([SOURCE].FICMISDATE, [TARGET].[TGL_DATA])
	,[LEGACY] = 'BSM'
	,[KODEOUTLET] = COALESCE([SOURCE].KODECABANGBARU, [TARGET].[KODEOUTLET])
	,[CURRENCY] = COALESCE([SOURCE].[CURRENCY], [TARGET].[CURRENCY])
	,[JENISPIUTANGPEMBIAYAAN] = COALESCE([SOURCE].[JENISPIUTANGPEMBIAYAAN], [TARGET].[JENISPIUTANGPEMBIAYAAN])
	,[DAYPASTDUE] = COALESCE([SOURCE].[DAYPASTDUE], [TARGET].[DAYPASTDUE])
	,[TGL_CAIR] = COALESCE([SOURCE].TGLPENCAIRAN, [TARGET].[TGL_CAIR])
	,[TGL_JT_TEMPO] = COALESCE([SOURCE].TGLJTTEMPO, [TARGET].[TGL_JT_TEMPO])
	,[DIVISI] = COALESCE([SOURCE].[DIVISI], [TARGET].[DIVISI])
	,[KOL_LOAN] = COALESCE([SOURCE].KOLBSM, [TARGET].[KOL_LOAN])
	,[KOL_CIF] = COALESCE([SOURCE].KOLCIF, [TARGET].[KOL_CIF])
	,[CAIR_POKOK] = COALESCE([SOURCE].PENCAIRANPOKOKCONVERSION, [TARGET].[CAIR_POKOK])
	,[CAIR_MARGIN] = COALESCE([SOURCE].PENCAIRANMARGINCONVERSION, [TARGET].[CAIR_MARGIN])
	,[SISA_POKOK] = COALESCE([SOURCE].OSPOKOKCONVERSION, [TARGET].[SISA_POKOK])
	,[SISA_MARGIN] = COALESCE([SOURCE].OSMARGINCONVERSION, [TARGET].[SISA_MARGIN])
	,[REALISASI_BASIL] = COALESCE([SOURCE].REALISASI_BAGIHASIL, [TARGET].[REALISASI_BASIL])
	,[PROYEKSI_BASIL] = COALESCE([SOURCE].PROYEKSI_BAGIHASIL, [TARGET].[PROYEKSI_BASIL])
WHEN NOT MATCHED BY TARGET THEN
INSERT
	(
		[TGL_DATA] ,
		[LEGACY] ,
		[NOLOAN] ,
		--[CARD_NO] ,
		[NOMORCIF] ,
		[KODEOUTLET] ,
		[CURRENCY] ,
		[JENISPIUTANGPEMBIAYAAN] ,
		[DAYPASTDUE] ,
		[TGL_CAIR] ,
		[TGL_JT_TEMPO] ,
		[DIVISI] ,
		[KOL_LOAN] ,
		[KOL_CIF] ,
		[CAIR_POKOK] ,
		[CAIR_MARGIN] ,
		[SISA_POKOK] ,
		[SISA_MARGIN] ,
		[REALISASI_BASIL] ,
		[PROYEKSI_BASIL]
	)
VALUES
	(
		[SOURCE].FICMISDATE
		,'BSM'
		,[SOURCE].NOLOAN
		,[SOURCE].NOMORCIF
		,[SOURCE].KODECABANGBARU
		,[SOURCE].CURRENCY
		,[SOURCE].JENISPIUTANGPEMBIAYAAN
		,[SOURCE].DAYPASTDUE
		,[SOURCE].TGLPENCAIRAN
		,[SOURCE].TGLJTTEMPO
		,[SOURCE].DIVISI
		,[SOURCE].KOLBSM
		,[SOURCE].KOLCIF
		,[SOURCE].PENCAIRANPOKOKCONVERSION
		,[SOURCE].PENCAIRANMARGINCONVERSION
		,[SOURCE].OSPOKOKCONVERSION
		,[SOURCE].OSMARGINCONVERSION
		,[SOURCE].REALISASI_BAGIHASIL
		,[SOURCE].PROYEKSI_BAGIHASIL
	);

------------------------------------------FIXER------------------------------------------

UPDATE [PORTOFOLIO.ONBS.LIST_LOAN]
SET KOL_LOAN = KOL_CIF
WHERE KOL_LOAN IS NULL;
