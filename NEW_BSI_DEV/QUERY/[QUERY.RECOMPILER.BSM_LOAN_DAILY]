DECLARE @sql_query varchar(max) = '', @NAME varchar(max) = '', @COLUMN_NAME varchar(max) = '', @COLUMNS varchar(max) = ''
DECLARE load_cursor CURSOR FOR 
	SELECT name FROM [NEW_BSI_STORAGE].sys.objects WHERE type_desc = 'USER_TABLE' AND name LIKE ('BSM.LOAN_DAILY.____-__-__') ORDER BY name ASC

OPEN load_cursor
FETCH NEXT FROM load_cursor INTO @NAME

WHILE @@FETCH_STATUS = 0 
BEGIN
	SET @sql_query = CONCAT('MERGE [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.LOAN_DETAIL] [TARGET]
USING
	(
		SELECT
			''BSM'' AS LEGACY
			,NOLOAN
			,NULLIF(NOMORCIF, '''') AS NOMORCIF
			,NULLIF(KODECABANGBARU, '''') AS KODEOUTLET
			,[NEW_BSI_COLLECTION].dbo.fx_adjustment_divisi_bsi(COALESCE([DIVISI].DIVISI, [SOURCE].[DIVISI])) AS DIVISI
			,NULLIF(CURRENCY, '''') AS CURRENCY
			,NULLIF(LOANTYPE, '''') AS LOANTYPE
			,NULLIF(JENISPIUTANGPEMBIAYAAN, '''') AS JENISPIUTANGPEMBIAYAAN
			,NULLIF(SEKTOREKONOMICODE, '''') AS KODESEKTOREKONOMI
			,NULLIF(PENCAIRANPOKOKCONVERSION, '''') AS PENCAIRANPOKOKCONVERSION
			,NULLIF(PENCAIRANMARGINCONVERSION, '''') AS PENCAIRANMARGINCONVERSION
			,NULLIF(TRY_CAST(TGLPENCAIRAN AS DATE), '''') AS TANGGAL_CAIR
			,NULLIF(TRY_CAST(TGLJTTEMPO AS DATE), '''') AS TANGGAL_JATUH_TEMPO
			,NULLIF(JENISPENGGUNAANCODE, '''') AS JENISPENGGUNAANCODE
			,NULLIF(RELATED_TRN, '''') AS RELATED_TRN
			,NULLIF(LEGACY_ID, '''') AS LEGACY_ID
			,NULLIF(INTEREST_RATE, '''') AS INTERESTRATE
			,NULLIF(SCHEDTYPE, '''') AS SCHEDTYPE
			,NULLIF(SCHD_DT, '''') AS SCHD_DT
			,NULLIF(STATUS_PENCAIRAN, '''') AS STATUS_PENCAIRAN
			,NULLIF(STATUS_PEMBIAYA, '''') AS STATUS_PEMBIAYAA
			,NULLIF(DESC_CHG, '''') AS DESC_CHG
			,NULLIF(NAPNO, '''') AS NAPNO
		FROM [NEW_BSI_STORAGE].[dbo].[', @NAME, '] [SOURCE]
		LEFT JOIN [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_JOIN.MAPPING.BSM.DIVISI] [DIVISI]
			ON [SOURCE].[DIVISI] = [DIVISI].SOURCE
		WHERE NULLIF(NOLOAN, '''') IS NOT NULL
	) [SOURCE]
	ON [SOURCE].[NOLOAN] = [TARGET].[NOLOAN]
	AND [SOURCE].[NOMORCIF] = [TARGET].[NOMORCIF]
WHEN MATCHED THEN UPDATE SET
	LEGACY = COALESCE([SOURCE].LEGACY, [TARGET].LEGACY)
	,KODEOUTLET = COALESCE([SOURCE].KODEOUTLET, [TARGET].KODEOUTLET)
	,DIVISI = COALESCE([TARGET].DIVISI, [SOURCE].DIVISI)
	,CURRENCY = COALESCE([SOURCE].CURRENCY, [TARGET].CURRENCY)
	,LOANTYPE = COALESCE([SOURCE].LOANTYPE, [TARGET].LOANTYPE)
	,JENISPIUTANGPEMBIAYAAN = COALESCE([SOURCE].JENISPIUTANGPEMBIAYAAN, [TARGET].JENISPIUTANGPEMBIAYAAN)
	,KODESEKTOREKONOMI = COALESCE([SOURCE].KODESEKTOREKONOMI, [TARGET].KODESEKTOREKONOMI)
	,PENCAIRANPOKOKCONVERSION = COALESCE([SOURCE].PENCAIRANPOKOKCONVERSION, [TARGET].PENCAIRANPOKOKCONVERSION)
	,PENCAIRANMARGINCONVERSION = COALESCE([SOURCE].PENCAIRANMARGINCONVERSION, [TARGET].PENCAIRANMARGINCONVERSION)
	,TANGGAL_CAIR = COALESCE([SOURCE].TANGGAL_CAIR, [TARGET].TANGGAL_CAIR)
	,TANGGAL_JATUH_TEMPO = COALESCE([SOURCE].TANGGAL_JATUH_TEMPO, [TARGET].TANGGAL_JATUH_TEMPO)
	,JENISPENGGUNAANCODE = COALESCE([SOURCE].JENISPENGGUNAANCODE, [TARGET].JENISPENGGUNAANCODE)
	,RELATED_TRN = COALESCE([SOURCE].RELATED_TRN, [TARGET].RELATED_TRN)
	,LEGACY_ID = COALESCE([SOURCE].LEGACY_ID, [TARGET].LEGACY_ID)
	,INTERESTRATE = COALESCE([SOURCE].INTERESTRATE, [TARGET].INTERESTRATE)
	,SCHEDTYPE = COALESCE([SOURCE].SCHEDTYPE, [TARGET].SCHEDTYPE)
	,SCHD_DT = COALESCE([SOURCE].SCHD_DT, [TARGET].SCHD_DT)
	,STATUS_PENCAIRAN = COALESCE([SOURCE].STATUS_PENCAIRAN, [TARGET].STATUS_PENCAIRAN)
	,STATUS_PEMBIAYAA = COALESCE([SOURCE].STATUS_PEMBIAYAA, [TARGET].STATUS_PEMBIAYAA)
	,DESC_CHG = COALESCE([SOURCE].DESC_CHG, [TARGET].DESC_CHG)
	,NAPNO = COALESCE([SOURCE].NAPNO, [TARGET].NAPNO)
WHEN NOT MATCHED BY TARGET THEN INSERT
(
	LEGACY
	,NOLOAN
	,NOMORCIF
	,KODEOUTLET
	,DIVISI
	,CURRENCY
	,LOANTYPE
	,JENISPIUTANGPEMBIAYAAN
	,KODESEKTOREKONOMI
	,PENCAIRANPOKOKCONVERSION
	,PENCAIRANMARGINCONVERSION
	,TANGGAL_CAIR
	,TANGGAL_JATUH_TEMPO
	,JENISPENGGUNAANCODE
	,RELATED_TRN
	,LEGACY_ID
	,INTERESTRATE
	,SCHEDTYPE
	,SCHD_DT
	,STATUS_PENCAIRAN
	,STATUS_PEMBIAYAA
	,DESC_CHG
	,NAPNO
)
VALUES
(
	[SOURCE].LEGACY
	,[SOURCE].NOLOAN
	,[SOURCE].NOMORCIF
	,[SOURCE].KODEOUTLET
	,[SOURCE].DIVISI
	,[SOURCE].CURRENCY
	,[SOURCE].LOANTYPE
	,[SOURCE].JENISPIUTANGPEMBIAYAAN
	,[SOURCE].KODESEKTOREKONOMI
	,[SOURCE].PENCAIRANPOKOKCONVERSION
	,[SOURCE].PENCAIRANMARGINCONVERSION
	,[SOURCE].TANGGAL_CAIR
	,[SOURCE].TANGGAL_JATUH_TEMPO
	,[SOURCE].JENISPENGGUNAANCODE
	,[SOURCE].RELATED_TRN
	,[SOURCE].LEGACY_ID
	,[SOURCE].INTERESTRATE
	,[SOURCE].SCHEDTYPE
	,[SOURCE].SCHD_DT
	,[SOURCE].STATUS_PENCAIRAN
	,[SOURCE].STATUS_PEMBIAYAA
	,[SOURCE].DESC_CHG
	,[SOURCE].NAPNO
);')
	BEGIN TRY
		EXEC(@sql_query)
		PRINT CONCAT(@NAME, ' LOAN: OK!')
	END TRY
	BEGIN CATCH
		PRINT CONCAT(@NAME, ' GENERATE LOAN: ', ERROR_MESSAGE())
	END CATCH

	SET @sql_query = CONCAT('MERGE [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CIF_DETAIL] [TARGET]
USING
(
	SELECT
		''BSM'' AS [LEGACY]
		,[NOMORCIF]
		,NULLIF([NAMALENGKAP], '''') AS NAMANASABAH
		,NULLIF([PEKERJAAN], '''') AS [PEKERJAAN]
		,NULLIF([ADDRESS], '''') AS ALAMAT
		,NULLIF([HP], '''') AS NO_HP
		,NULLIF(TRY_CAST([TANGGAL_LAHIR] AS DATE), '''') AS [TANGGAL_LAHIR]
		,NULLIF([TAX_ID], '''') AS NPWP
		,NULLIF([GENDER], '''') AS [GENDER]
		,ROW_NUMBER() OVER (
			PARTITION BY
				NOMORCIF
			ORDER BY
				[NAMALENGKAP] DESC
				,[PEKERJAAN] DESC
				,[ADDRESS] DESC
				,[HP] DESC
				,[TANGGAL_LAHIR] DESC
				,[TAX_ID] DESC
				,[GENDER] DESC
		) AS ACCT
	FROM [NEW_BSI_STORAGE].[dbo].[', @NAME, ']
	WHERE NULLIF([NOMORCIF], '''') IS NOT NULL
	GROUP BY
		[NOMORCIF]
		,[NAMALENGKAP]
		,[PEKERJAAN]
		,[ADDRESS]
		,[HP]
		,[TANGGAL_LAHIR]
		,[TAX_ID]
		,[GENDER]
) [SOURCE]
	ON [TARGET].[LEGACY] = [SOURCE].[LEGACY]
	AND [TARGET].[NOMORCIF] = [SOURCE].[NOMORCIF]
	AND [SOURCE].ACCT = 1
WHEN MATCHED THEN UPDATE SET
	NAMANASABAH = COALESCE([TARGET].NAMANASABAH, [SOURCE].NAMANASABAH)
	,[PEKERJAAN] = COALESCE([TARGET].PEKERJAAN, [SOURCE].PEKERJAAN)
	,[ALAMAT] = COALESCE([TARGET].ALAMAT, [SOURCE].ALAMAT)
	,[NO_HP] = COALESCE([TARGET].NO_HP, [SOURCE].NO_HP)
	,[TANGGAL_LAHIR] = COALESCE([TARGET].TANGGAL_LAHIR, [SOURCE].TANGGAL_LAHIR)
	,[NPWP] = COALESCE([TARGET].NPWP, [SOURCE].NPWP)
	,[GENDER] = COALESCE([TARGET].GENDER, [SOURCE].GENDER)
WHEN NOT MATCHED BY TARGET THEN INSERT
(
	[LEGACY]
	,[NOMORCIF]
	,[NAMANASABAH]
	,[PEKERJAAN]
	,[ALAMAT]
	,[NO_HP]
	,[TANGGAL_LAHIR]
	,[NPWP]
	,[GENDER]
)
VALUES
(
	[SOURCE].[LEGACY]
	,[SOURCE].[NOMORCIF]
	,[SOURCE].[NAMANASABAH]
	,[SOURCE].[PEKERJAAN]
	,[SOURCE].[ALAMAT]
	,[SOURCE].[NO_HP]
	,[SOURCE].[TANGGAL_LAHIR]
	,[SOURCE].[NPWP]
	,[SOURCE].[GENDER]
);')
	BEGIN TRY
		EXEC(@sql_query)
		PRINT CONCAT(@NAME, ' CIF: OK!')
	END TRY
	BEGIN CATCH
		PRINT CONCAT(@NAME, ' CIF: ', ERROR_MESSAGE())
	END CATCH
	
	FETCH NEXT FROM load_cursor INTO @NAME
END

CLOSE load_cursor
DEALLOCATE load_cursor; 
