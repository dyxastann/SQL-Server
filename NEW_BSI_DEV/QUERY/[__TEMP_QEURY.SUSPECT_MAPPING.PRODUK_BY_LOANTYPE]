DECLARE @CONFIDENCE_TRESHOLD decimal(32, 2) = 0.95

SELECT
	[TARGET].NOLOAN
	,[TARGET].NOMORCIF
	,[TARGET].LOANTYPE
	,[TARGET].DIVISI
	,[SOURCE].PRODUK AS PRODUK_ASUMSI
	,[SOURCE].CONFIDENCE_RATE AS CONFIDENCE_RATE
	,[TARGET].TANGGAL_CAIR
FROM [dbo].[PORTOFOLIO.ONBS.LOAN_DETAIL] [TARGET]
LEFT JOIN
(
	SELECT
		[TARGET].LOANTYPE
		,[TARGET].DIVISI
		,[TARGET].PRODUK
		,TRY_CAST([TARGET].ACCT AS decimal(32, 2)) / TRY_CAST([SOURCE].ACCT AS decimal(32, 2)) AS CONFIDENCE_RATE
	FROM
	(
		SELECT
			LOANTYPE
			,DIVISI
			,PRODUK
			,COUNT(NOLOAN) AS ACCT
		FROM [dbo].[PORTOFOLIO.ONBS.LOAN_DETAIL]
		WHERE PRODUK IS NOT NULL
		AND DIVISI IN ('SME', 'Mikro', 'Pawning', 'Konsumer', 'Consumer')
		GROUP BY
			LOANTYPE
			,DIVISI
			,PRODUK
	) [TARGET]
	LEFT JOIN
	(
		SELECT
			LOANTYPE
			,DIVISI
			,COUNT(NOLOAN) AS ACCT
		FROM [dbo].[PORTOFOLIO.ONBS.LOAN_DETAIL]
		WHERE PRODUK IS NOT NULL
		AND DIVISI IN ('SME', 'Mikro', 'Pawning', 'Konsumer', 'Consumer')
		GROUP BY
			LOANTYPE
			,DIVISI
	) [SOURCE]
		ON [SOURCE].[LOANTYPE] = [TARGET].[LOANTYPE]
		AND [SOURCE].[DIVISI] = [TARGET].[DIVISI]
) [SOURCE]
	ON [SOURCE].[LOANTYPE] = [TARGET].[LOANTYPE]
	AND [SOURCE].[DIVISI] = [TARGET].[DIVISI]
	AND [SOURCE].[CONFIDENCE_RATE] >= @CONFIDENCE_TRESHOLD
WHERE [TARGET].[PRODUK] IS NULL
AND [SOURCE].[PRODUK] IS NOT NULL
