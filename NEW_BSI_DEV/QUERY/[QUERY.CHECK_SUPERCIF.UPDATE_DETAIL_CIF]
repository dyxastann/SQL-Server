DECLARE @SUPERCIF VARCHAR(MAX) = '50394183'

-------------------------------------------------------------------------------

CREATE TABLE #NOMORCIF
(
	NOMORCIF VARCHAR(100)
)

-------------------------------------------------------------------------------

INSERT INTO #NOMORCIF VALUES
	(@SUPERCIF)
	,('81534189')

-------------------------------------------------------------------------------

SELECT
	[TARGET].[LEGACY]
	,[TARGET].[NOMORCIF]
	,[TARGET].[NAMANASABAH]
	,[SOURCE].[NPWP]
	,[SOURCE].[KTP]
	,[SOURCE].[NO_TELP]
	,[SOURCE].[NO_KANTOR]
	,[SOURCE].[NO_HP]
	,[SOURCE].[ALT_CONTACT_1]
	,[SOURCE].[ALT_CONTACT_2]
	,[SOURCE].[ALT_CONTACT_3]
	,[SOURCE].[TANGGAL_LAHIR]
	,[SOURCE].[PEKERJAAN]
	,[SOURCE].[ALAMAT]
INTO #TEMP_MAPPING
FROM
	(
		SELECT
			LEGACY
			,NOMORCIF
			,NAMANASABAH
		FROM [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CIF_DETAIL] [TARGET]
		WHERE [TARGET].[NOMORCIF] IN (SELECT NOMORCIF FROM #NOMORCIF)
		OR [TARGET].[SUPERCIF] IN (SELECT NOMORCIF FROM #NOMORCIF)
	) [TARGET]
OUTER APPLY
	(
		SELECT
			MAX(NPWP) AS NPWP
			,MAX(KTP) AS KTP
			,MAX(NO_HP) AS NO_HP
			,MAX(NO_TELP) AS NO_TELP
			,MAX(NO_KANTOR) AS NO_KANTOR
			,MIN(NO_HP) AS ALT_CONTACT_1
			,MIN(NO_TELP) AS ALT_CONTACT_2
			,MIN(NO_KANTOR) AS ALT_CONTACT_3
			,MAX(TANGGAL_LAHIR) AS TANGGAL_LAHIR
			,MAX(PEKERJAAN) AS PEKERJAAN
			,MAX(ALAMAT) AS ALAMAT
		FROM
			(
				SELECT
					CASE WHEN NPWP IN (SELECT NPWP FROM [NEW_BSI_DEV].[dbo].[FILTER.ANOMALI.INVALID_NPWP]) THEN NULL ELSE NPWP END AS NPWP
					,CASE WHEN KTP IN (SELECT KTP FROM [NEW_BSI_DEV].[dbo].[FILTER.ANOMALI.INVALID_KTP]) THEN NULL ELSE KTP END AS KTP
					,CASE WHEN NO_HP IN (SELECT CONTACT FROM [NEW_BSI_DEV].[dbo].[FILTER.ANOMALI.INVALID_CONTACT]) THEN NULL ELSE NO_HP END AS NO_HP
					,CASE WHEN NO_TELP IN (SELECT CONTACT FROM [NEW_BSI_DEV].[dbo].[FILTER.ANOMALI.INVALID_CONTACT]) THEN NULL ELSE NO_TELP END AS NO_TELP
					,CASE WHEN NO_KANTOR IN (SELECT CONTACT FROM [NEW_BSI_DEV].[dbo].[FILTER.ANOMALI.INVALID_CONTACT]) THEN NULL ELSE NO_KANTOR END AS NO_KANTOR
					,TANGGAL_LAHIR
					,PEKERJAAN
					,ALAMAT
				FROM [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CIF_DETAIL]
				WHERE [NOMORCIF] IN (SELECT NOMORCIF FROM #NOMORCIF)
				OR [SUPERCIF] IN (SELECT NOMORCIF FROM #NOMORCIF)
			) [TEMP_TB]
	) [SOURCE]

-------------------------------------------------------------------------------

UPDATE [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CIF_DETAIL]
SET
	[SUPERCIF] = COALESCE(NULLIF(@SUPERCIF, ''), [TARGET].[SUPERCIF])
	,[NPWP] = [SOURCE].[NPWP]
	,[KTP] = [SOURCE].[KTP]
	,[NO_HP] = [SOURCE].[NO_HP]
	,[NO_TELP] = [SOURCE].[NO_TELP]
	,[NO_KANTOR] = [SOURCE].[NO_KANTOR]
	,[ALT_CONTACT_1] = [SOURCE].[ALT_CONTACT_1]
	,[ALT_CONTACT_2] = [SOURCE].[ALT_CONTACT_2]
	,[ALT_CONTACT_3] = [SOURCE].[ALT_CONTACT_3]
	,[TANGGAL_LAHIR] = [SOURCE].[TANGGAL_LAHIR]
	,[PEKERJAAN] = [SOURCE].[PEKERJAAN]
	,[ALAMAT] = [SOURCE].[ALAMAT]
FROM [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CIF_DETAIL] [TARGET]
LEFT JOIN #TEMP_MAPPING [SOURCE]
	ON [TARGET].[LEGACY] = [SOURCE].[LEGACY]
	AND [TARGET].[NOMORCIF] = [SOURCE].[NOMORCIF]
WHERE [TARGET].[NOMORCIF] IN (SELECT NOMORCIF FROM #NOMORCIF)
OR [TARGET].[SUPERCIF] IN (SELECT NOMORCIF FROM #NOMORCIF)
