BEGIN TRY
	DROP TABLE [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.SUSPECT_SUPERCIF]
END TRY
BEGIN CATCH
END CATCH

-------------------------------------------------------------------------------

SELECT
	[TARGET].[LEGACY]
	,[TARGET].[NOMORCIF]
	,[TARGET].[NAMANASABAH]
	,[SOURCE].[SUPERCIF]
	,[SOURCE].[NAMANASABAH] AS [NAMANASABAH_SUPERCIF]
	,CASE WHEN LEFT([TARGET].[NPWP], LEN([SOURCE].[NPWP])) = LEFT([SOURCE].[NPWP], LEN([TARGET].[NPWP])) THEN 4 ELSE 0 END
		+ CASE WHEN LEFT([TARGET].[KTP], LEN([SOURCE].[KTP])) = LEFT([SOURCE].[KTP], LEN([TARGET].[KTP])) THEN 4 ELSE 0 END
		+ CASE WHEN LEFT([TARGET].[NO_HP], LEN([SOURCE].[NO_HP])) = LEFT([SOURCE].[NO_HP], LEN([TARGET].[NO_HP])) THEN 2 ELSE 0 END
		+ CASE WHEN LEFT([TARGET].[NO_TELP], LEN([SOURCE].[NO_TELP])) = LEFT([SOURCE].[NO_TELP], LEN([TARGET].[NO_TELP])) THEN 2 ELSE 0 END
		+ CASE WHEN LEFT([TARGET].[NO_KANTOR], LEN([SOURCE].[NO_KANTOR])) = LEFT([SOURCE].[NO_KANTOR], LEN([TARGET].[NO_KANTOR])) THEN 2 ELSE 0 END
		+ CASE WHEN [TARGET].[TANGGAL_LAHIR] = [SOURCE].[TANGGAL_LAHIR] THEN 4 ELSE 0 END
	AS [POIN]
INTO [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.SUSPECT_SUPERCIF]
FROM
	(
		SELECT
			[LEGACY]
			,[NOMORCIF]
			,[NAMANASABAH]
			,COALESCE(NULLIF([NPWP], ''), 'POINTER_1') AS [NPWP]
			,COALESCE(NULLIF([KTP], ''), 'POINTER_1') AS [KTP]
			,COALESCE(NULLIF([NO_HP], ''), 'POINTER_1') AS [NO_HP]
			,COALESCE(NULLIF([NO_TELP], ''), 'POINTER_1') AS [NO_TELP]
			,COALESCE(NULLIF([NO_KANTOR], ''), 'POINTER_1') AS [NO_KANTOR]
			,COALESCE(NULLIF([TANGGAL_LAHIR], ''), '1900-01-01') AS [TANGGAL_LAHIR]
			,[SUPERCIF]
		FROM
			(
				SELECT
					[LEGACY]
					,[NOMORCIF]
					,[NAMANASABAH]
					,CASE WHEN NPWP IN (SELECT NPWP FROM [NEW_BSI_DEV].[dbo].[FILTER.ANOMALI.INVALID_NPWP]) THEN NULL ELSE NPWP END AS NPWP
					,CASE WHEN KTP IN (SELECT KTP FROM [NEW_BSI_DEV].[dbo].[FILTER.ANOMALI.INVALID_KTP]) THEN NULL ELSE KTP END AS KTP
					,CASE WHEN NO_HP IN (SELECT CONTACT FROM [NEW_BSI_DEV].[dbo].[FILTER.ANOMALI.INVALID_CONTACT]) THEN NULL ELSE NO_HP END AS NO_HP
					,CASE WHEN NO_TELP IN (SELECT CONTACT FROM [NEW_BSI_DEV].[dbo].[FILTER.ANOMALI.INVALID_CONTACT]) THEN NULL ELSE NO_TELP END AS NO_TELP
					,CASE WHEN NO_KANTOR IN (SELECT CONTACT FROM [NEW_BSI_DEV].[dbo].[FILTER.ANOMALI.INVALID_CONTACT]) THEN NULL ELSE NO_KANTOR END AS NO_KANTOR
					,[TANGGAL_LAHIR]
					,[SUPERCIF]
				FROM [PORTOFOLIO.ONBS.CIF_DETAIL]
				WHERE LEGACY = 'BSM'
			) [TEMP_TB]
	) [TARGET]
LEFT JOIN
	(
		SELECT
			[LEGACY]
			,[NOMORCIF]
			,[NAMANASABAH]
			,COALESCE(NULLIF([NPWP], ''), 'POINTER_2') AS [NPWP]
			,COALESCE(NULLIF([KTP], ''), 'POINTER_2') AS [KTP]
			,COALESCE(NULLIF([NO_HP], ''), 'POINTER_2') AS [NO_HP]
			,COALESCE(NULLIF([NO_TELP], ''), 'POINTER_2') AS [NO_TELP]
			,COALESCE(NULLIF([NO_KANTOR], ''), 'POINTER_2') AS [NO_KANTOR]
			,COALESCE(NULLIF([TANGGAL_LAHIR], ''), '2022-01-01') AS [TANGGAL_LAHIR]
			,[SUPERCIF]
		FROM
			(
				SELECT
					[LEGACY]
					,[NOMORCIF]
					,[NAMANASABAH]
					,CASE WHEN NPWP IN (SELECT NPWP FROM [NEW_BSI_DEV].[dbo].[FILTER.ANOMALI.INVALID_NPWP]) THEN NULL ELSE NPWP END AS NPWP
					,CASE WHEN KTP IN (SELECT KTP FROM [NEW_BSI_DEV].[dbo].[FILTER.ANOMALI.INVALID_KTP]) THEN NULL ELSE KTP END AS KTP
					,CASE WHEN NO_HP IN (SELECT CONTACT FROM [NEW_BSI_DEV].[dbo].[FILTER.ANOMALI.INVALID_CONTACT]) THEN NULL ELSE NO_HP END AS NO_HP
					,CASE WHEN NO_TELP IN (SELECT CONTACT FROM [NEW_BSI_DEV].[dbo].[FILTER.ANOMALI.INVALID_CONTACT]) THEN NULL ELSE NO_TELP END AS NO_TELP
					,CASE WHEN NO_KANTOR IN (SELECT CONTACT FROM [NEW_BSI_DEV].[dbo].[FILTER.ANOMALI.INVALID_CONTACT]) THEN NULL ELSE NO_KANTOR END AS NO_KANTOR
					,[TANGGAL_LAHIR]
					,[SUPERCIF]
				FROM [PORTOFOLIO.ONBS.CIF_DETAIL]
				WHERE LEGACY = 'BSM'
			) [TEMP_TB]
	) [SOURCE]
	
	ON NOT (
		[TARGET].[SUPERCIF] = [SOURCE].[SUPERCIF]
		OR [TARGET].[NOMORCIF] = [SOURCE].[SUPERCIF]
		OR [TARGET].[SUPERCIF] = [SOURCE].[NOMORCIF]
		OR [TARGET].[NOMORCIF] = [SOURCE].[NOMORCIF]
	)
	--AND LEFT([TARGET].[NAMANASABAH], LEN([SOURCE].[NAMANASABAH])) = LEFT([SOURCE].[NAMANASABAH], LEN([TARGET].[NAMANASABAH]))
	AND [TARGET].[NAMANASABAH] = [SOURCE].[NAMANASABAH]
	AND
		(
			CASE WHEN LEFT([TARGET].[NPWP], LEN([SOURCE].[NPWP])) = LEFT([SOURCE].[NPWP], LEN([TARGET].[NPWP])) THEN 4 ELSE 0 END
			+ CASE WHEN LEFT([TARGET].[KTP], LEN([SOURCE].[KTP])) = LEFT([SOURCE].[KTP], LEN([TARGET].[KTP])) THEN 4 ELSE 0 END
			+ CASE WHEN LEFT([TARGET].[NO_HP], LEN([SOURCE].[NO_HP])) = LEFT([SOURCE].[NO_HP], LEN([TARGET].[NO_HP])) THEN 2 ELSE 0 END
			+ CASE WHEN LEFT([TARGET].[NO_TELP], LEN([SOURCE].[NO_TELP])) = LEFT([SOURCE].[NO_TELP], LEN([TARGET].[NO_TELP])) THEN 2 ELSE 0 END
			+ CASE WHEN LEFT([TARGET].[NO_KANTOR], LEN([SOURCE].[NO_KANTOR])) = LEFT([SOURCE].[NO_KANTOR], LEN([TARGET].[NO_KANTOR])) THEN 2 ELSE 0 END
			+ CASE WHEN [TARGET].[TANGGAL_LAHIR] = [SOURCE].[TANGGAL_LAHIR] THEN 4 ELSE 0 END >= 4
		)
WHERE [SOURCE].[NOMORCIF] IS NOT NULL
ORDER BY
	CASE WHEN LEFT([TARGET].[NPWP], LEN([SOURCE].[NPWP])) = LEFT([SOURCE].[NPWP], LEN([TARGET].[NPWP])) THEN 4 ELSE 0 END
	+ CASE WHEN LEFT([TARGET].[KTP], LEN([SOURCE].[KTP])) = LEFT([SOURCE].[KTP], LEN([TARGET].[KTP])) THEN 4 ELSE 0 END
	+ CASE WHEN LEFT([TARGET].[NO_HP], LEN([SOURCE].[NO_HP])) = LEFT([SOURCE].[NO_HP], LEN([TARGET].[NO_HP])) THEN 2 ELSE 0 END
	+ CASE WHEN LEFT([TARGET].[NO_TELP], LEN([SOURCE].[NO_TELP])) = LEFT([SOURCE].[NO_TELP], LEN([TARGET].[NO_TELP])) THEN 2 ELSE 0 END
	+ CASE WHEN LEFT([TARGET].[NO_KANTOR], LEN([SOURCE].[NO_KANTOR])) = LEFT([SOURCE].[NO_KANTOR], LEN([TARGET].[NO_KANTOR])) THEN 2 ELSE 0 END
	+ CASE WHEN [TARGET].[TANGGAL_LAHIR] = [SOURCE].[TANGGAL_LAHIR] THEN 4 ELSE 0 END DESC
	,NOMORCIF DESC
	,SUPERCIF DESC
