/*
SELECT
	DIVISI
	,PRODUK
	,COUNT(NOLOAN) AS ACCT
FROM [dbo].[PORTOFOLIO.ONBS.LOAN_DETAIL]
WHERE DIVISI IN ('Konsumer', 'SME', 'Mikro', 'Pawning', 'Hasanah Card')
GROUP BY
	DIVISI
	,PRODUK
ORDER BY
	DIVISI
	,PRODUK
*/
------------------------------------------------------------------

--UPDATE [dbo].[PORTOFOLIO.ONBS.LOAN_DETAIL] SET PRODUK = 'MITRAGUNA & OTHER' WHERE DIVISI = 'KONSUMER' AND PRODUK = 'MITRAGUNA/MULTIGUNA'

--SELECT * FROM [dbo].[PORTOFOLIO.ONBS.LOAN_DETAIL] WHERE DIVISI IN ('Konsumer', 'SME', 'Mikro', 'Pawning', 'Hasanah Card') AND PRODUK IS NULL;

WITH CTE AS (SELECT [LEGACY], [NOLOAN], [NOMORCIF], [DIVISI], [PRODUK], [PRODUK_DETAIL] FROM [dbo].[PORTOFOLIO.ONBS.LOAN_DETAIL] WHERE DIVISI IN ('Konsumer', 'SME', 'Mikro', 'Pawning', 'Hasanah Card') AND PRODUK IS NULL)
/*
UPDATE CTE SET
	DIVISI = COALESCE([FINAL].DIVISI, [SOURCE].DIVISI)
	,PRODUK = COALESCE([FINAL].PRODUK, [SOURCE].PRODUK)
	,PRODUK_DETAIL = COALESCE([FINAL].PRODUK_DETAIL, [SOURCE].PRODUK_DETAIL)
*/

SELECT
	[SOURCE].LEGACY
	,[SOURCE].NOLOAN
	,[SOURCE].NOMORCIF
	,[FINAL].NOLOAN AS NOLOAN_FINAL
	,[FINAL].NOMORCIF AS NOMORCIF_FINAL
	,[SOURCE].DIVISI
	,[FINAL].DIVISI AS DIVISI_FINAL
	,[SOURCE].PRODUK
	,[FINAL].PRODUK AS PRODUK_FINAL
	,[SOURCE].PRODUK_DETAIL
	,[FINAL].PRODUK_DETAIL AS PRODUK_DETAIL_FINAL

FROM CTE [SOURCE]
LEFT JOIN [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.MAPPING.JOIN.REKAP_NOLOAN.MUTASI_NOLOAN_CURRENT] [MUTASI]
	ON [SOURCE].NOLOAN = [MUTASI].[NOLOAN_CURRENT]
	AND [SOURCE].NOMORCIF = [MUTASI].[NOCIF_CURRENT]
LEFT JOIN
	(
		SELECT [LEGACY], [NOLOAN], [NOMORCIF], [DIVISI], [PRODUK], [PRODUK_DETAIL] FROM [dbo].[PORTOFOLIO.ONBS.LOAN_DETAIL]
	)[FINAL]
	ON [FINAL].NOLOAN = COALESCE([MUTASI].[NOLOAN_AKHIR], 'X')
	AND [FINAL].NOMORCIF = COALESCE([MUTASI].[NOCIF_AKHIR], 'X')
WHERE
(
[FINAL].[DIVISI] != [SOURCE].[DIVISI]
OR [FINAL].[PRODUK] != [SOURCE].[PRODUK]
)
