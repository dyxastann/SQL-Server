--DECLARE @CONFIDENCE_TRESHOLD decimal(32, 2) = 1
SELECT
	[CURRENT].[(RCG) DIVISI_BSI]
	,[CURRENT].[(RCG) KOL_CIF_LAST_MONTH]
	,[CURRENT].[(RCG) AGING_KOL_CIF]
	,COALESCE([ASSUMPTIONS].[(RCG) KOL_CIF_PECAH], [CURRENT].[(RCG) KOL_CIF_LAST_MONTH]) AS [(RCG) KOL_CIF_PECAH]
	,CASE
		WHEN [ASSUMPTIONS].[(RCG) DIVISI_BSI] IS NOT NULL THEN [CURRENT].[(RCG) OS_POKOK_PSAK_LAST_MONTH] * COALESCE([ASSUMPTIONS].[(RCG) FLOW_RATIO], 0.00)
		ELSE [CURRENT].[(RCG) OS_POKOK_PSAK_LAST_MONTH]
	END AS [(RCG) OS_POKOK_PSAK_CURRENT]
FROM
	(
		SELECT
			[(RCG) DIVISI_BSI]
			,[(RCG) KOL_CIF_LAST_MONTH]
			,[(RCG) AGING_KOL_CIF]
			,SUM([(RCG) OS_POKOK_PSAK_LAST_MONTH]) AS [(RCG) OS_POKOK_PSAK_LAST_MONTH]
			,SUM([(RCG) OS_POKOK_PSAK_CURRENT]) AS [(RCG) OS_POKOK_PSAK_CURRENT]
		FROM [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.GENERATED.JOIN.PORTOFOLIO_CURRENT]
		WHERE [(RCG) KOL_CIF_LAST_MONTH] IS NOT NULL
		AND [(RCG) DIVISI_BSI] IN ('Konsumer', 'SME', 'Mikro', 'Pawning', 'Hasanah Card')
		GROUP BY
			[(RCG) DIVISI_BSI]
			,[(RCG) KOL_CIF_LAST_MONTH]
			,[(RCG) AGING_KOL_CIF]
	) [CURRENT]
LEFT JOIN
(
	SELECT
		[TARGET].[(RCG) DIVISI_BSI]
		,[TARGET].[(RCG) KOL_CIF_LAST_MONTH]
		,[TARGET].[(RCG) AGING_KOL_CIF]
		,[TARGET].[(RCG) KOL_CIF_PECAH]
		,[TARGET].[(RCG) OS_POKOK_PSAK_LAST_MONTH]
		,[TARGET].[(RCG) OS_POKOK_PSAK_CURRENT]
		,[TARGET].[(RCG) OS_POKOK_PSAK_LAST_MONTH] / [SOURCE].[(RCG) OS_POKOK_PSAK_LAST_MONTH] AS [(RCG) FLOW_RATIO]
	FROM
	(
		SELECT
			[(RCG) DIVISI_BSI]
			,COALESCE([(RCG) KOL_CIF_LAST_MONTH], 'Cair Baru') AS [(RCG) KOL_CIF_LAST_MONTH]
			,[(RCG) AGING_KOL_CIF]
			,COALESCE(REPLACE([(RCG) KOL_CIF_PECAH], 'WO', [(RCG) KOL_CIF_LAST_MONTH]), 'WO') AS [(RCG) KOL_CIF_PECAH]
			,SUM([(RCG) OS_POKOK_PSAK_LAST_MONTH]) AS [(RCG) OS_POKOK_PSAK_LAST_MONTH]
			,SUM([(RCG) OS_POKOK_PSAK_CURRENT]) AS [(RCG) OS_POKOK_PSAK_CURRENT]
		FROM [NEW_BSI_STORAGE].[dbo].[BSI.PORTOFOLIO_DAILY.2022-06-30 (EDA)]
		WHERE [(RCG) DIVISI_BSI] IN ('Konsumer', 'SME', 'Mikro', 'Pawning', 'Hasanah Card')
		GROUP BY
			[(RCG) DIVISI_BSI]
			,COALESCE([(RCG) KOL_CIF_LAST_MONTH], 'Cair Baru')
			,[(RCG) AGING_KOL_CIF]
			,COALESCE(REPLACE([(RCG) KOL_CIF_PECAH], 'WO', [(RCG) KOL_CIF_LAST_MONTH]), 'WO')
	) [TARGET]
	LEFT JOIN
	(
		SELECT
			[(RCG) DIVISI_BSI]
			,COALESCE([(RCG) KOL_CIF_LAST_MONTH], 'Cair Baru') AS [(RCG) KOL_CIF_LAST_MONTH]
			,[(RCG) AGING_KOL_CIF]
			,SUM([(RCG) OS_POKOK_PSAK_LAST_MONTH]) AS [(RCG) OS_POKOK_PSAK_LAST_MONTH]
			,SUM([(RCG) OS_POKOK_PSAK_CURRENT]) AS [(RCG) OS_POKOK_PSAK_CURRENT]
		FROM [NEW_BSI_STORAGE].[dbo].[BSI.PORTOFOLIO_DAILY.2022-06-30 (EDA)]
		WHERE [(RCG) DIVISI_BSI] IN ('Konsumer', 'SME', 'Mikro', 'Pawning', 'Hasanah Card')
		GROUP BY
			[(RCG) DIVISI_BSI]
			,COALESCE([(RCG) KOL_CIF_LAST_MONTH], 'Cair Baru')
			,[(RCG) AGING_KOL_CIF]
	) [SOURCE]
		ON [SOURCE].[(RCG) DIVISI_BSI] = [TARGET].[(RCG) DIVISI_BSI]
		AND [SOURCE].[(RCG) KOL_CIF_LAST_MONTH] = [TARGET].[(RCG) KOL_CIF_LAST_MONTH]
		AND [SOURCE].[(RCG) AGING_KOL_CIF] = [TARGET].[(RCG) AGING_KOL_CIF]
	WHERE LEFT([TARGET].[(RCG) KOL_CIF_PECAH], 1) IN ('1', '2', '3', '4', '5', 'L')
/*
	ORDER BY
		[TARGET].[(RCG) DIVISI_BSI]
		,[TARGET].[(RCG) KOL_CIF_LAST_MONTH]
		,[TARGET].[(RCG) AGING_KOL_CIF]
		,[TARGET].[(RCG) KOL_CIF_PECAH]
*/
) [ASSUMPTIONS]
	ON [CURRENT].[(RCG) DIVISI_BSI] = [ASSUMPTIONS].[(RCG) DIVISI_BSI]
	AND [CURRENT].[(RCG) KOL_CIF_LAST_MONTH] = [ASSUMPTIONS].[(RCG) KOL_CIF_LAST_MONTH]
	AND [CURRENT].[(RCG) AGING_KOL_CIF] = [ASSUMPTIONS].[(RCG) AGING_KOL_CIF]
ORDER BY
	[CURRENT].[(RCG) DIVISI_BSI]
	,[CURRENT].[(RCG) KOL_CIF_LAST_MONTH]
	,[CURRENT].[(RCG) AGING_KOL_CIF]
	,COALESCE([ASSUMPTIONS].[(RCG) KOL_CIF_PECAH], [CURRENT].[(RCG) KOL_CIF_LAST_MONTH])
