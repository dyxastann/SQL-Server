/*
UPDATE [PORTOFOLIO.ONBS.LOAN_DETAIL]
SET
	DIVISI = COALESCE([FINAL].DIVISI, [TARGET].DIVISI)
	,PRODUK = COALESCE([FINAL].PRODUK, [TARGET].PRODUK)
	,PRODUK_DETAIL = COALESCE([FINAL].PRODUK_DETAIL, [TARGET].PRODUK_DETAIL)
*/

CREATE TABLE #TEMPORARY_TABLE
	(
		NOLOAN_SOURCE VARCHAR(255)
		,NOMORCIF_SOURCE VARCHAR(255)
		,DIVISI_SOURCE VARCHAR(255)
		,PRODUK_SOURCE VARCHAR(255)
		,PRODUK_DETAIL_SOURCE VARCHAR(255)
		,NOLOAN_FINAL VARCHAR(255)
		,NOMORCIF_FINAL VARCHAR(255)
		,DIVISI_FINAL VARCHAR(255)
		,PRODUK_FINAL VARCHAR(255)
		,PRODUK_DETAIL_FINAL VARCHAR(255)
	)

INSERT INTO #TEMPORARY_TABLE
	(
		NOLOAN_SOURCE
		,NOMORCIF_SOURCE
		,DIVISI_SOURCE
		,PRODUK_SOURCE
		,PRODUK_DETAIL_SOURCE
	)
SELECT
	[TARGET].NOLOAN AS NOLOAN_SOURCE
	,[TARGET].NOMORCIF AS NOMORCIF_SOURCE
	,[TARGET].DIVISI AS DIVISI_SOURCE
	,[TARGET].PRODUK AS PRODUK_SOURCE
	,[TARGET].PRODUK_DETAIL AS PRODUK_DETAIL_SOURCE
FROM [PORTOFOLIO.ONBS.LOAN_DETAIL] [TARGET]

---------------------------------------------------------------------------------

UPDATE #TEMPORARY_TABLE
SET
	NOLOAN_FINAL = [MUTASI].[NOLOAN_AKHIR]
	,NOMORCIF_FINAL = [MUTASI].[NOCIF_AKHIR]
FROM #TEMPORARY_TABLE [TARGET]
LEFT JOIN [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.MAPPING.JOIN.REKAP_NOLOAN.MUTASI_NOLOAN_CURRENT] [MUTASI]
	ON COALESCE([TARGET].[NOLOAN_SOURCE], 'X') = COALESCE([MUTASI].[NOLOAN_CURRENT], 'X')
	AND COALESCE([TARGET].[NOMORCIF_SOURCE], 'X') = COALESCE([MUTASI].[NOCIF_CURRENT], 'X')

---------------------------------------------------------------------------------

DELETE FROM #TEMPORARY_TABLE WHERE NOLOAN_FINAL IS NULL

---------------------------------------------------------------------------------

UPDATE #TEMPORARY_TABLE
SET
	DIVISI_FINAL = [FINAL].[DIVISI]
	,PRODUK_FINAL = [FINAL].[PRODUK]
	,PRODUK_DETAIL_FINAL = [FINAL].[PRODUK_DETAIL]
FROM #TEMPORARY_TABLE [TARGET]
LEFT JOIN
	(
		SELECT [LEGACY], [NOLOAN], [NOMORCIF], [DIVISI], [PRODUK], [PRODUK_DETAIL] FROM [dbo].[PORTOFOLIO.ONBS.LOAN_DETAIL]
	) [FINAL]
	ON COALESCE([FINAL].[NOLOAN], 'X') = COALESCE([TARGET].[NOLOAN_FINAL], 'X')
	AND COALESCE([FINAL].[NOMORCIF], 'X') = COALESCE([TARGET].[NOMORCIF_FINAL], 'X')

UPDATE [dbo].[PORTOFOLIO.ONBS.LOAN_DETAIL]
SET
	[DIVISI] = [SOURCE].[DIVISI_FINAL]
	,[PRODUK] = [SOURCE].[PRODUK_FINAL]
	,[PRODUK_DETAIL] = COALESCE([SOURCE].[PRODUK_DETAIL_FINAL], [TARGET].[PRODUK_DETAIL])
	,[UPDATE_METHOD] = 'UPDATE BY MUTASI'
FROM [dbo].[PORTOFOLIO.ONBS.LOAN_DETAIL] [TARGET]
LEFT JOIN #TEMPORARY_TABLE [SOURCE]
	ON [TARGET].NOLOAN = [SOURCE].[NOLOAN_SOURCE]
	AND [TARGET].NOMORCIF = [SOURCE].[NOMORCIF_SOURCE]
WHERE [SOURCE].DIVISI_FINAL IS NOT NULL
AND
	(
		[SOURCE].DIVISI_FINAL IN ('KONSUMER', 'MIKRO', 'SME', 'PAWNING', 'Hasanah Card') AND PRODUK IS NOT NULL
		OR [SOURCE].DIVISI_FINAL NOT IN ('KONSUMER', 'MIKRO', 'SME', 'PAWNING', 'Hasanah Card')
	)

---------------------------------------------------------------------------------

UPDATE [dbo].[PORTOFOLIO.ONBS.LOAN_DETAIL]
SET
	[PRODUK] = COALESCE([TARGET].[PRODUK], [SOURCE].[PRODUK_SOURCE])
	,[PRODUK_DETAIL] = [SOURCE].[PRODUK_DETAIL_SOURCE]
	,[UPDATE_METHOD] = 'BACKTRACK NOLOAN'
FROM [dbo].[PORTOFOLIO.ONBS.LOAN_DETAIL] [TARGET]
LEFT JOIN #TEMPORARY_TABLE [SOURCE]
	ON [TARGET].NOLOAN = [SOURCE].[NOLOAN_FINAL]
	AND [TARGET].NOMORCIF = [SOURCE].[NOMORCIF_FINAL]
	AND [TARGET].DIVISI = [SOURCE].[DIVISI_FINAL]
WHERE [SOURCE].[PRODUK_DETAIL_SOURCE] IS NOT NULL
AND [TARGET].[PRODUK_DETAIL] IS NULL

DROP TABLE #TEMPORARY_TABLE

/*
SELECT
	[TARGET].NOLOAN AS NOLOAN_SOURCE
	,[TARGET].NOMORCIF AS NOMORCIF_SOURCE
	,[TARGET].DIVISI AS DIVISI_SOURCE
	,[TARGET].PRODUK AS PRODUK_SOURCE
	,[TARGET].PRODUK_DETAIL AS PRODUK_DETAIL_SOURCE
	,[FINAL].NOLOAN AS NOLOAN_FINAL
	,[FINAL].NOMORCIF AS NOMORCIF_FINAL
	,[FINAL].DIVISI AS DIVISI_FINAL
	,[FINAL].PRODUK AS PRODUK_FINAL
	,[FINAL].PRODUK_DETAIL AS PRODUK_DETAIL_FINAL
FROM [PORTOFOLIO.ONBS.LOAN_DETAIL] [TARGET]
LEFT JOIN [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.MAPPING.JOIN.REKAP_NOLOAN.MUTASI_NOLOAN_CURRENT] [MUTASI]
	ON COALESCE([TARGET].[NOLOAN], 'X') = COALESCE([MUTASI].[NOLOAN_CURRENT], 'X')
	AND COALESCE([TARGET].[NOMORCIF], 'X') = COALESCE([MUTASI].[NOCIF_CURRENT], 'X')
LEFT JOIN
	(
		SELECT [LEGACY], [NOLOAN], [NOMORCIF], [DIVISI], [PRODUK], [PRODUK_DETAIL] FROM [dbo].[PORTOFOLIO.ONBS.LOAN_DETAIL]
	) [FINAL]
	ON COALESCE([FINAL].[NOLOAN], 'X') = COALESCE([MUTASI].[NOLOAN_AKHIR], 'X')
	AND COALESCE([FINAL].[NOMORCIF], 'X') = COALESCE([MUTASI].[NOCIF_AKHIR], 'X')
WHERE
	[FINAL].[NOLOAN] IS NOT NULL
	AND
		(
			COALESCE([TARGET].[NOLOAN], 'X') != COALESCE([FINAL].[NOLOAN], 'X')
			OR COALESCE([TARGET].[NOMORCIF], 'X') != COALESCE([FINAL].[NOMORCIF], 'X')
		)
	AND 
		(
		[FINAL].[DIVISI] != [TARGET].[DIVISI]
		OR [FINAL].[PRODUK] != [TARGET].[PRODUK]
		OR [FINAL].[PRODUK_DETAIL] != [TARGET].[PRODUK_DETAIL]
		)
*/
