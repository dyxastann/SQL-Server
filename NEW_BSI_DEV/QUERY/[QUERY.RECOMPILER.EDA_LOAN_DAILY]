DECLARE @sql_query varchar(max) = '', @NAME varchar(max) = '', @COLUMN_NAME varchar(max) = '', @COLUMNS varchar(max) = ''
DECLARE load_cursor CURSOR FOR 
	SELECT name FROM [NEW_BSI_STORAGE].sys.objects WHERE type_desc = 'USER_TABLE' AND name LIKE ('EDA.LOAN_DAILY.____-__-__') AND REPLACE(name, 'EDA.LOAN_DAILY.', '') = EOMONTH(REPLACE(name, 'EDA.LOAN_DAILY.', '')) ORDER  BY name ASC

OPEN load_cursor
FETCH NEXT FROM load_cursor INTO @NAME

WHILE @@FETCH_STATUS = 0 
BEGIN
	SET @sql_query = CONCAT('MERGE [PORTOFOLIO.ONBS.LOAN_DETAIL] [TARGET]
USING
	(
		SELECT
			''BSM'' AS LEGACY
			,noRekening AS NOLOAN
			,noCif AS NOMORCIF
			,akad AS JENISPIUTANGPEMBIAYAAN
			,TRY_CAST(tanggalBuka AS DATE) AS TANGGAL_CAIR
			,TRY_CAST(tanggalTutup AS DATE) AS TANGGAL_JATUH_TEMPO
			,REPLACE(segmenBSI, ''CONSUMER'', ''KONSUMER'') AS DIVISI
			,namaProdukBSI AS PRODUK
			,COALESCE(subProduct1, subProduct2) AS PRODUK_DETAIL
		FROM [NEW_BSI_STORAGE].[dbo].[', @NAME, ']
		GROUP BY
			noRekening
			,noCif
			,akad
			,tanggalBuka
			,tanggalTutup
			,segmenBSI
			,namaProdukBSI
			,COALESCE(subProduct1, subProduct2)
	) [SOURCE]
	ON COALESCE([SOURCE].[NOLOAN], ''X'') = COALESCE([TARGET].[NOLOAN], ''X'')
	AND COALESCE([SOURCE].[NOMORCIF], ''X'') = COALESCE([TARGET].[NOMORCIF], ''X'')
WHEN MATCHED THEN UPDATE SET
	JENISPIUTANGPEMBIAYAAN = COALESCE([SOURCE].JENISPIUTANGPEMBIAYAAN, [TARGET].JENISPIUTANGPEMBIAYAAN)
	,TANGGAL_CAIR = COALESCE([SOURCE].TANGGAL_CAIR, [TARGET].TANGGAL_CAIR)
	,TANGGAL_JATUH_TEMPO = COALESCE([SOURCE].TANGGAL_JATUH_TEMPO, [TARGET].TANGGAL_JATUH_TEMPO)
	,DIVISI = COALESCE([SOURCE].DIVISI, [TARGET].DIVISI)
	,PRODUK = COALESCE([SOURCE].PRODUK, [TARGET].PRODUK)
	,PRODUK_DETAIL = COALESCE([SOURCE].PRODUK_DETAIL, [TARGET].PRODUK_DETAIL)
WHEN NOT MATCHED BY TARGET THEN INSERT
(
	NOLOAN
	,NOMORCIF
	,JENISPIUTANGPEMBIAYAAN
	,TANGGAL_CAIR
	,TANGGAL_JATUH_TEMPO
	,DIVISI
	,PRODUK
	,PRODUK_DETAIL
)
VALUES
(
	[SOURCE].NOLOAN
	,[SOURCE].NOMORCIF
	,[SOURCE].JENISPIUTANGPEMBIAYAAN
	,[SOURCE].TANGGAL_CAIR
	,[SOURCE].TANGGAL_JATUH_TEMPO
	,[SOURCE].DIVISI
	,[SOURCE].PRODUK
	,[SOURCE].PRODUK_DETAIL
);')
	BEGIN TRY
		EXEC(@sql_query)
		PRINT CONCAT(@NAME, ' LOAN: OK!')
	END TRY
	BEGIN CATCH
		PRINT CONCAT(@NAME, ' GENERATE LOAN: ', ERROR_MESSAGE())
	END CATCH

	SET @sql_query = CONCAT('MERGE [PORTOFOLIO.ONBS.LOAN_DETAIL] [TARGET]
USING
	(
		SELECT
			''BSM'' AS LEGACY
			,noRekening AS NOLOAN
			,noCif_Legacy AS NOMORCIF
			,akad AS JENISPIUTANGPEMBIAYAAN
			,TRY_CAST(tanggalBuka AS DATE) AS TANGGAL_CAIR
			,TRY_CAST(tanggalTutup AS DATE) AS TANGGAL_JATUH_TEMPO
			,REPLACE(segmenBSI, ''CONSUMER'', ''KONSUMER'') AS DIVISI
			,namaProdukBSI AS PRODUK
			,COALESCE(subProduct1, subProduct2) AS PRODUK_DETAIL
		FROM [NEW_BSI_STORAGE].[dbo].[', @NAME, ']
		GROUP BY
			noRekening
			,noCif_Legacy
			,akad
			,tanggalBuka
			,tanggalTutup
			,segmenBSI
			,namaProdukBSI
			,COALESCE(subProduct1, subProduct2)
	) [SOURCE]
	ON COALESCE([SOURCE].[NOLOAN], ''X'') = COALESCE([TARGET].[NOLOAN], ''X'')
	AND COALESCE([SOURCE].[NOMORCIF], ''X'') = COALESCE([TARGET].[NOMORCIF], ''X'')
WHEN MATCHED THEN UPDATE SET
	JENISPIUTANGPEMBIAYAAN = COALESCE([SOURCE].JENISPIUTANGPEMBIAYAAN, [TARGET].JENISPIUTANGPEMBIAYAAN)
	,TANGGAL_CAIR = COALESCE([SOURCE].TANGGAL_CAIR, [TARGET].TANGGAL_CAIR)
	,TANGGAL_JATUH_TEMPO = COALESCE([SOURCE].TANGGAL_JATUH_TEMPO, [TARGET].TANGGAL_JATUH_TEMPO)
	,DIVISI = COALESCE([SOURCE].DIVISI, [TARGET].DIVISI)
	,PRODUK = COALESCE([SOURCE].PRODUK, [TARGET].PRODUK)
	,PRODUK_DETAIL = COALESCE([SOURCE].PRODUK_DETAIL, [TARGET].PRODUK_DETAIL)
WHEN NOT MATCHED BY TARGET THEN INSERT
(
	NOLOAN
	,NOMORCIF
	,JENISPIUTANGPEMBIAYAAN
	,TANGGAL_CAIR
	,TANGGAL_JATUH_TEMPO
	,DIVISI
	,PRODUK
	,PRODUK_DETAIL
)
VALUES
(
	[SOURCE].NOLOAN
	,[SOURCE].NOMORCIF
	,[SOURCE].JENISPIUTANGPEMBIAYAAN
	,[SOURCE].TANGGAL_CAIR
	,[SOURCE].TANGGAL_JATUH_TEMPO
	,[SOURCE].DIVISI
	,[SOURCE].PRODUK
	,[SOURCE].PRODUK_DETAIL
);')
	BEGIN TRY
		EXEC(@sql_query)
		PRINT CONCAT(@NAME, ' LOAN: OK!')
	END TRY
	BEGIN CATCH
		PRINT CONCAT(@NAME, ' GENERATE LOAN: ', ERROR_MESSAGE())
	END CATCH

	FETCH NEXT FROM load_cursor INTO @NAME
END

CLOSE load_cursor
DEALLOCATE load_cursor; 
