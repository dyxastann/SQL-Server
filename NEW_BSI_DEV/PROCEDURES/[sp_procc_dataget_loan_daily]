CREATE PROCEDURE [dbo].[sp_procc_dataget_loan_daily]
AS
BEGIN
  -- routine body goes here, e.g.
  -- SELECT 'Navicat for SQL Server'

-----------------------------------Daily: Hasanah Card (TB)-----------------------------------
	MERGE [PORTOFOLIO.ONBS.LOAN_DETAIL] [TARGET] USING (
		SELECT
			'BNIS' AS LEGACY,
			CARDNO AS NOLOAN,
			RIGHT(CUSTNO, 15) AS NOMORCIF,
			'ID0010001' AS KODEOUTLET,
			'Hasanah Card' AS DIVISI,
			'IDR' AS CURRENCY,
			'HC001' AS LOANTYPE,
			'Qardh' AS JENISPIUTANGPEMBIAYAAN,
			'004900' AS KODESEKTOREKONOMI,
			JENIS AS PRODUK,
			TYPE AS PRODUK_DETAIL,
			MIN (TRY_CAST(OPDT AS DATE)) AS TANGGAL_CAIR
		FROM
			[NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.SOURCE.BNIS.HASANAH_CARD] [SOURCE]
		WHERE
			[SOURCE].POSTFLG IN ('PP', 'SP')
		GROUP BY
			CARDNO,
			CUSTNO,
			JENIS,
			TYPE
	) [SOURCE] ON COALESCE ([SOURCE].[NOLOAN], 'X') = COALESCE ([TARGET].[NOLOAN], 'X')
	AND COALESCE ([SOURCE].[NOMORCIF], 'X') = COALESCE ([TARGET].[NOMORCIF], 'X')
	WHEN MATCHED THEN
		UPDATE
	SET LEGACY = COALESCE (
		[SOURCE].LEGACY,
		[TARGET].LEGACY
	),
	 KODEOUTLET = COALESCE (
		[SOURCE].KODEOUTLET,
		[TARGET].KODEOUTLET
	),
	 DIVISI = COALESCE (
		[TARGET].DIVISI,
		[SOURCE].DIVISI
	),
	 CURRENCY = COALESCE (
		[SOURCE].CURRENCY,
		[TARGET].CURRENCY
	),
	 LOANTYPE = COALESCE (
		[SOURCE].LOANTYPE,
		[TARGET].LOANTYPE
	),
	 JENISPIUTANGPEMBIAYAAN = COALESCE (
		[SOURCE].JENISPIUTANGPEMBIAYAAN,
		[TARGET].JENISPIUTANGPEMBIAYAAN
	),
	 KODESEKTOREKONOMI = COALESCE (
		[SOURCE].KODESEKTOREKONOMI,
		[TARGET].KODESEKTOREKONOMI
	),
	 TANGGAL_CAIR = COALESCE (
		[SOURCE].TANGGAL_CAIR,
		[TARGET].TANGGAL_CAIR
	),
	 PRODUK = COALESCE (
		[SOURCE].PRODUK,
		[TARGET].PRODUK
	),
	 PRODUK_DETAIL = COALESCE (
		[SOURCE].PRODUK_DETAIL,
		[TARGET].PRODUK_DETAIL
	)
	WHEN NOT MATCHED BY TARGET THEN
		INSERT (
			LEGACY,
			NOLOAN,
			NOMORCIF,
			KODEOUTLET,
			DIVISI,
			CURRENCY,
			LOANTYPE,
			JENISPIUTANGPEMBIAYAAN,
			KODESEKTOREKONOMI,
			TANGGAL_CAIR,
			PRODUK,
			PRODUK_DETAIL,
			UPDATE_METHOD
		)
	VALUES
		(
			[SOURCE].LEGACY,
			[SOURCE].NOLOAN,
			[SOURCE].NOMORCIF,
			[SOURCE].KODEOUTLET,
			[SOURCE].DIVISI,
			[SOURCE].CURRENCY,
			[SOURCE].LOANTYPE,
			[SOURCE].JENISPIUTANGPEMBIAYAAN,
			[SOURCE].KODESEKTOREKONOMI,
			[SOURCE].TANGGAL_CAIR,
			[SOURCE].PRODUK,
			[SOURCE].PRODUK_DETAIL,
			'LOAN DAILY'
		)
	OUTPUT deleted.*, $action, inserted.*;

-----------------------------------Daily: IFOIS-----------------------------------
	MERGE [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.LOAN_DETAIL] [TARGET] USING (
		SELECT
			'BSM' AS LEGACY,
			NOLOAN,
			NULLIF (NOMORCIF, '') AS NOMORCIF,
			NULLIF (KODECABANGBARU, '') AS KODEOUTLET,
			[NEW_BSI_COLLECTION].dbo.fx_adjustment_divisi_bsi (
				COALESCE (
					[DIVISI].DIVISI,
					[SOURCE].[DIVISI]
				)
			) AS DIVISI,
			NULLIF (CURRENCY, '') AS CURRENCY,
			NULLIF (LOANTYPE, '') AS LOANTYPE,
			NULLIF (JENISPIUTANGPEMBIAYAAN, '') AS JENISPIUTANGPEMBIAYAAN,
			NULLIF (SEKTOREKONOMICODE, '') AS KODESEKTOREKONOMI,
			NULLIF (
				PENCAIRANPOKOKCONVERSION,
				''
			) AS PENCAIRANPOKOKCONVERSION,
			NULLIF (
				PENCAIRANMARGINCONVERSION,
				''
			) AS PENCAIRANMARGINCONVERSION,
			NULLIF (
				TRY_CAST (TGLPENCAIRAN AS DATE),
				''
			) AS TANGGAL_CAIR,
			NULLIF (
				TRY_CAST (TGLJTTEMPO AS DATE),
				''
			) AS TANGGAL_JATUH_TEMPO,
			NULLIF (JENISPENGGUNAANCODE, '') AS JENISPENGGUNAANCODE,
			NULLIF (RELATED_TRN, '') AS RELATED_TRN,
			NULLIF (LEGACY_ID, '') AS LEGACY_ID,
			NULLIF (INTEREST_RATE, '') AS INTERESTRATE,
			NULLIF (SCHEDTYPE, '') AS SCHEDTYPE,
			NULLIF (SCHD_DT, '') AS SCHD_DT,
			NULLIF (STATUS_PENCAIRAN, '') AS STATUS_PENCAIRAN,
			NULLIF (STATUS_PEMBIAYA, '') AS STATUS_PEMBIAYAA,
			NULLIF (DESC_CHG, '') AS DESC_CHG,
			NULLIF (NAPNO, '') AS NAPNO
		FROM
			[NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.SOURCE.BSM.LOAN_DAILY] [SOURCE]
		LEFT JOIN [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_JOIN.MAPPING.BSM.DIVISI] [DIVISI] ON [SOURCE].[DIVISI] = [DIVISI].SOURCE
		WHERE
			NULLIF (NOLOAN, '') IS NOT NULL
	) [SOURCE] ON [SOURCE].[NOLOAN] = [TARGET].[NOLOAN]
	AND [SOURCE].[NOMORCIF] = [TARGET].[NOMORCIF]
	WHEN MATCHED THEN
		UPDATE
	SET LEGACY = COALESCE (
		[SOURCE].LEGACY,
		[TARGET].LEGACY
	),
	 KODEOUTLET = COALESCE (
		[SOURCE].KODEOUTLET,
		[TARGET].KODEOUTLET
	),
	 DIVISI = COALESCE (
		[TARGET].DIVISI,
		[SOURCE].DIVISI
	),
	 CURRENCY = COALESCE (
		[SOURCE].CURRENCY,
		[TARGET].CURRENCY
	),
	 LOANTYPE = COALESCE (
		[SOURCE].LOANTYPE,
		[TARGET].LOANTYPE
	),
	 JENISPIUTANGPEMBIAYAAN = COALESCE (
		[SOURCE].JENISPIUTANGPEMBIAYAAN,
		[TARGET].JENISPIUTANGPEMBIAYAAN
	),
	 KODESEKTOREKONOMI = COALESCE (
		[SOURCE].KODESEKTOREKONOMI,
		[TARGET].KODESEKTOREKONOMI
	),
	 PENCAIRANPOKOKCONVERSION = COALESCE (
		[SOURCE].PENCAIRANPOKOKCONVERSION,
		[TARGET].PENCAIRANPOKOKCONVERSION
	),
	 PENCAIRANMARGINCONVERSION = COALESCE (
		[SOURCE].PENCAIRANMARGINCONVERSION,
		[TARGET].PENCAIRANMARGINCONVERSION
	),
	 TANGGAL_CAIR = COALESCE (
		[SOURCE].TANGGAL_CAIR,
		[TARGET].TANGGAL_CAIR
	),
	 TANGGAL_JATUH_TEMPO = COALESCE (
		[SOURCE].TANGGAL_JATUH_TEMPO,
		[TARGET].TANGGAL_JATUH_TEMPO
	),
	 JENISPENGGUNAANCODE = COALESCE (
		[SOURCE].JENISPENGGUNAANCODE,
		[TARGET].JENISPENGGUNAANCODE
	),
	 RELATED_TRN = COALESCE (
		[SOURCE].RELATED_TRN,
		[TARGET].RELATED_TRN
	),
	 LEGACY_ID = COALESCE (
		[SOURCE].LEGACY_ID,
		[TARGET].LEGACY_ID
	),
	 INTERESTRATE = COALESCE (
		[SOURCE].INTERESTRATE,
		[TARGET].INTERESTRATE
	),
	 SCHEDTYPE = COALESCE (
		[SOURCE].SCHEDTYPE,
		[TARGET].SCHEDTYPE
	),
	 SCHD_DT = COALESCE (
		[SOURCE].SCHD_DT,
		[TARGET].SCHD_DT
	),
	 STATUS_PENCAIRAN = COALESCE (
		[SOURCE].STATUS_PENCAIRAN,
		[TARGET].STATUS_PENCAIRAN
	),
	 STATUS_PEMBIAYAA = COALESCE (
		[SOURCE].STATUS_PEMBIAYAA,
		[TARGET].STATUS_PEMBIAYAA
	),
	 DESC_CHG = COALESCE (
		[SOURCE].DESC_CHG,
		[TARGET].DESC_CHG
	),
	 NAPNO = COALESCE (
		[SOURCE].NAPNO,
		[TARGET].NAPNO
	)
	WHEN NOT MATCHED BY TARGET THEN
		INSERT (
			LEGACY,
			NOLOAN,
			NOMORCIF,
			KODEOUTLET,
			DIVISI,
			CURRENCY,
			LOANTYPE,
			JENISPIUTANGPEMBIAYAAN,
			KODESEKTOREKONOMI,
			PENCAIRANPOKOKCONVERSION,
			PENCAIRANMARGINCONVERSION,
			TANGGAL_CAIR,
			TANGGAL_JATUH_TEMPO,
			JENISPENGGUNAANCODE,
			RELATED_TRN,
			LEGACY_ID,
			INTERESTRATE,
			SCHEDTYPE,
			SCHD_DT,
			STATUS_PENCAIRAN,
			STATUS_PEMBIAYAA,
			DESC_CHG,
			NAPNO,
			UPDATE_METHOD
		)
	VALUES
		(
			[SOURCE].LEGACY,
			[SOURCE].NOLOAN,
			[SOURCE].NOMORCIF,
			[SOURCE].KODEOUTLET,
			[SOURCE].DIVISI,
			[SOURCE].CURRENCY,
			[SOURCE].LOANTYPE,
			[SOURCE].JENISPIUTANGPEMBIAYAAN,
			[SOURCE].KODESEKTOREKONOMI,
			[SOURCE].PENCAIRANPOKOKCONVERSION,
			[SOURCE].PENCAIRANMARGINCONVERSION,
			[SOURCE].TANGGAL_CAIR,
			[SOURCE].TANGGAL_JATUH_TEMPO,
			[SOURCE].JENISPENGGUNAANCODE,
			[SOURCE].RELATED_TRN,
			[SOURCE].LEGACY_ID,
			[SOURCE].INTERESTRATE,
			[SOURCE].SCHEDTYPE,
			[SOURCE].SCHD_DT,
			[SOURCE].STATUS_PENCAIRAN,
			[SOURCE].STATUS_PEMBIAYAA,
			[SOURCE].DESC_CHG,
			[SOURCE].NAPNO,
			'LOAN DAILY'
		)
	OUTPUT deleted.*, $action, inserted.*;

-----------------------------------Daily: JFAST-----------------------------------
	MERGE [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.LOAN_DETAIL] [TARGET] USING (
		SELECT
			'BSM' AS LEGACY,
			NOLOAN,
			NULLIF (NOMORCIF, '') AS NOMORCIF,
			NULLIF (KODECABANGBARU, '') AS KODEOUTLET,
			[NEW_BSI_COLLECTION].dbo.fx_adjustment_divisi_bsi (
				COALESCE (
					[DIVISI].DIVISI,
					[SOURCE].[DIVISI]
				)
			) AS DIVISI,
			NULLIF (CURRENCY, '') AS CURRENCY,
			NULLIF (LOANTYPE, '') AS LOANTYPE,
			NULLIF (JENISPIUTANGPEMBIAYAAN, '') AS JENISPIUTANGPEMBIAYAAN,
			NULLIF (SEKTOREKONOMICODE, '') AS KODESEKTOREKONOMI,
			NULLIF (
				PENCAIRANPOKOKCONVERSION,
				''
			) AS PENCAIRANPOKOKCONVERSION,
			NULLIF (
				PENCAIRANMARGINCONVERSION,
				''
			) AS PENCAIRANMARGINCONVERSION,
			NULLIF (
				TRY_CAST (TGLPENCAIRAN AS DATE),
				''
			) AS TANGGAL_CAIR,
			NULLIF (
				TRY_CAST (TGLJTTEMPO AS DATE),
				''
			) AS TANGGAL_JATUH_TEMPO,
			NULLIF (JENISPENGGUNAANCODE, '') AS JENISPENGGUNAANCODE,
			NULLIF (RELATED_TRN, '') AS RELATED_TRN,
			NULLIF (INTEREST_RATE, '') AS INTERESTRATE,
			NULLIF (SCHEDTYPE, '') AS SCHEDTYPE,
			NULLIF (SCHD_DT, '') AS SCHD_DT,
			NULLIF (STATUS_PENCAIRAN, '') AS STATUS_PENCAIRAN,
			NULLIF (DESC_CHG, '') AS DESC_CHG,
			NULLIF (NAPNO, '') AS NAPNO
		FROM
			[NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.SOURCE.BSM.IFOS_JFAST] [SOURCE]
		LEFT JOIN [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_JOIN.MAPPING.BSM.DIVISI] [DIVISI] ON [SOURCE].[DIVISI] = [DIVISI].SOURCE
		WHERE
			NULLIF (NOLOAN, '') IS NOT NULL
	) [SOURCE] ON [SOURCE].[NOLOAN] = [TARGET].[NOLOAN]
	AND [SOURCE].[NOMORCIF] = [TARGET].[NOMORCIF]
	WHEN MATCHED THEN
		UPDATE
	SET LEGACY = COALESCE (
		[SOURCE].LEGACY,
		[TARGET].LEGACY
	),
	 KODEOUTLET = COALESCE (
		[SOURCE].KODEOUTLET,
		[TARGET].KODEOUTLET
	),
	 DIVISI = COALESCE (
		[TARGET].DIVISI,
		[SOURCE].DIVISI
	),
	 CURRENCY = COALESCE (
		[SOURCE].CURRENCY,
		[TARGET].CURRENCY
	),
	 LOANTYPE = COALESCE (
		[SOURCE].LOANTYPE,
		[TARGET].LOANTYPE
	),
	 JENISPIUTANGPEMBIAYAAN = COALESCE (
		[SOURCE].JENISPIUTANGPEMBIAYAAN,
		[TARGET].JENISPIUTANGPEMBIAYAAN
	),
	 KODESEKTOREKONOMI = COALESCE (
		[SOURCE].KODESEKTOREKONOMI,
		[TARGET].KODESEKTOREKONOMI
	),
	 PENCAIRANPOKOKCONVERSION = COALESCE (
		[SOURCE].PENCAIRANPOKOKCONVERSION,
		[TARGET].PENCAIRANPOKOKCONVERSION
	),
	 PENCAIRANMARGINCONVERSION = COALESCE (
		[SOURCE].PENCAIRANMARGINCONVERSION,
		[TARGET].PENCAIRANMARGINCONVERSION
	),
	 TANGGAL_CAIR = COALESCE (
		[SOURCE].TANGGAL_CAIR,
		[TARGET].TANGGAL_CAIR
	),
	 TANGGAL_JATUH_TEMPO = COALESCE (
		[SOURCE].TANGGAL_JATUH_TEMPO,
		[TARGET].TANGGAL_JATUH_TEMPO
	),
	 JENISPENGGUNAANCODE = COALESCE (
		[SOURCE].JENISPENGGUNAANCODE,
		[TARGET].JENISPENGGUNAANCODE
	),
	 RELATED_TRN = COALESCE (
		[SOURCE].RELATED_TRN,
		[TARGET].RELATED_TRN
	),
	 INTERESTRATE = COALESCE (
		[SOURCE].INTERESTRATE,
		[TARGET].INTERESTRATE
	),
	 SCHEDTYPE = COALESCE (
		[SOURCE].SCHEDTYPE,
		[TARGET].SCHEDTYPE
	),
	 SCHD_DT = COALESCE (
		[SOURCE].SCHD_DT,
		[TARGET].SCHD_DT
	),
	 STATUS_PENCAIRAN = COALESCE (
		[SOURCE].STATUS_PENCAIRAN,
		[TARGET].STATUS_PENCAIRAN
	),
	 DESC_CHG = COALESCE (
		[SOURCE].DESC_CHG,
		[TARGET].DESC_CHG
	),
	 NAPNO = COALESCE (
		[SOURCE].NAPNO,
		[TARGET].NAPNO
	)
	WHEN NOT MATCHED BY TARGET THEN
		INSERT (
			LEGACY,
			NOLOAN,
			NOMORCIF,
			KODEOUTLET,
			DIVISI,
			CURRENCY,
			LOANTYPE,
			JENISPIUTANGPEMBIAYAAN,
			KODESEKTOREKONOMI,
			PENCAIRANPOKOKCONVERSION,
			PENCAIRANMARGINCONVERSION,
			TANGGAL_CAIR,
			TANGGAL_JATUH_TEMPO,
			JENISPENGGUNAANCODE,
			RELATED_TRN,
			INTERESTRATE,
			SCHEDTYPE,
			SCHD_DT,
			STATUS_PENCAIRAN,
			DESC_CHG,
			NAPNO,
			UPDATE_METHOD
		)
	VALUES
		(
			[SOURCE].LEGACY,
			[SOURCE].NOLOAN,
			[SOURCE].NOMORCIF,
			[SOURCE].KODEOUTLET,
			[SOURCE].DIVISI,
			[SOURCE].CURRENCY,
			[SOURCE].LOANTYPE,
			[SOURCE].JENISPIUTANGPEMBIAYAAN,
			[SOURCE].KODESEKTOREKONOMI,
			[SOURCE].PENCAIRANPOKOKCONVERSION,
			[SOURCE].PENCAIRANMARGINCONVERSION,
			[SOURCE].TANGGAL_CAIR,
			[SOURCE].TANGGAL_JATUH_TEMPO,
			[SOURCE].JENISPENGGUNAANCODE,
			[SOURCE].RELATED_TRN,
			[SOURCE].INTERESTRATE,
			[SOURCE].SCHEDTYPE,
			[SOURCE].SCHD_DT,
			[SOURCE].STATUS_PENCAIRAN,
			[SOURCE].DESC_CHG,
			[SOURCE].NAPNO,
			'LOAN DAILY'
		)
	OUTPUT deleted.*, $action, inserted.*;

-----------------------------------Daily: EDA-----------------------------------
	MERGE [PORTOFOLIO.ONBS.LOAN_DETAIL] [TARGET] USING (
		SELECT
			'BSM' AS LEGACY,
			noRekening AS NOLOAN,
			noCif_Legacy AS NOMORCIF,
			akad AS JENISPIUTANGPEMBIAYAAN,
			TRY_CAST (tanggalBuka AS DATE) AS TANGGAL_CAIR,
			TRY_CAST (tanggalTutup AS DATE) AS TANGGAL_JATUH_TEMPO,
			REPLACE(
				segmenBSI,
				'CONSUMER',
				'KONSUMER'
			) AS DIVISI,
			namaProdukBSI AS PRODUK,
			COALESCE (subProduct1, subProduct2) AS PRODUK_DETAIL
		FROM
			[NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.SOURCE.EDA.LOAN_DAILY]
		GROUP BY
			noRekening,
			noCif_Legacy,
			akad,
			tanggalBuka,
			tanggalTutup,
			segmenBSI,
			namaProdukBSI,
			COALESCE (subProduct1, subProduct2)
	) [SOURCE] ON COALESCE ([SOURCE].[NOLOAN], 'X') = COALESCE ([TARGET].[NOLOAN], 'X')
	AND COALESCE ([SOURCE].[NOMORCIF], 'X') = COALESCE ([TARGET].[NOMORCIF], 'X')
	WHEN MATCHED THEN
		UPDATE
	SET JENISPIUTANGPEMBIAYAAN = COALESCE (
		[SOURCE].JENISPIUTANGPEMBIAYAAN,
		[TARGET].JENISPIUTANGPEMBIAYAAN
	),
	 TANGGAL_CAIR = COALESCE (
		[SOURCE].TANGGAL_CAIR,
		[TARGET].TANGGAL_CAIR
	),
	 TANGGAL_JATUH_TEMPO = COALESCE (
		[SOURCE].TANGGAL_JATUH_TEMPO,
		[TARGET].TANGGAL_JATUH_TEMPO
	),
	 DIVISI = COALESCE (
		[TARGET].DIVISI,
		[SOURCE].DIVISI
	),
	 PRODUK = COALESCE (
		[TARGET].PRODUK,
		[SOURCE].PRODUK
	),
	 PRODUK_DETAIL = COALESCE (
		[TARGET].PRODUK_DETAIL,
		[SOURCE].PRODUK_DETAIL
	)
	WHEN NOT MATCHED BY TARGET THEN
		INSERT (
			NOLOAN,
			NOMORCIF,
			JENISPIUTANGPEMBIAYAAN,
			TANGGAL_CAIR,
			TANGGAL_JATUH_TEMPO,
			DIVISI,
			PRODUK,
			PRODUK_DETAIL,
			UPDATE_METHOD
		)
	VALUES
		(
			[SOURCE].NOLOAN,
			[SOURCE].NOMORCIF,
			[SOURCE].JENISPIUTANGPEMBIAYAAN,
			[SOURCE].TANGGAL_CAIR,
			[SOURCE].TANGGAL_JATUH_TEMPO,
			[SOURCE].DIVISI,
			[SOURCE].PRODUK,
			[SOURCE].PRODUK_DETAIL,
			'LOAN DAILY'
		)
	OUTPUT deleted.*, $action, inserted.*;

-----------------------------------Final: EDA-----------------------------------
	MERGE [PORTOFOLIO.ONBS.LOAN_DETAIL] [TARGET] USING (
		SELECT
			'BSM' AS LEGACY,
			noRekening AS NOLOAN,
			noCif_Legacy AS NOMORCIF,
			akad AS JENISPIUTANGPEMBIAYAAN,
			TRY_CAST (tanggalBuka AS DATE) AS TANGGAL_CAIR,
			TRY_CAST (tanggalTutup AS DATE) AS TANGGAL_JATUH_TEMPO,
			REPLACE(
				segmenBSI,
				'CONSUMER',
				'KONSUMER'
			) AS DIVISI,
			namaProdukBSI AS PRODUK,
			COALESCE (subProduct1, subProduct2) AS PRODUK_DETAIL
		FROM
			[NEW_BSI_STORAGE].[dbo].[EDA.LOAN_DAILY.2022-07-31]
		GROUP BY
			noRekening,
			noCif_Legacy,
			akad,
			tanggalBuka,
			tanggalTutup,
			segmenBSI,
			namaProdukBSI,
			COALESCE (subProduct1, subProduct2)
	) [SOURCE] ON COALESCE ([SOURCE].[NOLOAN], 'X') = COALESCE ([TARGET].[NOLOAN], 'X')
	AND COALESCE ([SOURCE].[NOMORCIF], 'X') = COALESCE ([TARGET].[NOMORCIF], 'X')
	WHEN MATCHED THEN
		UPDATE
	SET JENISPIUTANGPEMBIAYAAN = COALESCE (
		[SOURCE].JENISPIUTANGPEMBIAYAAN,
		[TARGET].JENISPIUTANGPEMBIAYAAN
	),
	 TANGGAL_CAIR = COALESCE (
		[SOURCE].TANGGAL_CAIR,
		[TARGET].TANGGAL_CAIR
	),
	 TANGGAL_JATUH_TEMPO = COALESCE (
		[SOURCE].TANGGAL_JATUH_TEMPO,
		[TARGET].TANGGAL_JATUH_TEMPO
	),
	 DIVISI = COALESCE (
		[SOURCE].DIVISI,
		[TARGET].DIVISI
	),
	 PRODUK = COALESCE (
		[SOURCE].PRODUK,
		[TARGET].PRODUK
	),
	 PRODUK_DETAIL = COALESCE (
		[SOURCE].PRODUK_DETAIL,
		[TARGET].PRODUK_DETAIL
	),
	 UPDATE_METHOD = 'FINAL EDA'
	WHEN NOT MATCHED BY TARGET THEN
		INSERT (
			NOLOAN,
			NOMORCIF,
			JENISPIUTANGPEMBIAYAAN,
			TANGGAL_CAIR,
			TANGGAL_JATUH_TEMPO,
			DIVISI,
			PRODUK,
			PRODUK_DETAIL,
			UPDATE_METHOD
		)
	VALUES
		(
			[SOURCE].NOLOAN,
			[SOURCE].NOMORCIF,
			[SOURCE].JENISPIUTANGPEMBIAYAAN,
			[SOURCE].TANGGAL_CAIR,
			[SOURCE].TANGGAL_JATUH_TEMPO,
			[SOURCE].DIVISI,
			[SOURCE].PRODUK,
			[SOURCE].PRODUK_DETAIL,
			'FINAL EDA'
		)
	OUTPUT deleted.*, $action, inserted.*;

-----------------------------------Adjustment: Additional Cleansing-----------------------------------
	UPDATE [PORTOFOLIO.ONBS.LOAN_DETAIL]
	SET [PRODUK] = 'CICIL EMAS',
	 [PRODUK_DETAIL] = 'CICIL EMAS',
	 [UPDATE_METHOD] = 'PAWNING MURABAHAH'
	WHERE
		[DIVISI] IN ('PAWNING', 'PWG')
	AND ( LEFT ([LOANTYPE], 3) = 'MUR' OR LEFT ([JENISPIUTANGPEMBIAYAAN], 3) = 'MUR' )
	AND [PRODUK] IS NULL;

	UPDATE [PORTOFOLIO.ONBS.LOAN_DETAIL]
	SET [PRODUK] = 'GADAI EMAS',
	 [PRODUK_DETAIL] = 'GADAI EMAS',
	 [UPDATE_METHOD] = 'PAWNING RAHN'
	WHERE
		[DIVISI] IN ('PAWNING', 'PWG')
	AND ( LEFT ([LOANTYPE], 3) = 'RHN' OR [JENISPIUTANGPEMBIAYAAN] = 'Rahn' )
	AND [PRODUK] IS NULL;
END
GO
