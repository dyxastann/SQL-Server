CREATE PROCEDURE [dbo].[sp_procc_dataget_cif_daily]
AS
BEGIN
  -- routine body goes here, e.g.
  -- SELECT 'Navicat for SQL Server'

	MERGE [dbo].[PORTOFOLIO.ONBS.CIF_DETAIL] [TARGET]
	USING
	(
		SELECT
			'BNIS' AS [LEGACY]
			,RIGHT([CUSTNO], 15) AS [NOMORCIF]
			,[SHORT_NAME] AS NAMANASABAH
			,[mphone] AS NO_HP
			--,TRY_CAST([TANGGAL_LAHIR] AS DATE) AS [TANGGAL_LAHIR]
			--,[TAX_ID] AS NPWP
			--,[GENDER]
			,ROW_NUMBER() OVER (
				PARTITION BY
					CUSTNO
				ORDER BY
					[SHORT_NAME] DESC
					,[mphone] DESC
			) AS ACCT
		FROM [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.SOURCE.BNIS.HASANAH_CARD]
		GROUP BY
			[CUSTNO]
			,[SHORT_NAME]
			,[mphone]
	) [SOURCE]
		ON COALESCE([TARGET].[LEGACY], 'X') = COALESCE([SOURCE].[LEGACY], 'X')
		AND COALESCE([TARGET].[NOMORCIF], 'X') = COALESCE([SOURCE].[NOMORCIF], 'X')
		AND [SOURCE].ACCT = 1
	WHEN MATCHED AND COALESCE([TARGET].[UPDATE_METHOD], 'LOAN DAILY') = 'LOAN DAILY' THEN UPDATE SET
		NAMANASABAH = COALESCE([TARGET].NAMANASABAH, [SOURCE].NAMANASABAH)
		,[NO_HP] = COALESCE([TARGET].NO_HP, [SOURCE].NO_HP)
		,[UPDATE_METHOD] = COALESCE([TARGET].[UPDATE_METHOD], 'LOAN DAILY')
	WHEN NOT MATCHED BY TARGET THEN INSERT
	(
		[LEGACY]
		,[NOMORCIF]
		,[NAMANASABAH]
		,[NO_HP]
		,[UPDATE_METHOD]
	)
	VALUES
	(
		[SOURCE].[LEGACY]
		,[SOURCE].[NOMORCIF]
		,[SOURCE].[NAMANASABAH]
		,[SOURCE].[NO_HP]
		,'LOAN DAILY'
	)
	OUTPUT deleted.*, $action, inserted.*;

-------------------------------------------------------------------------------------------

	MERGE [dbo].[PORTOFOLIO.ONBS.CIF_DETAIL] [TARGET]
	USING
	(
		SELECT
			'BSM' AS [LEGACY]
			,[NOMORCIF]
			,[NAMALENGKAP] AS NAMANASABAH
			,[PEKERJAAN]
			,[ADDRESS] AS ALAMAT
			,[HP] AS NO_HP
			,TRY_CAST([TANGGAL_LAHIR] AS DATE) AS [TANGGAL_LAHIR]
			,[TAX_ID] AS NPWP
			,[GENDER]
			,ROW_NUMBER() OVER (
				PARTITION BY
					NOMORCIF
				ORDER BY
					[NAMALENGKAP] DESC
					,[PEKERJAAN] DESC
					,[ADDRESS] DESC
					,[HP] DESC
					,[TANGGAL_LAHIR] DESC
					,[TAX_ID] DESC
					,[GENDER] DESC
			) AS ACCT
		FROM [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.SOURCE.BSM.IFOS_JFAST]
		GROUP BY
			[NOMORCIF]
			,[NAMALENGKAP]
			,[PEKERJAAN]
			,[ADDRESS]
			,[HP]
			,[TANGGAL_LAHIR]
			,[TAX_ID]
			,[GENDER]
	) [SOURCE]
		ON COALESCE([TARGET].[LEGACY], 'X') = COALESCE([SOURCE].[LEGACY], 'X')
		AND COALESCE([TARGET].[NOMORCIF], 'X') = COALESCE([SOURCE].[NOMORCIF], 'X')
		AND [SOURCE].ACCT = 1
	WHEN MATCHED AND COALESCE([TARGET].[UPDATE_METHOD], 'LOAN DAILY') = 'LOAN DAILY' THEN UPDATE SET
		NAMANASABAH = COALESCE([TARGET].NAMANASABAH, [SOURCE].NAMANASABAH)
		,[PEKERJAAN] = COALESCE([TARGET].PEKERJAAN, [SOURCE].PEKERJAAN)
		,[ALAMAT] = COALESCE([TARGET].ALAMAT, [SOURCE].ALAMAT)
		,[NO_HP] = COALESCE([TARGET].NO_HP, [SOURCE].NO_HP)
		,[TANGGAL_LAHIR] = COALESCE([TARGET].TANGGAL_LAHIR, [SOURCE].TANGGAL_LAHIR)
		,[NPWP] = COALESCE([TARGET].NPWP, [SOURCE].NPWP)
		,[GENDER] = COALESCE([TARGET].GENDER, [SOURCE].GENDER)
		,[UPDATE_METHOD] = COALESCE([TARGET].[UPDATE_METHOD], 'LOAN DAILY')
	WHEN NOT MATCHED BY TARGET THEN INSERT
	(
		[LEGACY]
		,[NOMORCIF]
		,[NAMANASABAH]
		,[PEKERJAAN]
		,[ALAMAT]
		,[NO_HP]
		,[TANGGAL_LAHIR]
		,[NPWP]
		,[GENDER]
		,[UPDATE_METHOD]
	)
	VALUES
	(
		[SOURCE].[LEGACY]
		,[SOURCE].[NOMORCIF]
		,[SOURCE].[NAMANASABAH]
		,[SOURCE].[PEKERJAAN]
		,[SOURCE].[ALAMAT]
		,[SOURCE].[NO_HP]
		,[SOURCE].[TANGGAL_LAHIR]
		,[SOURCE].[NPWP]
		,[SOURCE].[GENDER]
		,'LOAN DAILY'
	)
	OUTPUT deleted.*, $action, inserted.*;

-------------------------------------------------------------------------------------------

	MERGE [dbo].[PORTOFOLIO.ONBS.CIF_DETAIL] [TARGET]
	USING
	(
		SELECT
			'BSM' AS [LEGACY]
			,[NOMORCIF]
			,[NAMALENGKAP] AS NAMANASABAH
			,[PEKERJAAN]
			,[ADDRESS] AS ALAMAT
			,[HP] AS NO_HP
			,TRY_CAST([TANGGAL_LAHIR] AS DATE) AS [TANGGAL_LAHIR]
			,[TAX_ID] AS NPWP
			,[GENDER]
			,ROW_NUMBER() OVER (
				PARTITION BY
					NOMORCIF
				ORDER BY
					[NAMALENGKAP] DESC
					,[PEKERJAAN] DESC
					,[ADDRESS] DESC
					,[HP] DESC
					,[TANGGAL_LAHIR] DESC
					,[TAX_ID] DESC
					,[GENDER] DESC
			) AS ACCT
		FROM [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.SOURCE.BSM.LOAN_DAILY]
		GROUP BY
			[NOMORCIF]
			,[NAMALENGKAP]
			,[PEKERJAAN]
			,[ADDRESS]
			,[HP]
			,[TANGGAL_LAHIR]
			,[TAX_ID]
			,[GENDER]
	) [SOURCE]
		ON COALESCE([TARGET].[LEGACY], 'X') = COALESCE([SOURCE].[LEGACY], 'X')
		AND COALESCE([TARGET].[NOMORCIF], 'X') = COALESCE([SOURCE].[NOMORCIF], 'X')
		AND [SOURCE].ACCT = 1
	WHEN MATCHED AND COALESCE([TARGET].[UPDATE_METHOD], 'LOAN DAILY') = 'LOAN DAILY' THEN UPDATE SET
		NAMANASABAH = COALESCE([TARGET].NAMANASABAH, [SOURCE].NAMANASABAH)
		,[PEKERJAAN] = COALESCE([TARGET].PEKERJAAN, [SOURCE].PEKERJAAN)
		,[ALAMAT] = COALESCE([TARGET].ALAMAT, [SOURCE].ALAMAT)
		,[NO_HP] = COALESCE([TARGET].NO_HP, [SOURCE].NO_HP)
		,[TANGGAL_LAHIR] = COALESCE([TARGET].TANGGAL_LAHIR, [SOURCE].TANGGAL_LAHIR)
		,[NPWP] = COALESCE([TARGET].NPWP, [SOURCE].NPWP)
		,[GENDER] = COALESCE([TARGET].GENDER, [SOURCE].GENDER)
		,[UPDATE_METHOD] = COALESCE([TARGET].[UPDATE_METHOD], 'LOAN DAILY')
	WHEN NOT MATCHED BY TARGET THEN INSERT
	(
		[LEGACY]
		,[NOMORCIF]
		,[NAMANASABAH]
		,[PEKERJAAN]
		,[ALAMAT]
		,[NO_HP]
		,[TANGGAL_LAHIR]
		,[NPWP]
		,[GENDER]
		,[UPDATE_METHOD]
	)
	VALUES
	(
		[SOURCE].[LEGACY]
		,[SOURCE].[NOMORCIF]
		,[SOURCE].[NAMANASABAH]
		,[SOURCE].[PEKERJAAN]
		,[SOURCE].[ALAMAT]
		,[SOURCE].[NO_HP]
		,[SOURCE].[TANGGAL_LAHIR]
		,[SOURCE].[NPWP]
		,[SOURCE].[GENDER]
		,'LOAN DAILY'
	)
	OUTPUT deleted.*, $action, inserted.*;
END
GO
