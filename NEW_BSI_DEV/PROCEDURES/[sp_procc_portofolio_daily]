CREATE PROCEDURE [dbo].[sp_procc_portofolio_daily]
AS
BEGIN

	DECLARE @PERIODE_DATA DATE;

------------------------------------------------------------------------------------------------------

	BEGIN TRY
		DROP TABLE [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT]
	END TRY
	BEGIN CATCH
	END CATCH

------------------------------------------------------------------------------------------------------

	EXEC NEW_BSI_COLLECTION.dbo.sp_procc_cleanse_BNIS_loan_daily;
	EXEC NEW_BSI_COLLECTION.dbo.sp_procc_cleanse_BRIS_loan_daily;
	EXEC NEW_BSI_COLLECTION.dbo.sp_procc_cleanse_BSM_loan_daily;
	EXEC NEW_BSI_COLLECTION.dbo.sp_procc_dataget_noloan_tgl_aktif;
	EXEC NEW_BSI_COLLECTION.dbo.sp_procc_dataget_mutasi_restru_daily;
	EXEC NEW_BSI_COLLECTION.dbo.sp_procc_duplicate_loan_daily;
	EXEC NEW_BSI_COLLECTION.dbo.sp_procc_datadigest_BSM_agunan_daily;
	
------------------------------------------------------------------------------------------------------

	EXEC NEW_BSI_DEV.dbo.sp_procc_dataget_loan_daily;
	EXEC NEW_BSI_DEV.dbo.sp_procc_dataget_cif_daily;
	
------------------------------------------------------------------------------------------------------

	CREATE TABLE [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT] (
		TGL_CURRENT DATE
		,LEGACY VARCHAR(10)
		,NOLOAN VARCHAR(50)
		,NOMORCIF VARCHAR(50)
		,JENISPIUTANGPEMBIAYAAN VARCHAR(50)
		,TANGGAL_JATUH_TEMPO DATE
		,DIVISI VARCHAR(50)
		,DPD INTEGER
		,KOL_LOAN VARCHAR(50)
		,KOL_CIF VARCHAR(50)
		,OS_POKOK_CURRENT DECIMAL(20, 2)
		,OS_MARGIN_CURRENT DECIMAL(20, 2)
		,RBH_CURRENT DECIMAL(20, 2)
		,PBH_CURRENT DECIMAL(20, 2)
	);

------------------------------------------------------------------------------------------------------

	MERGE [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT] [TARGET]
	USING (
			SELECT
				FILE_DATE
				,CARDNO
				,RIGHT([SOURCE].[CUSTNO], 15) AS CUSTNO
				,MAX(CASE WHEN [SOURCE].DPD = '0' THEN 0 ELSE
					(CASE WHEN RIGHT([SOURCE].FILE_DATE, 2) < CYCLE THEN RIGHT([SOURCE].FILE_DATE, 2) + DATEPART(day, EOMONTH(DATEADD(MONTH, -1, [SOURCE].FILE_DATE))) ELSE RIGHT([SOURCE].FILE_DATE, 2) END) - [SOURCE].CYCLE + COALESCE(NULLIF([SOURCE].DPD, 'XDY'), 0)
				END) AS DPD
				,MAX(CASE
					WHEN [SOURCE].GOL = 'GOL_01' THEN '1'
					WHEN [SOURCE].GOL = 'GOL_02' AND [SOURCE].BUCKET = '02_XDY' THEN '2A'
					WHEN [SOURCE].GOL = 'GOL_02' AND [SOURCE].BUCKET = '03_D30' THEN '2B'
					WHEN [SOURCE].GOL = 'GOL_02' AND [SOURCE].BUCKET = '04_D60' THEN '2C'
					WHEN [SOURCE].GOL = 'GOL_03' AND
						(CASE WHEN RIGHT([SOURCE].FILE_DATE, 2) < CYCLE THEN RIGHT([SOURCE].FILE_DATE, 2) + DATEPART(day, EOMONTH(DATEADD(MONTH, -1, [SOURCE].FILE_DATE))) ELSE RIGHT([SOURCE].FILE_DATE, 2) END) - [SOURCE].CYCLE <= 10 THEN '3A'
					WHEN [SOURCE].GOL = 'GOL_03' AND
						(CASE WHEN RIGHT([SOURCE].FILE_DATE, 2) < CYCLE THEN RIGHT([SOURCE].FILE_DATE, 2) + DATEPART(day, EOMONTH(DATEADD(MONTH, -1, [SOURCE].FILE_DATE))) ELSE RIGHT([SOURCE].FILE_DATE, 2) END) - [SOURCE].CYCLE <= 20 THEN '3B'
					WHEN [SOURCE].GOL = 'GOL_03' AND
						(CASE WHEN RIGHT([SOURCE].FILE_DATE, 2) < CYCLE THEN RIGHT([SOURCE].FILE_DATE, 2) + DATEPART(day, EOMONTH(DATEADD(MONTH, -1, [SOURCE].FILE_DATE))) ELSE RIGHT([SOURCE].FILE_DATE, 2) END) - [SOURCE].CYCLE > 20 THEN '3C'
					WHEN [SOURCE].GOL = 'GOL_04' AND [SOURCE].BUCKET = '06_120' THEN '4A'
					WHEN [SOURCE].GOL = 'GOL_04' AND
						(CASE WHEN RIGHT([SOURCE].FILE_DATE, 2) < CYCLE THEN RIGHT([SOURCE].FILE_DATE, 2) + DATEPART(day, EOMONTH(DATEADD(MONTH, -1, [SOURCE].FILE_DATE))) ELSE RIGHT([SOURCE].FILE_DATE, 2) END) - [SOURCE].CYCLE <= 15 THEN '4B'
					WHEN [SOURCE].GOL = 'GOL_04' AND
						(CASE WHEN RIGHT([SOURCE].FILE_DATE, 2) < CYCLE THEN RIGHT([SOURCE].FILE_DATE, 2) + DATEPART(day, EOMONTH(DATEADD(MONTH, -1, [SOURCE].FILE_DATE))) ELSE RIGHT([SOURCE].FILE_DATE, 2) END) - [SOURCE].CYCLE > 15 THEN '4C'
					WHEN [SOURCE].GOL = 'GOL_05' THEN '5'
					ELSE CONCAT(RIGHT([SOURCE].GOL, 1), 'A')
				END) AS KOLEKTIBILITAS
				,SUM(COALESCE(TRY_CAST([SOURCE].rtlpribal AS DECIMAL(20,2)), 0.00) + COALESCE(TRY_CAST([SOURCE].cshpribal AS DECIMAL(20,2)), 0.00)) AS OS_POKOK
				,SUM(COALESCE(TRY_CAST([SOURCE].rtlfeesvc AS DECIMAL(20,2)), 0.00) + COALESCE(TRY_CAST([SOURCE].cshfeesvc AS DECIMAL(20,2)), 0.00)) AS OS_MARGIN
			FROM [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.SOURCE.BNIS.HASANAH_CARD] [SOURCE]
			WHERE TRY_CAST([SOURCE].CURRBAL AS DECIMAL(20, 2)) > 0.00
					AND ([SOURCE].PB IN ('B', 'C', 'D', 'E', 'F', 'H', 'J', 'L', 'M', 'N', 'P', 'Q', 'T', 'U', 'W', 'Y') OR [SOURCE].PB IS NULL)
					AND [SOURCE].POSTFLG IN ('PP', 'SP')
			GROUP BY
				FILE_DATE
				,CARDNO
				,RIGHT([SOURCE].[CUSTNO], 15)
		) [SOURCE]
		ON [SOURCE].[CARDNO] = [TARGET].[NOLOAN]
		AND [SOURCE].[CUSTNO] = [TARGET].[NOMORCIF]
		AND [TARGET].[LEGACY] = 'BNIS'
	WHEN MATCHED THEN UPDATE
	SET	
		TGL_CURRENT = COALESCE(TRY_CAST([SOURCE].FILE_DATE AS DATE), [TARGET].TGL_CURRENT)
		,JENISPIUTANGPEMBIAYAAN = COALESCE('Qardh', [TARGET].JENISPIUTANGPEMBIAYAAN)
		,DPD = COALESCE([SOURCE].DPD, [TARGET].DPD)

		,KOL_LOAN = COALESCE([SOURCE].[KOLEKTIBILITAS], [TARGET].KOL_LOAN)
		,KOL_CIF = COALESCE([SOURCE].[KOLEKTIBILITAS], [TARGET].KOL_CIF)

		,OS_POKOK_CURRENT = COALESCE(NULLIF([SOURCE].[OS_POKOK], 0.00), [TARGET].OS_POKOK_CURRENT)
		,OS_MARGIN_CURRENT = COALESCE(NULLIF([SOURCE].[OS_MARGIN], 0.00), [TARGET].OS_MARGIN_CURRENT)

	WHEN NOT MATCHED BY TARGET THEN INSERT
	(
		TGL_CURRENT
		,LEGACY
		,NOLOAN
		,NOMORCIF
		,JENISPIUTANGPEMBIAYAAN
		,DIVISI
		,DPD
		,KOL_LOAN
		,KOL_CIF
		,OS_POKOK_CURRENT
		,OS_MARGIN_CURRENT
	)
	VALUES
	(
		TRY_CAST([SOURCE].FILE_DATE AS DATE)
		,'BNIS'
		,[SOURCE].CARDNO
		,RIGHT([SOURCE].[CUSTNO], 15)
		,'Qardh'
		,'Hasanah Card'
		,[SOURCE].DPD
		,[SOURCE].[KOLEKTIBILITAS]
		,[SOURCE].[KOLEKTIBILITAS]
		,[SOURCE].[OS_POKOK]
		,[SOURCE].[OS_MARGIN]
	);

------------------------------------------------------------------------------------------------------

	MERGE INTO [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT] [TARGET]
	USING [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.SOURCE.BSM.LOAN_DAILY] [SOURCE]
		ON [SOURCE].[NOLOAN] = [TARGET].[NOLOAN]
		AND [SOURCE].[NOMORCIF] = [TARGET].[NOMORCIF]
		AND [TARGET].[LEGACY] = 'BSM'
	WHEN MATCHED THEN UPDATE
	SET
		TGL_CURRENT = COALESCE([SOURCE].[FICMISDATE], [TARGET].TGL_CURRENT)
		,JENISPIUTANGPEMBIAYAAN = COALESCE([SOURCE].[JENISPIUTANGPEMBIAYAAN], [TARGET].JENISPIUTANGPEMBIAYAAN)
		,TANGGAL_JATUH_TEMPO = COALESCE([SOURCE].[TGLJTTEMPO], [TARGET].TANGGAL_JATUH_TEMPO)
		,DIVISI = COALESCE([NEW_BSI_COLLECTION].[dbo].[fx_adjustment_divisi_bsi]([SOURCE].[DIVISI]), [TARGET].DIVISI)
		,DPD = COALESCE([SOURCE].[DAYPASTDUE], [TARGET].DPD)
		,KOL_LOAN = COALESCE([SOURCE].[KOLBSM], [TARGET].KOL_LOAN)
		,KOL_CIF = COALESCE([SOURCE].[KOLCIF], [TARGET].KOL_CIF)
		,OS_POKOK_CURRENT = COALESCE([SOURCE].[OSPOKOKCONVERSION], [TARGET].OS_POKOK_CURRENT)
		,OS_MARGIN_CURRENT = COALESCE([SOURCE].[OSMARGINCONVERSION], [TARGET].OS_MARGIN_CURRENT)
		,RBH_CURRENT = COALESCE([SOURCE].[REALISASI_BAGIHASIL], [TARGET].RBH_CURRENT)
		,PBH_CURRENT = COALESCE([SOURCE].[PROYEKSI_BAGIHASIL], [TARGET].PBH_CURRENT)
	WHEN NOT MATCHED BY TARGET THEN INSERT
	(
		TGL_CURRENT
		,LEGACY
		,NOLOAN
		,NOMORCIF
		,JENISPIUTANGPEMBIAYAAN
		,TANGGAL_JATUH_TEMPO
		,DIVISI
		,DPD
		,KOL_LOAN
		,KOL_CIF
		,OS_POKOK_CURRENT
		,OS_MARGIN_CURRENT
		,RBH_CURRENT
		,PBH_CURRENT
	)
	VALUES
	(
		[SOURCE].[FICMISDATE]
		,'BSM'
		,[SOURCE].NOLOAN
		,[SOURCE].NOMORCIF
		,[SOURCE].JENISPIUTANGPEMBIAYAAN
		,[SOURCE].TGLJTTEMPO
		,[NEW_BSI_COLLECTION].[dbo].[fx_adjustment_divisi_bsi]([SOURCE].[DIVISI])
		,[SOURCE].[DAYPASTDUE]
		,[SOURCE].[KOLBSM]
		,[SOURCE].[KOLCIF]
		,[SOURCE].[OSPOKOKCONVERSION]
		,[SOURCE].[OSMARGINCONVERSION]
		,[SOURCE].[REALISASI_BAGIHASIL]
		,[SOURCE].[PROYEKSI_BAGIHASIL]
	);

------------------------------------------------------------------------------------------------------

	MERGE INTO [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT] [TARGET]
	USING
		(
			SELECT
				*
			FROM [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.SOURCE.BSM.IFOS_JFAST]
			WHERE TRY_CAST(FICMISDATE AS DATE) IS NOT NULL
		) [SOURCE]
		ON [SOURCE].[NOLOAN] = [TARGET].[NOLOAN]
		AND [SOURCE].[NOMORCIF] = [TARGET].[NOMORCIF]
		AND [TARGET].[LEGACY] = 'BSM'
	WHEN MATCHED THEN UPDATE
	SET
		TGL_CURRENT = COALESCE([SOURCE].[FICMISDATE], [TARGET].TGL_CURRENT)
		,JENISPIUTANGPEMBIAYAAN = COALESCE([SOURCE].[JENISPIUTANGPEMBIAYAAN], [TARGET].JENISPIUTANGPEMBIAYAAN)
		,TANGGAL_JATUH_TEMPO = COALESCE([SOURCE].[TGLJTTEMPO], [TARGET].TANGGAL_JATUH_TEMPO)
		,DIVISI = COALESCE([NEW_BSI_COLLECTION].[dbo].[fx_adjustment_divisi_bsi]([SOURCE].[DIVISI]), [TARGET].DIVISI)
		,DPD = COALESCE([SOURCE].[DAYPASTDUE], [TARGET].DPD)
		,KOL_LOAN = COALESCE([SOURCE].[KOLBSM], [SOURCE].[KOLCIF], [TARGET].KOL_LOAN)
		,KOL_CIF = COALESCE([SOURCE].[KOLCIF], [TARGET].KOL_CIF)
		,OS_POKOK_CURRENT = COALESCE([SOURCE].[OSPOKOKCONVERSION], [TARGET].OS_POKOK_CURRENT)
		,OS_MARGIN_CURRENT = COALESCE([SOURCE].[OSMARGINCONVERSION], [TARGET].OS_MARGIN_CURRENT)
		,RBH_CURRENT = COALESCE([SOURCE].[REALISASI_BAGIHASIL], [TARGET].RBH_CURRENT)
		,PBH_CURRENT = COALESCE([SOURCE].[PROYEKSI_BAGIHASIL], [TARGET].PBH_CURRENT)
	WHEN NOT MATCHED BY TARGET THEN INSERT
	(
		TGL_CURRENT
		,LEGACY
		,NOLOAN
		,NOMORCIF
		,JENISPIUTANGPEMBIAYAAN
		,TANGGAL_JATUH_TEMPO
		,DIVISI
		,DPD
		,KOL_LOAN
		,KOL_CIF
		,OS_POKOK_CURRENT
		,OS_MARGIN_CURRENT
		,RBH_CURRENT
		,PBH_CURRENT
	)
	VALUES
	(
		[SOURCE].[FICMISDATE]
		,'BSM'
		,[SOURCE].NOLOAN
		,[SOURCE].NOMORCIF
		,[SOURCE].JENISPIUTANGPEMBIAYAAN
		,[SOURCE].TGLJTTEMPO
		,[NEW_BSI_COLLECTION].[dbo].[fx_adjustment_divisi_bsi]([SOURCE].[DIVISI])
		,[SOURCE].[DAYPASTDUE]
		,COALESCE([SOURCE].[KOLBSM], [SOURCE].[KOLCIF])
		,[SOURCE].[KOLCIF]
		,[SOURCE].[OSPOKOKCONVERSION]
		,[SOURCE].[OSMARGINCONVERSION]
		,[SOURCE].[REALISASI_BAGIHASIL]
		,[SOURCE].[PROYEKSI_BAGIHASIL]
	);

------------------------------------------------------------------------------------------------------

	MERGE INTO [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT] [TARGET]
	USING [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.SOURCE.EDA.LOAN_DAILY] [SOURCE]
		ON [SOURCE].[noRekening] = [TARGET].[NOLOAN]
		AND RIGHT([SOURCE].[noCIF_Legacy], 15) = RIGHT([TARGET].[NOMORCIF], 15)
	WHEN MATCHED AND [SOURCE].[periodeData] >= [TARGET].[TGL_CURRENT] THEN UPDATE
	SET
		TGL_CURRENT = COALESCE([SOURCE].[periodeData], [TARGET].TGL_CURRENT)
		,JENISPIUTANGPEMBIAYAAN = COALESCE([SOURCE].[akad], [TARGET].JENISPIUTANGPEMBIAYAAN)
		,TANGGAL_JATUH_TEMPO = COALESCE([SOURCE].[tanggalTutup], [TARGET].TANGGAL_JATUH_TEMPO)
		,DIVISI = COALESCE([NEW_BSI_COLLECTION].[dbo].[fx_adjustment_divisi_bsi]([SOURCE].[kodeBU]), [TARGET].DIVISI)
		,DPD = COALESCE([SOURCE].[tunggakanHari], [TARGET].DPD)
		,KOL_LOAN = COALESCE([SOURCE].[kol_rek], [TARGET].KOL_LOAN)
		,KOL_CIF = COALESCE([SOURCE].[kolektibilitas], [TARGET].KOL_CIF)
		,OS_POKOK_CURRENT = COALESCE([SOURCE].[sisaPokok], [TARGET].OS_POKOK_CURRENT)
		,OS_MARGIN_CURRENT = COALESCE([SOURCE].[sisaMargin], [TARGET].OS_MARGIN_CURRENT)
		,RBH_CURRENT = COALESCE([SOURCE].[realisasiBagiHasil], [TARGET].RBH_CURRENT)
		,PBH_CURRENT = COALESCE([SOURCE].[proyeksiBagiHasil], [TARGET].PBH_CURRENT)
	WHEN NOT MATCHED BY TARGET THEN INSERT
	(
		TGL_CURRENT
		,LEGACY
		,NOLOAN
		,NOMORCIF
		,JENISPIUTANGPEMBIAYAAN
		,TANGGAL_JATUH_TEMPO
		,DIVISI
		,DPD
		,KOL_LOAN
		,KOL_CIF
		,OS_POKOK_CURRENT
		,OS_MARGIN_CURRENT
		,RBH_CURRENT
		,PBH_CURRENT
	)
	VALUES
	(
		[SOURCE].[periodeData]
		,CASE
			WHEN LEFT([SOURCE].noRekening, 2) IN ('30', '31', '32', '33', '40', '41', '42', '43', '50', '51', '52', '53')
				AND LEN([SOURCE].noRekening) = 14 THEN 'BNIS'
			ELSE 'BSM'
		END
		,[SOURCE].noRekening
		,[SOURCE].noCIF_Legacy
		,[SOURCE].akad
		,[SOURCE].tanggalTutup
		,[NEW_BSI_COLLECTION].[dbo].[fx_adjustment_divisi_bsi]([SOURCE].[kodeBU])
		,[SOURCE].[tunggakanHari]
		,[SOURCE].[kol_rek]
		,[SOURCE].[kolektibilitas]
		,[SOURCE].[sisaPokok]
		,[SOURCE].[sisaMargin]
		,[SOURCE].[realisasiBagiHasil]
		,[SOURCE].[proyeksiBagiHasil]
	);

------------------------------------------------------------------------------------------------------
/*
	MERGE INTO [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT] [TARGET]
	USING [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.DATABASE.BNIS.PORTOFOLIO_LAST_MONTH] [SOURCE]
		ON [SOURCE].[(SOURCE) NOLOAN_CURRENT] = [TARGET].[NOLOAN]
		AND RIGHT([SOURCE].[(SOURCE) NOMORCIF_CURRENT], 15) = [TARGET].[NOMORCIF]
		AND [TARGET].[LEGACY] = 'BNIS'
	WHEN NOT MATCHED BY TARGET THEN INSERT
	(
		LEGACY
		,NOLOAN
		,NOMORCIF
		,JENISPIUTANGPEMBIAYAAN
	)
	VALUES
	(
		'BNIS'
		,[SOURCE].[(SOURCE) NOLOAN_CURRENT]
		,RIGHT([SOURCE].[(SOURCE) NOMORCIF_CURRENT], 15)
		,[SOURCE].[(SOURCE) JENISPIUTANGPEMBIAYAAN]
	);
*/
------------------------------------------------------------------------------------------------------
/*
	MERGE INTO [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT] [TARGET]
	USING [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.DATABASE.BSM.PORTOFOLIO_LAST_MONTH] [SOURCE]
		ON [SOURCE].[(SOURCE) NOLOAN_CURRENT] = [TARGET].[NOLOAN]
		AND [SOURCE].[(SOURCE) NOMORCIF_CURRENT] = [TARGET].[NOMORCIF]
		AND [TARGET].[LEGACY] = 'BSM'
	WHEN NOT MATCHED BY TARGET THEN INSERT
	(
		LEGACY
		,NOLOAN
		,NOMORCIF
		,JENISPIUTANGPEMBIAYAAN
	)
	VALUES
	(
		'BSM'
		,[SOURCE].[(SOURCE) NOLOAN_CURRENT]
		,[SOURCE].[(SOURCE) NOMORCIF_CURRENT]
		,[SOURCE].[(SOURCE) JENISPIUTANGPEMBIAYAAN]
	);
*/
------------------------------------------------------------------------------------------------------

	SET @PERIODE_DATA = (SELECT MAX(TGL_CURRENT) FROM [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT]);

	MERGE INTO [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT] [TARGET]
	USING
		(
			SELECT
				*
			FROM [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.COMPILE.JOIN.REKAP_NOLOAN.TGL_AKTIF]
			WHERE TGL_AKTIF_AKHIR >= CONCAT(LEFT(@PERIODE_DATA, 8), '01')
			AND TGL_AKTIF_AWAL <= @PERIODE_DATA
		) [SOURCE]
		ON [SOURCE].[NOLOAN] = [TARGET].[NOLOAN]
		AND RIGHT([SOURCE].[NOMORCIF], 15) = RIGHT([TARGET].[NOMORCIF], 15)
		AND [SOURCE].[LEGACY] = [TARGET].[LEGACY]
	WHEN NOT MATCHED BY TARGET THEN INSERT
	(
		LEGACY
		,NOLOAN
		,NOMORCIF
	)
	VALUES
	(
		[SOURCE].[LEGACY]
		,[SOURCE].[NOLOAN]
		,RIGHT([SOURCE].[NOMORCIF], 15)
	);

------------------------------------------------------------------------------------------------------

	UPDATE [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT]
	SET
		[DIVISI] = COALESCE([SOURCE].[DIVISI], [SOURCE].[DIVISI])
		,[JENISPIUTANGPEMBIAYAAN] = COALESCE([SOURCE].[JENISPIUTANGPEMBIAYAAN], [SOURCE].[JENISPIUTANGPEMBIAYAAN])
	FROM [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT] [TARGET]
	LEFT JOIN [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.LOAN_DETAIL] [SOURCE]
		ON [TARGET].[NOLOAN] = [SOURCE].[NOLOAN]
		AND [TARGET].[NOMORCIF] = [SOURCE].[NOMORCIF];

------------------------------------------------------------------------------------------------------

	UPDATE [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT]
	SET
		[KOL_LOAN] = [NEW_BSI_COLLECTION].[dbo].[fx_adjustment_kol](KOL_LOAN, DPD, JENISPIUTANGPEMBIAYAAN, TANGGAL_JATUH_TEMPO, TGL_CURRENT);

------------------------------------------------------------------------------------------------------

	UPDATE [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT]
	SET
		[KOL_LOAN] = 
			CASE
				WHEN [MUTASI].NOLOAN_BARU IS NOT NULL THEN 'Suspect'
			END
		,[KOL_CIF] = 
			CASE
				WHEN [MUTASI].NOLOAN_BARU IS NOT NULL THEN 'Suspect'
			END
	FROM [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT] [SOURCE]
	LEFT JOIN [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.COMPILE.JOIN.REKAP_NOLOAN.MUTASI_NOLOAN] [MUTASI]
		ON [SOURCE].[NOLOAN] = [MUTASI].NOLOAN_LAMA
		AND [SOURCE].[LEGACY] = [MUTASI].LEGACY_LAMA
		AND [MUTASI].KETERANGAN NOT IN ('INVALID', 'NOMOR KARTU KE NOLOAN LSMK', 'EKSEKUSI WO')
	WHERE [SOURCE].KOL_LOAN IS NULL
	AND [MUTASI].NOLOAN_BARU IS NOT NULL
	AND [SOURCE].[DIVISI] != 'Hasanah Card';

------------------------------------------------------------------------------------------------------

	UPDATE [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT]
	SET
		[KOL_LOAN] = 
			CASE
				WHEN [EKSEKUSI_WO].NOLOAN_WO IS NOT NULL THEN 'WO'
			END
		,[KOL_CIF] = 
			CASE
				WHEN [EKSEKUSI_WO].NOLOAN_WO IS NOT NULL THEN 'WO'
			END
		,[OS_POKOK_CURRENT] = COALESCE([EKSEKUSI_WO].BAKI_DEBET_IDR, [SOURCE].[OS_POKOK_CURRENT])
		,[OS_MARGIN_CURRENT] = COALESCE([EKSEKUSI_WO].MARGIN_AWAL_IDR, [SOURCE].[OS_MARGIN_CURRENT])
	FROM [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT] [SOURCE]
	LEFT JOIN
		(
			SELECT
				LEGACY
				,NOLOAN
				,NOLOAN_WO
				,MIN(TGL_WO) AS TGL_WO
				,SUM(BAKI_DEBET_IDR) AS BAKI_DEBET_IDR
				,SUM(MARGIN_AWAL_IDR) AS MARGIN_AWAL_IDR
			FROM
			[NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.DATABASE.JOIN.EKSEKUSI_WO]
			GROUP BY
				LEGACY
				,NOLOAN
				,NOLOAN_WO
		)	[EKSEKUSI_WO]
		ON [SOURCE].[NOLOAN] = [EKSEKUSI_WO].NOLOAN
		AND [SOURCE].[LEGACY] = [EKSEKUSI_WO].LEGACY

	WHERE [SOURCE].KOL_LOAN IS NULL
	AND [EKSEKUSI_WO].NOLOAN IS NOT NULL
	AND [SOURCE].[DIVISI] != 'Hasanah Card';

------------------------------------------------------------------------------------------------------

	UPDATE [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT]
	SET
		[KOL_LOAN] = 
			CASE
				WHEN [EKSEKUSI_WO].NOLOAN IS NOT NULL THEN 'WO'
			END
		,[KOL_CIF] = 
			CASE
				WHEN [EKSEKUSI_WO].NOLOAN IS NOT NULL THEN 'WO'
			END
	FROM [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT] [SOURCE]
	LEFT JOIN
		(
			SELECT
				'BNIS' AS LEGACY
				,CARDNO AS NOLOAN
			FROM [NEW_BSI_COLLECTION].[dbo].[PORTOFOLIO_ONBS.SOURCE.BNIS.HASANAH_CARD] [SOURCE]
			WHERE [SOURCE].PB IN ('Z')
				AND [SOURCE].POSTFLG IN ('PP', 'SP')
			GROUP BY
				CARDNO
		)	[EKSEKUSI_WO]
		ON [SOURCE].[NOLOAN] = [EKSEKUSI_WO].NOLOAN
		
	WHERE [SOURCE].KOL_LOAN IS NULL
	AND [EKSEKUSI_WO].NOLOAN IS NOT NULL
	AND [SOURCE].[DIVISI] = 'Hasanah Card';

------------------------------------------------------------------------------------------------------

	UPDATE [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT]
	SET
		[KOL_LOAN] = 'Lunas'
		,[KOL_CIF] = 'Lunas'
	WHERE KOL_LOAN IS NULL;

------------------------------------------------------------------------------------------------------

	SELECT
		[CURRENT].NOMORCIF
		,MAX(
			[CURRENT].KOLCIF
		) AS KOLCIF
	INTO #BSM_KOL_PECAH_NON_PWG
	FROM
		(
			SELECT
				[CURRENT].NOMORCIF
				,MAX(KOL_LOAN) AS KOLCIF
			FROM
			[NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT] [CURRENT]
			WHERE [CURRENT].DIVISI NOT IN ('PAWNING', 'Hasanah Card')
			AND [CURRENT].KOL_LOAN NOT IN ('Lunas', 'Suspect', 'WO')
			GROUP BY [CURRENT].NOMORCIF
		) [CURRENT]
	GROUP BY [CURRENT].NOMORCIF;

	UPDATE [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT]
	SET
		[KOL_CIF] = COALESCE([KOL_CIF].[KOLCIF], [SOURCE].[KOL_CIF])
	FROM [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT] [SOURCE]
	LEFT JOIN #BSM_KOL_PECAH_NON_PWG [KOL_CIF]
		ON [KOL_CIF].NOMORCIF = [SOURCE].[NOMORCIF]
	WHERE [KOL_CIF].NOMORCIF IS NOT NULL
		AND [SOURCE].[DIVISI] NOT IN ('PAWNING', 'Hasanah Card')
		AND [SOURCE].[KOL_LOAN] NOT IN ('Lunas', 'Suspect', 'WO');

	DROP TABLE #BSM_KOL_PECAH_NON_PWG;

------------------------------------------------------------------------------------------------------

	UPDATE [NEW_BSI_DEV].[dbo].[PORTOFOLIO.ONBS.CURRENT]
	SET
		[KOL_CIF] = [KOL_LOAN]
	WHERE DIVISI IN ('PAWNING', 'HASANAH CARD');

  -- routine body goes here, e.g.
  -- SELECT 'Navicat for SQL Server'
END
GO
